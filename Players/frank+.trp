{
Program: Frank+

Author: Nathan Scarbrough
Email: Nathan.Scarbrough@gmail.com

Description: This program is the same as Frank except I added Vexer's kill player code so that Frank would be able to recognize when human players are weak and be able to target and destroy them.
The kill player code also helps Frank end the game more quickly and efficiently when he's winning.

Take a look at Frank.trp's description for more details.

Credit to Heitor Mansel for the original Frank

History: Version 2.0 March 2010
}

// available UBuffers, 1-5, 18, 22, 23, 31, 48, 51-100 except 52, 56, 61, 63, 73, 74, 98, 99 which are used by the kill player code

procedure CONTROL_PANEL;
  var
    T: Integer;
    KillBubble, Cooperative, TrySouthAmericaFirst, PutApart: boolean;
  
Begin
  //##################### FRANK'S CONTROL PANEL ################################
    
  KillBubble:=False; //Bubble feature when needed
  
  Cooperative:=False; 
  //No Bubble attacks if continent owner has the same program name.
  
  TrySouthAmericaFirst:=False;  //If False try Australia first

  PutApart:=True;
  //In Assignment, try not put armies in the same continent (SA and Au).

  //#############################################################################

  For T:=1 to 10 do
    if pactive(T) then if ( pos('australian', lowercase(PProgram(T))) > 0 ) and (SPlayersCount=3) then
      Begin
        TrySouthAmericaFirst:=True;
        UBufferset(32, 1);
        UBufferSet(10,-T);
    end;

  If SPlayersCount<=4 then KillBubble:=True;
  If Cooperative then UBufferSet(29, 1) else UBufferSet(29, 0);
  If KillBubble then UBufferSet(33, 1) else UBufferSet(33, 0);
  
  UBufferSet(30, 1); //First placement 
  If TrySouthAmericaFirst then UBufferSet(32,1) else UBufferset(32,0); //For placement do not put in Australia if a territory in S.A.
  UBufferSet(39, SPlayersCount);  //Set the initial number of players
  UBufferSet(25,0); //Not in Bubble mode
  UBufferSet(15, 0); //If 0 then No Messages
  If SPlayersCount>2 then UBufferSet(38, 1) else UBufferSet(38, 0);
  
  UBufferSet(14,1); //Do not run the Control Panel again
  
end; //############# END FRANK'S CONTROL PANEL ###################################

{_________________________ UMessage/Ulog/UBuffer ______________________________}

procedure m(s: string);  //
begin
  ULog('message: ' + s);  // duplicates all messages to the log
  case UDialog(s,'Continue;SnapShot;Stop;Both') of
    1: ;
    2: UTakeSnapShot(s);
    3: begin
      UAbortGame;
      exit;
    end;
    4: begin
      UTakeSnapShot(s);
      UAbortGame;
      exit;
    end;
  end;
end;


function bg(x: integer): integer;
begin result:= trunc(UBufferGet(x)); end;
                                              // use these for integer storage
procedure bs(x, y: integer);
begin UBufferSet(x, y); end;
{______________________________________________________________________________}

{---------------------------------Kill Player Code---------------------------------------------------}
                                           // by Nathan Scarbrough (adapted from Vexer.trp)
                                           // uses UBuffers 52, 56, 63, 73, 74, 98, 99


function PTC: integer; begin result:= PTerritoriesCount(PMe); end;

Function GameHasNoHumans: boolean;
var
  P: integer;
begin
  result:= true;
  for P:= 1 to 10 do begin
    if PHuman(P) and PAlive(P) then result:= false;
  end;
end;

function GameHasOneHuman(var P: integer): boolean;
Var Human, C: integer;
Begin
  C:= 0;
  For P:= 1 to 10 do begin
    If PHuman(P) and PAlive(P)then begin
      C:= C + 1;
      Human:= P;
    end;
  end;
  if C = 1 then begin
    result:= true;
    P:= Human;
  end else begin
    result:= false;
    P:= 0;
  end;
end;

procedure ArmySort(var Army: array of integer);
var
  TC, x, x1, temp, T: integer;
begin
  TC:= PTerritoriesCount(Pme);
  SetArrayLength(Army, 43);
  For T:= 1 to 42 do Army[T]:= 0;
  x:= 0;
  For T:= 1 to 42 do begin
    if TIsMine(T) then begin
      x:= x + 1;
      Army[x]:= T;
    end;
  end;
  For x:= 1 to TC - 1 do begin
    For x1:= x + 1 to TC do begin
      if TArmies(Army[x1]) > TArmies(Army[x]) then begin
        temp:= Army[x];
        Army[x]:= Army[x1];
        Army[x1]:= temp;
      end;
    end;
  end;
end;

Function BestFT(TT: integer): integer;
var
  MaxArmy, B, BT: integer;
Begin
  Result:= 0;
  MaxArmy:= 0;
  For B:= 1 to TBordersCount(TT) do begin
    BT:= TBorder(TT, B);
    if TIsMine(BT) and (TArmies(BT) > MaxArmy) then begin
      MaxArmy:= TArmies(BT);
      Result:= BT;
    end;
  end;
end;

Function TsAreConnected(P, T, T1: integer): boolean;
Var
  X, BT, C, B: integer;
  TOwnerIsPlayerP, Checked: array of boolean;
begin
  SetArrayLength(Checked, 43);
  For x:= 1 to 42 do Checked[x]:= False;
  SetArrayLength(TOwnerIsPlayerP, 43);
  For x:= 1 to 42 do TOwnerIsPlayerP[x]:= False;

  Result:= False;
  TOwnerIsPlayerP[T]:= True;
  if (  not ( TIsMine(T1) and TIsMine(T) )  ) and TIsBordering(T, T1) then Result:= True;
  Repeat
    if TOwnerIsPlayerP[T] and (not Checked[T]) then begin
      C:= 0;
      For B:= 1 to TBordersCount(T) do begin
        BT:= TBorder(T, B);
        if ( (TOwner(BT) = P) or ((TOwner(BT) <> PMe) and (P = 0)) ) and (not TOwnerIsPlayerP[BT]) then begin
          C:= C + 1;
          TOwnerIsPlayerP[BT]:= True;
          if TIsBordering(BT, T1) then begin
            Result:= True;
            exit;
          end;
        end;
      end;
      Checked[T]:= True;
      if C > 0 then T:= 0;
    end;
    T:= T + 1;
  Until (T > 42);
end;

Procedure AddConnectedTsArmies(T: integer; var CTArmies, Ts: Integer);
Var
  P, X, BT, C, B: integer;
  TOwnerIsPlayerP, Checked: array of boolean;
begin
  SetArrayLength(Checked, 43);
  For x:= 1 to 42 do Checked[x]:= False;
  SetArrayLength(TOwnerIsPlayerP, 43);
  For x:= 1 to 42 do TOwnerIsPlayerP[x]:= False;

  P:= TOwner(T);
  TOwnerIsPlayerP[T]:= True;
  CTArmies:= 0;
  Ts:= 0;
  Repeat
    if TOwnerIsPlayerP[T] and (not Checked[T]) then begin
      C:= 0;
      For B:= 1 to TBordersCount(T) do begin
        BT:= TBorder(T, B);
        if (TOwner(BT) = P) and (not TOwnerIsPlayerP[BT]) then begin
          C:= C + 1;
          TOwnerIsPlayerP[BT]:= True;
        end;
      end;
      Checked[T]:= True;
      CTArmies:= CTArmies + TArmies(T);
      Ts:= Ts + 1;
      if C > 0 then T:= 0;
    end;
    T:= T + 1;
  Until (T > 42);
end;

procedure RankSort(var Rank: array of integer);
var
  temp, APC, x, x1, P: integer;
begin
  x:= 0;
  SetArrayLength(Rank, 11);
  For P:= 1 to 10 do Rank[P]:= 0;
  For P:= 1 to 10 do begin
    if (PArmiesCount(P) > 0) then begin
      x:= x + 1;
      Rank[x]:= P;
    end;
  end;
  APC:= SAlivePlayersCount;
  For x:= 1 to APC - 1 do begin
    For x1:= x + 1 to APC do begin
      if PArmiesCount(Rank[x1]) > PArmiesCount(Rank[x]) then begin
        temp:= Rank[x];
        Rank[x]:= Rank[x1];
        Rank[x1]:= temp;
      end;
    end;
  end;
end;

Procedure KillPAttack(P, FT: integer; var TT: integer);
Var
  Distance1, Distance2, C1, tempTT, Total2, ST, B1, Total, X, BT, C, B, T: integer;
  TOwnerIsPlayerP, Checked: array of boolean;
begin

  SetArrayLength(Checked, 43);
  SetArrayLength(TOwnerIsPlayerP, 43);

  TT:= 0;
  For B1:= 1 to TBordersCount(FT) do begin

    For x:= 1 to 42 do Checked[x]:= False;
    For x:= 1 to 42 do TOwnerIsPlayerP[x]:= False;

    T:= TBorder(FT, B1);
    if (Not ((TArmies(FT) < 4) and (TArmies(T) > 1))) then begin
      if (  (TOwner(T) = P) or ( (P = 0) and (TOwner(T) <> PMe) )  ) then begin
        C:= 0;
        For B:= 1 to TBordersCount(T) do
         if (  (TOwner(TBorder(T, B)) = P) or ( (P = 0) and (TOwner(TBorder(T, B)) <> PMe) )  )
          then C:= C + 1;
        if (C = 0) and (TArmies(FT) > TArmies(T)) then begin
          TT:= T;
          exit;
        end;

        tempTT:= T;
        TOwnerIsPlayerP[T]:= True;
        Total:= 0;
        Repeat
          if TOwnerIsPlayerP[T] and (not Checked[T]) then begin
            C:= 0;
            For B:= 1 to TBordersCount(T) do begin
              BT:= TBorder(T, B);
              if (  (TOwner(BT) = P) or ( (P = 0) and (TOwner(BT) <> PMe) )  )
               and (not TOwnerIsPlayerP[BT]) then begin
                C:= C + 1;
                TOwnerIsPlayerP[BT]:= True;
              end;
            end;
            Checked[T]:= True;
            Total:= Total + 1;
            ST:= T;
            if C > 0 then T:= 0;
          end;
          T:= T + 1;
        Until (T > 42);

        For x:= 1 to 42 do Checked[x]:= False;
        For x:= 1 to 42 do TOwnerIsPlayerP[x]:= False;

        T:= ST;
        TOwnerIsPlayerP[T]:= True;
        Total2:= 0;
        Repeat
          if TOwnerIsPlayerP[T] and (not Checked[T]) then begin
            C:= 0;
            For B:= 1 to TBordersCount(T) do begin
              BT:= TBorder(T, B);
              if (  (TOwner(BT) = P) or ( (P = 0) and (TOwner(BT) <> PMe) )  )
               and (not TOwnerIsPlayerP[BT]) and (not (BT = tempTT)) then begin
                C:= C + 1;
                TOwnerIsPlayerP[BT]:= True;
              end;
            end;
            Checked[T]:= True;
            Total2:= Total2 + 1;
            if C > 0 then T:= 0;
          end;
          T:= T + 1;
        Until (T > 42);

        if Total2 = Total - 1 then begin
          if TT = 0 then TT:= TempTT else begin
            C:= 0; C1:= 0;
            For B:= 1 to TBordersCount(TT) do
             if (TOwner(TBorder(TT, B)) = P) or ( (P = 0) and (TOwner(TBorder(TT, B)) <> PMe) ) then C:= C + 1;
            For B:= 1 to TBordersCount(TempTT) do
             if (TOwner(TBorder(TempTT, B)) = P) or ( (P = 0) and (TOwner(TBorder(TempTT, B)) <> PMe) ) then C1:= C1 + 1;
            if C1 < C then TT:= TempTT;
            If (C = 1) and (C1 = 1) and TIsBordering(TT, TempTT) then begin
              Distance1:= 0;
              Distance2:= 0;
              For T:= 1 to 42 do begin
                if (TOwner(T) <> Pme) and (not ((T = TT) or (T = TempTT)) ) then begin
                  if (TDistance(T, TT) < Distance1) or (Distance1 = 0) then Distance1:= TDistance(T, TT);
                  if (TDistance(T, TempTT) < Distance2) or (Distance2 = 0) then Distance2:= TDistance(T, TempTT);
                end;
              end;
              if Distance2 > Distance1 then TT:= TempTT;
            end;
          end;
        end;
      end;
    end;
  end;
end;

procedure KillPlayer_Placement(var ToTerritory: integer);
var
  BFT, Priority, aMinCost, P, WP, Extra2, Extra, BT1, Total, B, BT, Y, CTArmies, Ts,
  MyArmies, TT, PL, EA, Cost, T, minPressure, x: integer;

  MinCost, Rank, Army: array of integer;
  HasEnough: array of boolean;
  pathexists, go: boolean;
begin
  setarraylength(HasEnough, 43);
  setarraylength(MinCost, 43);

  ToTerritory:=0;
  ArmySort(Army);
  RankSort(Rank);

  if Rank[SAlivePlayersCount] <> PMe then WP:= Rank[SAlivePlayersCount] else WP:=0;
  if GameHasOneHuman(P) then WP:= P;
  bs(63, WP);


  if (bg(52) > 0) and (bg(56) > 0) then ToTerritory:= bg(52) else begin
    if SAlivePlayersCount > 2 then begin
      MyArmies:= 0;
      // need to take into account two non adjoining ts
      For T:= 1 to 42 do begin
        if (TOwner(T) = WP) and (TFrontsCount(T) = 0) then begin // Enemy T is surrounded by me
          For B:= 1 to TBordersCount(T) do begin
            BT:= TBorder(T, B);
            MyArmies:= MyArmies + TArmies(BT) - 1;
          end;
          BFT:= BestFT(T);
          if MyArmies < TPressure(BFT) + TFrontsCount(BFT) + 3 then begin
            ToTerritory:= BFT;
            exit;
          end;
        end;
      end;

      aMinCost:= 999999999;
      Priority:= 0;
      For x:= 1 to PTC do begin
        MinCost[Army[x]]:= 999999999;
        For T:= 1 to 42 do begin
         if TOwner(T) = WP then begin
           Cost:= 0;
           PathExists:= False;
           if TWeakestPath(Army[x], T, TT, PL, EA) then begin
             PathExists:= True;
             Cost:= PL + EA - TArmies(Army[x]);
             if (Cost < MinCost[Army[x]]) then MinCost[Army[x]]:= Cost;
           end;
         end;
        end;
        if PathExists then begin
          if MinCost[Army[x]] < aMinCost then begin
            aMinCost:= MinCost[Army[x]];
            Priority:= x;
          end;
        end;
      end;
      if priority > 0 then begin
        Cost:= aMinCost + TArmies(Army[Priority]);
        if TArmies(Army[Priority]) < Cost + PArmiesCount(WP) + PTerritoriesCount(WP) then begin
          ToTerritory:= Army[Priority];
          exit;
        end;
      end;
    end;

    bs(52, 0);
    Extra2:= bg(56);
    for x:= 1 to 42 do HasEnough[x]:= False;
    Repeat
      for Y:= 1 to PTC do begin
        If TIsFront(Army[y]) then begin
          Total:= 0;
          go:= True;
          if Y > 1 then for x:= Y-1 downto 1 do
           if HasEnough[Army[x]] then if TsAreConnected(0, Army[y], Army[x]) then go:= False;
          if go then begin
            Total:= 0;
            For B:= 1 to TFrontsCount(Army[y]) do begin
              BT:= TFront(Army[y], B);
              go:= True;
              if B > 1 then for x:= B-1 downto 1 do begin
                BT1:= TFront(Army[y], x);
                if TsAreConnected(0, BT, BT1) then go:= False;
              end;
              If go then begin
                AddConnectedTsArmies(BT, CTArmies, Ts);
                Total:= Total + CTArmies + Ts;
              end;
            end;
            Extra:= Ts div 3;
            if Extra < 2 then Extra:= 2;
            if TArmies(Army[y]) < Total + Extra + Extra2 then begin
              If ToTerritory = 0 then begin
                ToTerritory:= Army[y];
                minPressure:= TPressure(Army[y]);
              end else begin
                if (TPressure(Army[y]) < minPressure) then begin
                  minPressure:= TPressure(Army[y]);
                  ToTerritory:= Army[y];
                end;
              end;
            end else HasEnough[Army[y]]:= True;
          end;
        end;
      end;
      If ToTerritory = 0 then begin
        Extra2:= Extra2 + 4;
        bs(56, Extra2);
      end;
    Until ToTerritory > 0;
  end;

  if Extra2 >= 12 then bs(52, ToTerritory);
  if PNewArmies(PMe) = 1 then begin
    bs(52, 0);
    bs(56, 0);
  end;
end;

procedure KillPlayer_Attack(var FromTerritory, ToTerritory: integer);
var
  loop, WP, P, B, BT, PL, x, Cost, TT, EA,
  MaxCost, C, Armies, Y, MinCost, MinDiff: integer;

  Rank, Army: Array of integer;

begin
  // the occupation routine sometimes determines where the next attack should be and stores it in buffer 73
  if (bg(73) > 0) and (TArmies(bg(73)) > 1) then begin
    FromTerritory:= bg(73);
    KillPAttack(bg(74), FromTerritory, ToTerritory);
    if ToTerritory > 0 then exit else begin
      FromTerritory:= 0;
      bs(73, 0);
    end;
  end;

  RankSort(Rank);
  ArmySort(Army);
  if Rank[SAlivePlayersCount] <> PMe then WP:= Rank[SAlivePlayersCount] else WP:=0;
  if GameHasOneHuman(P) then WP:= P;
  bs(63, WP);
  MinCost:= 0;
  MaxCost:= PArmiesCount(PMe) div 2;

  loop:= 0;
  Repeat
  For y:= 1 to PTC do begin
    if TIsFront(Army[y]) and (TArmies(Army[y]) > 1) then begin
      C:= 0;
      For B:= 1 to TBordersCount(Army[y]) do begin
        BT:= TBorder(Army[y], B);
        If (TOwner(BT) = WP) or ( (WP = 0) and (not TIsMine(BT)) ) then begin
          C:= C + 1;
          If C = 1 then TT:= BT else TT:= 0;
        end;
      end;
      If C = 1 then begin
        if (  not ( (TArmies(TT) > 1) and (TArmies(BestFT(TT)) < 4) )  ) then begin
          ToTerritory:= TT;
          FromTerritory:= BestFT(ToTerritory);
          exit;
        end;
      end else if c > 1 then begin
        KillPAttack(WP, Army[y], TT);
        If TT > 0 then begin
          ToTerritory:= TT;
          FromTerritory:= Army[y];
          exit;
        end;
      end;
      If C > 1 then begin
        MinDiff:= 0;
        For B:= 1 to TBordersCount(Army[y]) do begin
          BT:= TBorder(Army[y], B);
          If (TOwner(BT) = WP) or ( (WP = 0) and (not TIsMine(BT)) )
           and (not ( (TArmies(BT) > 1) and (TArmies(BestFT(BT)) < 4) )) then begin
            if (trunc(abs(Army[y] - BT)) < MinDiff) or (MinDiff = 0) then begin
              MinDiff:= trunc(abs(Army[y] - BT));
              ToTerritory:= BT;
              FromTerritory:= BestFT(ToTerritory);
            end;
          end;
        end;
      end;
    end;

    if FromTerritory = 0 then begin
      For x:= 1 to 42 do begin
        IF TOwner(x) = WP then begin
          If TWeakestPath(Army[y], x, TT, PL, EA) then begin
            Armies:= TArmies(Army[y]);
            Cost:= EA + PL;
            if ( (Cost < MinCost) or (MinCost = 0) ) and (Armies > TArmies(TT))
             and (Armies > 3) and (Cost < MaxCost) then begin
              MinCost:= Cost;
              ToTerritory:= TT;
              FromTerritory:= BestFT(ToTerritory);
            end;
          end;
        end;
      end;
    end;

  end;
  loop:= loop + 1;
  if (ToTerritory = 0) and (bg(99) > 0) then WP:= 0;
  Until (ToTerritory > 0) or (loop > 1);
end;

procedure KillPlayer_Occupation(FromTerritory, ToTerritory: integer; var Armies: integer);
var
  c, TTtotal, FTtotal, T, P, BothTotal, FTA: integer;
  TsConnTT, TsConnFT, TsConnBoth: boolean;
  Army: array of integer;
begin
  bs(73, 0);
  P:= 0;
  FTA:= TArmies(FromTerritory) - 1;
  Armies:=FTA;  // Default is to occupy all
  ArmySort(Army);

  TTtotal:= 0;
  FTtotal:= 0;
  BothTotal:= 0;
  For T:= 1 to 42 do begin
    if ( ((P = 0) and (TOwner(T) <> PMe)) or (TOwner(T) = P) ) then begin
      TsConnTT:= TsAreConnected(P, T, ToTerritory);
      TsConnFT:= TsAreConnected(P, T, FromTerritory);
      if TsConnTT and TsConnFT then TsConnBoth:= True else TsConnBoth:= False;
      if TsConnBoth then BothTotal:= BothTotal + TArmies(T) + 1;
      if TsConnTT and (not TsConnFT) then TTtotal:= TTtotal + TArmies(T) + 1;
      if TsConnFT and (not TsConnTT) then FTtotal:= FTtotal + TArmies(T) + 1;
    end;
  end;
  TTtotal:= TTtotal + 1;  // make sure TTtotal has enough so add an extra army
  if TTtotal > FTA then Armies:= FTA;
  if (TTtotal < FTA) and (FTtotal >= FTA-TTtotal) then Armies:= TTtotal;
  if (TTtotal < FTA) and (FTtotal < FTA-TTtotal) then Armies:= FTA - FTtotal;
  if (TTtotal = 0) and (FTtotal = 0) then Armies:= FTA;
  if (TTtotal = 0) and (FTtotal <> 0) then Armies:= 0;
  if (TTtotal = 0) and (FTtotal <> 0) and (BothTotal <> 0) then begin
    if (FTtotal < BothTotal) then Armies:= FTA - FTtotal;
    if (FTtotal > BothTotal) then Armies:= BothTotal;
    if Armies > FTA then Armies:= FTA;
    bs(73, ToTerritory);
    bs(74, P);
  end;
  if (FromTerritory = 31) and (ToTerritory = 39) then begin
    c:= 0;
    For T:= 40 to 42 do if (TOwner(T) <> PMe) then c:= c + TArmies(T) + 2;
    Armies:= c;
    if Armies > FTA then Armies:= FTA;
  end;
end;

procedure KillPlayer_Fortification(var FromTerritory, ToTerritory, Armies: integer);
Var
  FT, P, WP, aMinPL, B, BT, Cost, TT, PL, EA, aMinCost, x, MaxArmy, T: integer;
  Rank, MinPL, TTa, MinCost, Army: array of integer;

begin
  FromTerritory:= 0;
  ToTerritory:= 0;
  ArmySort(Army);
  RankSort(Rank);
  SetArrayLength(MinCost, 43);
  SetArrayLength(MinPL, 43);
  SetArrayLength(TTa, 43);

  if Rank[SAlivePlayersCount] <> PMe then WP:= Rank[SAlivePlayersCount] else WP:=0;
  if GameHasOneHuman(P) then WP:= P;

  For x:= 1 to PTC do begin
    MinCost[Army[x]]:= 0;
    MinPL[x]:= 0;
    TTa[x]:= 0;
    For T:= 1 to 42 do begin
     if TOwner(T) = WP then begin
       Cost:= 0;
       if TWeakestPath(Army[x], T, TT, PL, EA) then begin
         Cost:= PL + EA - TArmies(T);
         if (Cost < MinCost[Army[x]]) or (MinCost[Army[x]] = 0) then MinCost[Army[x]]:= Cost;
       end;
       if (not TIsFront(Army[x])) and (TArmies(Army[x]) > 3) then begin
         TShortestPath(Army[x], T, TT, PL);
         if (PL < MinPL[x]) or (MinPL[x] = 0) then begin
           MinPL[x]:= PL;
           TTa[x]:= TT;
         end;
       end;
     end;
    end;
  end;

  if SAlivePlayersCount > 2 then begin
    aMinCost:= 0;
    For x:= PTC downto 1 do begin
      if TArmies(Army[x]) > 1 then begin
        For B:= 1 to TBordersCount(Army[x]) do begin
          BT:= TBorder(Army[x], B);
          if TIsMine(BT) then begin
            if MinCost[BT] > 0 then begin
              if ( (MinCost[BT] < MinCost[Army[x]]) or (MinCost[Army[x]] = 0) ) and ((MinCost[BT] <= aMinCost) or (AMinCost = 0)) then begin
                if (  (MinCost[BT] = aMinCost) and ( (TArmies(BT) > TArmies(ToTerritory)) or (TArmies(Army[x]) > TArmies(FromTerritory)) )  ) or (MinCost[BT] <> aMinCost) then begin
                  aMinCost:= MinCost[BT];
                  FromTerritory:= Army[x];
                  ToTerritory:= BT;
                  Armies:= TArmies(FromTerritory) - 1;
                end;
              end;
            end;
          end;
        end;
      end;
    end;
  end;

  if FromTerritory = 0 then begin
    aMinPL:= 0;
    For x:= 1 to PTC do begin
      if ( (MinPL[x] <= aMinPL) or (aMinPL = 0) ) and (MinPL[x] > 0) then begin
        if (  (MinPL[x] = aMinPL) and ( (TArmies(TTa[x]) > TArmies(ToTerritory)) or (TArmies(Army[x]) > TArmies(FromTerritory)) )  ) or (MinPL[x] <> aMinPL) then begin
          aMinPL:= MinPL[x];
          FromTerritory:= Army[x];
          ToTerritory:= TTa[x];
          Armies:= TArmies(FromTerritory) - 1;
        end;
      end;
    end;
  end;

  if (FromTerritory = 0) or (bg(63) = 0) then begin
    MaxArmy:= 1;
    For T:= 1 to 42 do begin
      if TIsMine(T) and (not TIsFront(T)) then begin
        if (TArmies(T) > MaxArmy) then begin
          MaxArmy:= TArmies(T);
          FT:= T;
          Armies:= TArmies(FromTerritory) - 1;
        end;
      end;
    end;
    if (FT > 0) and (not (FT = FromTerritory)) then begin // if it's the same FT that the previous code determined, don't change the ToTerritory
      if not (  (FromTerritory > 0) and ( (TArmies(FT) < 4) and (TArmies(FromTerritory) > 3) )  ) then begin
        FromTerritory:= FT;      // might not be neccessary to do the following > 0 check
        if TPathToFront(FromTerritory) > 0 then ToTerritory:= TPathToFront(FromTerritory) else FromTerritory:= 0;
        Armies:= TArmies(FromTerritory) - 1;
      end;
    end;
  end;

end;

{-------------------------------------End Kill Player Code---------------------------------}

Function EvalT(T: integer; TrySouthAmericaFirst: boolean): double;
  var
   FreeT, Points: double; 
   C,CT,PT,PA,ET,EA,LP,LT,LA: integer;
   Bypass: boolean;
Begin

//Optimize reinforce
  Bypass:=False;
  Points:=0;
  C:=TContinent(T);
  CT:=CTerritoriesCount(C);
  CAnalysis(C,PT,PA,ET,EA);
  CLeader(C,LP,LT,LA);
  FreeT:=CT-PT-ET;
  // the leader of the continent it's not me and owns all territories less one
  if LP>0 then begin
    if (LP<>PMe) and (LT>=CT-1) then 
    begin
      Points:=Points+100.0;    // I must avoid enemy conquers the continent
      If (NOT ((C=6) and TrySouthAmericaFirst)) or (SPlayersCount<4) then Bypass:=True; 
    end;
  end;
  // evaluate my chances to conquer the continent
  Points:=Points+1.0*(PT+1+FreeT/SPlayersCount)/(ET+FreeT*SPlayersCount/(SplayersCount-1));
  result:=Points;
end;



//## from weapon.txt
function TPStrongestBorder(TXX, PXX: integer; var PTXX, PAXX: integer): boolean;
var
 AXX,
 BXX,
 IXX: integer;
begin
  if (TXX < 1) or (TXX > 42) or (PXX < 1) or (PXX > 10) then 
    result :=false
  else begin
    result :=true;
    PTXX :=0;
    PAXX :=0;
    for IXX :=1 to TBordersCount(TXX) do begin
      BXX :=TBorder(TXX, IXX);
      if TOwner(BXX)=PXX then begin
        AXX :=TArmies(BXX); 
        if AXX >= PAXX then begin
          PTXX :=BXX;
          PAXX :=AXX;
        end;
      end;
    end;
  end;
end;



function TargetCplacement(Small: integer): integer;
var
  T, C, BestC, Diff, BestDiff: integer;
  PT, PA, ET, EA, X : integer;

begin
  // LOCAL FUNCTION TARGETCplacement:  determines the target continent to attack
  // best ratio of armies in the continent and its borders
  BestDiff:=SMALL;
  for C:=1 to 6 do
    begin
      PT:=0;
      PA:=0;
      ET:=0;
      EA:=0;
      CAnalysis(C, PT, PA, ET, EA);
      if (ET>0) then
        begin
          // sub CBORDERANALYSIS:  adjust PT, PA, ET, and EA to reflect
          // territories that border the given continent
          for X:=1 to CBordersCount(C) do
            begin
              T:=Cborder(C,X);
              if TIsMine(T) then
                begin
                  PT:=PT+1;
                  PA:=PA+TArmies(T);
                end
              else
                begin
                  ET:=ET+1;
                  EA:=EA+TArmies(T);
                end;
            end;
        end;
      Diff:=PA-ET-EA;
      if (ET>0) and (PT>0) and (Diff>BestDiff) then
        begin
          BestDiff:=Diff;
          BestC:=C;
        end;
//      //If UBufferGet(15) then //umessage(BestC);      //If UBufferGet(15) then //umessage(BestDiff);
    end;
  result:=BestC;
end;



function MyTPressure(T, MaxFronts: integer): integer;
var
  Pressure, MyB, MyT: integer;
begin
  // LOCAL FUNCTION MYTPressure:  returns available armies bordering on [enemy?] territory T
  // my territories must have at most MaxFronts fronts in order to count its armies
  Pressure:=0;
  for MyB:=1 to TBordersCount(T) do
    begin
      MyT:=TBorder(T,MyB);
      if TIsMine(MyT) and (TFrontsCount(MyT)<=MaxFronts) then
        Pressure:=Pressure+TArmies(MyT);
    end;
  result:=Pressure;
end;



function TargetTplacement(EnemyC, Small, Allfronts, onefronts: integer; force: double): integer;
var
  T, T2, BestT, Diff, BestDiff: integer;
  ET, EA, X, Y : integer;

begin
  // LOCAL FUNCTION TARGETTplacement:  determines the target territory to attack
  // will return a territory on another continent if no attacks are available
  // on the desired continent {can also return 0 if no feasible attack is available at all}
  // uses local global ENEMYC
  BestDiff:=SMALL;
  BestT:=0;
  for X:=1 to CTerritoriesCount(EnemyC) do
    begin
      T:=CTerritory(EnemyC,X);
//      //If UBufferGet(15) then //umessage('Checking out territory #',X,' of target continent ',ENEMYC);
      Y:=MyTPressure(T,ALLFRONTS);
//      //If UBufferGet(15) then //umessage('Looking at territory ',T,' which you have ',Y,' total pressure on');
      if (Y>0) and ((trunc(FORCE*TArmies(T)))<(PNewArmies(PMe)+Y)) and (not TIsMine(T)) then
        begin
          // if its an enemy territory that can be conquered, then compute
          // your 1-front armies (+) less attacked armies (-) less new exposure to enemies (-)
          Diff:=MyTPressure(T,ONEFRONTS)-TArmies(T);
//          //If UBufferGet(15) then //umessage('Initial Diff (1-front armies less attacked) is ',Diff);
          for Y:=1 to TBordersCount(T) do
            begin
              T2:=TBorder(T,Y);
//              //If UBufferGet(15) then //umessage('Secondary loop, looking at territory #',Y,' (namely ',T2,') with my pressure of ',MyTPressure(T2,ALLFRONTS),' and armies ',TArmies(T2));
              if (MyTPressure(T2,ALLFRONTS)=0) and (not(TIsMine(T2))) then
                Diff:=Diff-TArmies(T2);
              // new exposure when territory is conquered
            end;
//          //If UBufferGet(15) then //umessage('A conquerable territory on target continent ',EnemyC,' is ',T);
//          //If UBufferGet(15) then //umessage('my [wasted] 1-front armies less attacked armies less new exposures is ',Diff);
          if (Diff>BestDiff) then
            begin
               BestDiff:=Diff;
               BestT:=T;
            end;
        end;
    end;
  if (BestT=0) then
    begin
      // look for easiest territory that can be taken [may be on another continent]
      for T:=1 to 42 do
        begin
          if TIsMine(T) then
            begin
              TWeakestFront(T,ET,EA);
              Diff:=TArmies(T)-EA;
              if (Diff>BestDiff) then
                begin
                  BestDiff:=Diff;
                  BestT:=ET;
                end;
            end;
        end;
//      TWeakestFront(BestT,ET,EA);
//      Diff:=PNewArmies(PMe)*NEWRATIO; // allow only a %-age of new armies to go for this attack
//      Diff:=Diff+TArmies(BestT)-EA*FORCE;
//      if Diff<1 then BestT:=0;
    end;
  result:=BestT;
end;



//####STRUGGLER FUNCT
    // Evaluation function for the pair "territory from"-"territory to" (TF-TT).
  // It return a value > 1 for strategic attacks
function Eval(TF,TT: integer): double;
    var
    Points: double;   // value assigned to the FROM/TO pair
    CF,CT,            // FROM and TO continents
    AF,AT,            // armies on FROM and TO teritories
    PT,PA,            // my territories and armies on FROM continent
    ET,EA,            // enemy territories and armies on FROM continent
    LP,               // leader player on FROM continent
    LT,LA: integer;   // leader's territories and armies on FROM continent
    
  begin
    Points:=0;
    CF:=TContinent(TF);
    CT:=TContinent(TT);
    AF:=TArmies(TF);
    AT:=TArmies(TT);
    // FROM and TO territories are on different continents
    if CF<>CT then begin
      // enemy owns the TO continent
      if COwner(CT)>0 then begin
        Points:=Points+2.0;
      end;
    end
    // FROM and TO territories are on the same continent
    else begin
      CAnalysis(CF,PT,PA,ET,EA);
      CLeader(CF,LP,LT,LA);
      // evaluate my chances to conquer the continent
      Points:=Points+1.0*(PA+1)/(EA+ET);
    end;
    // if enemy owns just one territory, I try to kill him to get his cards
    if PTerritoriesCount(TOwner(TF))<2 then begin
      Points:=Points+20.0;
    end;
    // if haven't conquered a territory, add some points for
    // a generic evaluation of the attack ratio
    if not SConquest then begin
      Points:=Points+1.0*AF/AT;
    end;
    result:=Points;
  end;
  //####STRUGGLER END FUNCT



//###Wyrm

function TargetCattack(Small: integer): integer;
var
  T, C, BestC, Diff, BestDiff: integer;
  PT, PA, ET, EA, X, Y: integer;

begin
  // LOCAL FUNCTION TARGETCattack:  determines the target continent to attack
  // best ratio of armies in the continent and its borders

  BestDiff:=0; // will hold maximum number of armies controlled by leading player Y
  for X:=1 to 10 do
    if (PActive(X)) and (X<>PMe) then
      if (PArmiesCount(X)>BestDiff) then
        begin
          BestDiff:=PArmiesCount(X);
          Y:=X; // Y holds the leading player's number
        end;

  BestDiff:=SMALL;
  for C:=1 to 6 do
    begin
      PT:=0;
      PA:=0;
      ET:=0;
      EA:=0;
      CAnalysis(C, PT, PA, ET, EA);
      if (ET>0) then
        begin
          // sub CBORDERANALYSIS:  adjust PT, PA, ET, and EA to reflect
          // territories that border the given continent
          for X:=1 to CBordersCount(C) do
            begin
              T:=Cborder(C,X);
              if TIsMine(T) then
                begin
                  PT:=PT+1;
                  PA:=PA+TArmies(T);
                end
              else
                begin
                  ET:=ET+1;
                  EA:=EA+TArmies(T);
                end;
            end;
        end;
      Diff:=PA-ET-EA;

      if (COwner(C)=Y) and SConquest and (PT>0) then // attack the leading player's continents
        begin
          Diff:=Diff+500;
//          //If UBufferGet(15) then //umessage(PName(PMe),' is favoring an extra attack on ',PName(Y),', in continent # ',C,', because they are the leader');
        end;

      if (COwner(C)>0) and (COwner(C)<>PMe) and SConquest and (PT>0) then
//        if (PArmiesCount(COwner(C))>PArmiesCount(PMe)) then
          Diff:=Diff+500;
// actually, just attack that other continent anyway, no matter what
      // also attack an opponent's continent if they are about to run over you themselves

      if (ET>0) and (PT>0) and (Diff>BestDiff) then
        begin
          BestDiff:=Diff;
          BestC:=C;
        end;
//        //If UBufferGet(15) then //umessage('best continent=',BestC,' with my armies less his armies of ',BestDiff);
    end;
  result:=BestC;
end;



function TargetTattack(enemyc, small, allfronts, onefronts: integer; force: double): integer;
var
  T, T2, BestT, BestT2, Diff, BestDiff: integer;
  ET, EA, X, Y: integer;

begin
  // LOCAL FUNCTION TARGETTattack:  determines the target territory to attack
  // will return a territory on another continent if no attacks are available
  // on the desired continent {can also return 0 if no feasible attack is available at all}
  // uses local global ENEMYC
  BestDiff:=SMALL*5;
  BestT:=0;
  for X:=1 to CTerritoriesCount(EnemyC) do
    begin
      T:=CTerritory(EnemyC,X);
//      //If UBufferGet(15) then //umessage('Checking out territory #',X,' of target continent ',ENEMYC);
      Y:=MyTPressure(T,ALLFRONTS);
//      if SConquest then
//        //If UBufferGet(15) then //umessage('Looking at territory ',T,' which you have ',Y,' total pressure on');
      if (Y>0) and (trunc(FORCE*TArmies(T))<(PNewArmies(PMe)+Y)) and (not TIsMine(T)) then
        begin
          // if its an enemy territory that can be conquered, then compute
          // your 1-front armies (+) less attacked armies (-) less new exposure to enemies (-)
          Diff:=MyTPressure(T,ONEFRONTS)-TArmies(T);
//          //If UBufferGet(15) then //umessage('Initial Diff (1-front armies less attacked) is ',Diff);
          for Y:=1 to TBordersCount(T) do
            begin
              T2:=TBorder(T,Y);
//              //If UBufferGet(15) then //umessage('Secondary loop, looking at territory #',Y,' (namely ',T2,') with my pressure of ',MyTPressure(T2,ALLFRONTS),' and armies ',TArmies(T2));
              if (MyTPressure(T2,ALLFRONTS)=0) and (not(TIsMine(T2))) then
                Diff:=Diff-TArmies(T2);
              // new exposure when territory is conquered
            end;
//          if SConquest then
//            //If UBufferGet(15) then //umessage('A conquerable territory on target continent ',EnemyC,' is ',T);
//          //If UBufferGet(15) then //umessage('my [wasted] 1-front armies less attacked armies less new exposures is ',Diff);
          if (Diff>BestDiff) then
            begin
               BestDiff:=Diff;
               BestT2:=BestT; //2nd better
               BestT:=T;
               
            end;
        end;
    end;
  if (BestT=0) and (not SConquest) then
    begin
      // look for easiest territory that can be taken [may be on another continent]
      for T:=1 to 42 do
          if TIsMine(T) then
            begin
              TWeakestFront(T,ET,EA);
              Diff:=TArmies(T)-EA;
              if (Diff>BestDiff) then
                begin
                  BestDiff:=Diff;
                  BestT2:=BestT; //2nd better
                  BestT:=ET;
                  
                end;
            end;
    end;
    //#########################Stop Wyrm going to Europe and Middle East too early
    ////If UBufferGet(15) then //umessage('UBufferGet(40) ',UBufferGet(40), '  BestT  ', BestT, '  BestT2  ', BestT2);
    If ((UBufferGet(39)>3) and ( BestT=27)  and (UBufferGet(40)<6) ) then BestT:=BestT2; 
    If ((UBufferGet(39)>3) and (BestT2=27) and (UBufferGet(40)<6) ) then BestT:=0;
    UBufferSet(41, 0);
    UBufferSet(42, 0);
    UBufferSet(43, 0);
    UBufferSet(44, 0);
    UBufferSet(45, 0); //Siam reinforcement
    UBufferSet(26, 0); //Venezuela reinforcement    
  result:=BestT;
end;


procedure Assignment(var ToTerritory: integer);
var
  T, i, cont, naterr, saterr,PT2,PA2,ET2,EA2,LPa,LTa,LAa,PTa,PAa,ETa,EAa: integer;
  Value,MaxValue: double;
  Bypass, TrySouthAmericaFirst, PutApart: boolean;
	
  
begin

//###Rules
CONTROL_PANEL;

  // choose unassigned territory with greatest value
  ToTerritory:=0;
  MaxValue:=0;
  for T:=1 to 42 do begin
    if TOwner(T)=0 then 
      begin  // territory is unassigned
      Value:=EvalT(T, TrySouthAmericaFirst);
      if Value>MaxValue then begin
        ToTerritory:=T;
        MaxValue:=Value;
      end;
    end;
  end;
 
//Do not permit totality in North America
CLeader(1,LPa,LTa,LAa);
CAnalysis(1,PTa,PAa,ETa,EAa);
If ((LTa=8) and (ETa=8)) then 
Begin 
For T:=1 to 9 do If TOwner(T)=0 then ToTerritory:=T;
Bypass:=True;
//If UBufferGet(15) then //umessage('Do not permit totality in North America');
end;

//Do not permit totality in Africa
If SPlayersCount<4 then 
begin
CLeader(4,LPa,LTa,LAa);
CAnalysis(4,PTa,PAa,ETa,EAa);
If ((LTa=5) and (ETa=5)) then 
Begin 
For T:=14 to 19 do If TOwner(T)=0 then ToTerritory:=T;
Bypass:=True;
//If UBufferGet(15) then //umessage('Do not permit totality in Africa');
end;
end;

//Do not permit totality in Europe
If SPlayersCount<=3 then 
begin
CLeader(3,LPa,LTa,LAa);
CAnalysis(3,PTa,PAa,ETa,EAa);
If ((LTa=6) and (ETa=6)) then 
Begin 
For T:=20 to 26 do If TOwner(T)=0 then ToTerritory:=T;
Bypass:=True;
//If UBufferGet(15) then //umessage('Do not permit totality in Europe');
end;
end;

If (UBufferGet(39)<=4) then
Begin
//Do not permit totality in South America
CLeader(2,LPa,LTa,LAa);
CAnalysis(2,PTa,PAa,ETa,EAa);
If ((LTa=3) and (ETa=3)) then 
Begin 
For T:=10 to 13 do If TOwner(T)=0 then ToTerritory:=T;
Bypass:=True;
//If UBufferGet(15) then //umessage('Do not permit totality in South America');
end;
end;


CLeader(TContinent(ToTerritory),LPa,LTa,LAa);
If ((PProgram(LPa)=PProgram(PMe)) and ((UBufferGet(29)=1) or (PutApart))) then Bypass:=False;


//CLeader(6,LPa,LTa,LAa);
//For T:=1 to 10 do i:=i+PArmiesCount(T);
If (Not TrySouthAmericaFirst) and 
(
((PProgram(TOwner(39))=PProgram(PMe)) and (TOwner(39)<>PMe)) or
((PProgram(TOwner(40))=PProgram(PMe)) and (TOwner(40)<>PMe)) or
((PProgram(TOwner(41))=PProgram(PMe)) and (TOwner(41)<>PMe)) or
((PProgram(TOwner(42))=PProgram(PMe)) and (TOwner(42)<>PMe)) 
)
 then TrySouthAmericaFirst:=True;



If (Not Bypass) then begin //Bypass

cont:=0; 
For i:=1 to 9 do 
  If TIsMine(i) then cont:=cont+1;
  
  
//2:if success in Australia achar contiguous in asia, if no contiguous try India, Chine, Japan
if SPlayersCount>2 then
begin
if ((TOwner(34)=0) and ((TOwner(36)=PMe) or (TOwner(37)=PMe) or (TOwner(35)=PMe)) ) then ToTerritory:=34;  //Try Taymyr if Buryat or Koryak or Yakut owned
if ((TOwner(35)=0) and ((TOwner(33)=PMe) or (TOwner(36)=PMe)) ) then ToTerritory:=35;  //Try Yakut if Mongolia or Koryak or Buryat owned
if ((TOwner(36)=0) and ((TOwner(33)=PMe) or (TOwner(37)=PMe) or (TOwner(38)=PMe)) ) then ToTerritory:=36;  //Try Buryat if Mongolia or Japan owned
if ((TOwner(33)=0) and ((TOwner(32)=PMe) or (TOwner(37)=PMe) or (TOwner(38)=PMe)) ) then ToTerritory:=33;  //Try Mongolia if China or Koryak or Japan owned

if ((TOwner(37)=0) and (cont>3)) then ToTerritory:=37;  //Try Koryak if success in NA


if ((TOwner(29)=0)) then ToTerritory:=29;
if (TOwner(38)=0)  then ToTerritory:=38;
if ((TOwner(37)=0) and ((SPlayersCount>2) or TIsMine(1)) ) then ToTerritory:=37;
 

if ((TOwner(30)=0) and ((TOwner(31)=PMe) or (UBufferGet(50)=66)) ) then ToTerritory:=30;  //Try India if Siam owned
if ((TOwner(32)=0) and ((TOwner(31)=PMe) or (TOwner(30)=PMe) or (UBufferGet(50)=66)) ) then ToTerritory:=32;  //Try China if Siam or India owned
end;

if ((TOwner(37)=0) and (cont>6) and ((SPlayersCount>2) or TIsMine(1)) ) then ToTerritory:=37;  //Try Koryak if very success in NA




//1:if success in NA find contiguous in Europe 
if ((TOwner(21)=0) and (TOwner(20)=PMe)) then ToTerritory:=21;  //Try Scandinavia if Iceland owned
if ((TOwner(24)=0) and (TOwner(20)=PMe)) then ToTerritory:=24;  //Try Great Britain if Iceland owned
if ( (TOwner(20)=0) and ((TOwner(3)=PMe) or (cont>3)) ) then ToTerritory:=20;  //Try Iceland if got Greenland or success in NA


CAnalysis(2,PT2,PA2,ET2,EA2);
saterr:=ET2; 


If (TArmies(39)+TArmies(40)+TArmies(41)+TArmies(42)=4) then
   if ( ((ET2>2) or (ET2+PT2=4)) and (SPlayersCount<6)) then UBufferSet(49, 2); //Can go NA!

  
CAnalysis(1,PT2,PA2,ET2,EA2);
naterr:=ET2;

If (SPlayersCount<5) or TrySouthAmericaFirst then
if (UBufferGet(49)=2) or (TrySouthAmericaFirst) then  //(TrySouthAmericaFirst and (saterr<4))
//If SPlayersCount=2 then

begin
//umessage('dfdf');
if TOwner(9)=0 then ToTerritory:=9;  //Mexico
if TOwner(1)=0 then ToTerritory:=1;  //Alaska
if TOwner(3)=0 then ToTerritory:=3;  //Greenland

if TOwner(2)=0 then ToTerritory:=2;  //Northwest Territory
if TOwner(4)=0 then ToTerritory:=4;  //Alberta
if TOwner(5)=0 then ToTerritory:=5;  //Ontario
if TOwner(7)=0 then ToTerritory:=7;  //Western US
if TOwner(8)=0 then ToTerritory:=8;  //Eastern US
if TOwner(6)=0 then ToTerritory:=6;  //Quebec
end;



If (NOT (
(
((PProgram(TOwner(10))=PProgram(PMe)) and (TOwner(10)<>PMe)) or
((PProgram(TOwner(11))=PProgram(PMe)) and (TOwner(11)<>PMe)) or
((PProgram(TOwner(12))=PProgram(PMe)) and (TOwner(12)<>PMe)) or
((PProgram(TOwner(13))=PProgram(PMe)) and (TOwner(13)<>PMe)) 
) and PutApart )
) then
Begin
if naterr<5 then 
	if ((saterr<2) or (TOwner(10)=PMe)) then if TOwner(9)=0 then ToTerritory:=9;  //Mexico now  if South America to be mine and North America not occupied 

if saterr<2 then if TOwner(12)=0 then ToTerritory:=12;  //Brazil
if (((saterr<3) and (naterr<5)) or (saterr<2)) then if TOwner(10)=0 then ToTerritory:=10;  //Venezuela
if saterr<2 then if TOwner(11)=0 then ToTerritory:=11;  //Peru
if saterr<2 then if TOwner(13)=0 then ToTerritory:=13;  //Argentina
end;



If (NOT (
(
((PProgram(TOwner(10))=PProgram(PMe)) and (TOwner(10)<>PMe)) or
((PProgram(TOwner(11))=PProgram(PMe)) and (TOwner(11)<>PMe)) or
((PProgram(TOwner(12))=PProgram(PMe)) and (TOwner(12)<>PMe)) or
((PProgram(TOwner(13))=PProgram(PMe)) and (TOwner(13)<>PMe)) 
) and (PutApart or TrySouthAmericaFirst ) )
) then
Begin
if naterr<5 then 
	if ((saterr<3) or (TOwner(10)=PMe)) then if TOwner(9)=0 then ToTerritory:=9;  //Mexico now  if South America to be mine and North America not occupied 

if saterr<4 then if TOwner(12)=0 then ToTerritory:=12;  //Brazil
if (((saterr<5) and (naterr<5)) or (saterr<2)) then if TOwner(10)=0 then ToTerritory:=10;  //Venezuela
if saterr<4 then if TOwner(11)=0 then ToTerritory:=11;  //Peru
if saterr<4 then if TOwner(13)=0 then ToTerritory:=13;  //Argentina
end;


if ((TOwner(31)=0) and 
  ((TOwner(39)=PMe) or (TOwner(40)=PMe) or (TOwner(41)=PMe) or (TOwner(42)=PMe))) 
    then ToTerritory:=31;  //Try Siam if some Australia territory is owned
    



CAnalysis(6,PT2,PA2,ET2,EA2); //Try Australia first if players>2

if ((TOwner(39)=PMe) or (TOwner(40)=PMe) or (TOwner(41)=PMe) or (TOwner(42)=PMe)) then UBufferSet(50, 66);

If NOT (TrySouthAmericaFirst and (SPlayersCount<4)) then
If (NOT (
(
((PProgram(TOwner(39))=PProgram(PMe)) and (TOwner(39)<>PMe)) or
((PProgram(TOwner(40))=PProgram(PMe)) and (TOwner(40)<>PMe)) or
((PProgram(TOwner(41))=PProgram(PMe)) and (TOwner(41)<>PMe)) or
((PProgram(TOwner(42))=PProgram(PMe)) and (TOwner(42)<>PMe)) 
) and PutApart )
) then
begin
If ET2<3 then 
  If ( (TOwner(39)=0) and ((TOwner(40)=PMe) or (TOwner(41)=PMe) or (TOwner(42)=PMe)) ) then ToTerritory:=39; 

If SPlayersCount>2 then If ET2<4 then If TOwner(39)=0 then ToTerritory:=39;
If SPlayersCount>2 then If ET2<4 then If TOwner(42)=0 then ToTerritory:=42;
If SPlayersCount>2 then If ET2<4 then If TOwner(40)=0 then ToTerritory:=40;
If SPlayersCount>2 then If ET2<4 then If TOwner(41)=0 then ToTerritory:=41; 
end;

//Try First South America
If TrySouthAmericaFirst then
If (NOT (
(
((PProgram(TOwner(10))=PProgram(PMe)) and (TOwner(10)<>PMe)) or
((PProgram(TOwner(11))=PProgram(PMe)) and (TOwner(11)<>PMe)) or
((PProgram(TOwner(12))=PProgram(PMe)) and (TOwner(12)<>PMe)) or
((PProgram(TOwner(13))=PProgram(PMe)) and (TOwner(13)<>PMe)) 
) and PutApart )
) then
Begin
If TOwner(12)=0 then ToTerritory:=12;  //Brazil
If TOwner(10)=0 then ToTerritory:=10;  //Venezuela
If TOwner(11)=0 then ToTerritory:=11;  //Peru
If TOwner(13)=0 then ToTerritory:=13;  //Argentina
end;


end; //Bypass
////umessage('ToTerritory ', ToTerritory, ' Bypass ',Bypass);

If ((UBufferGet(10)<0) or (UBufferGet(32)=1)) and (SPlayersCount=3) then
Begin
I:=ToTerritory;
ToTerritory:=0;
  T:=1;
  repeat
    if TOwner(T)=0 then
      ToTerritory:=T;
    T:=T+1;
  until (ToTerritory>0) or (T>42);
  
  If (T>14) then ToTerritory:=I;
end;
end;

// procP
procedure Placement(var ToTerritory: integer);
var
  EnemyC, EnemyT, T, T2, B, C, D, Diff, BestDiff: integer;
  PT, PA, ET, EA, X, Y, AnyAttack: integer;
  A1, A2, R: boolean;
  A,J,PT2,PA2,ET2,EA2,PT3,PA3,ET3,EA3,W,LP,LT,LA,PlayerStrong,AsiaRelease,Danger: integer;
  SMALL, ALLFRONTS, ONEFRONTS, CBONUS, MINARMIES: integer;
  Ratio,MaxRatio: double;
  FORCE, NEWRATIO: double;
  Reinforce, BypassRelease, ProtectAustralia, Bubble: Boolean;
  

//### wyrm

begin

  // check for kill player mode
  if (UBufferGet(99) = 1) or (UBufferGet(98) > 0) then begin
    KillPlayer_Placement(ToTerritory);
    exit;
  end;

  //if UBufferGet(39)>2 then begin  //Playing as Wyrm
  
  // PLACEMENT:  defines ToTerritory (where 1 army will be placed)
  // 1) make sure ANY attack is possible
  // 2) reinforce existing continents
  // 3) make sure desired attack is possible
  // 4) beef up the target continent
  // 5) take care of the rest of your territories


  SMALL:=-9999;       // CONSTANTS SECTION
  FORCE:=1.2;
  MINARMIES:=5;
  ALLFRONTS:=10;
  ONEFRONTS:=1;
  CBONUS:=12;          // bonus for reinforcing territories in current target continent
  NEWRATIO:=0.5;      // %-age of new armies that can go towards an out-of-continent attack

  ToTerritory:=0;
  AnyAttack:=0;
  for T:=1 to 42 do
    begin
      if TIsMine(T) then
        begin
          TWeakestFront(T,ET,EA);
          if (TArmies(T)>trunc(MINARMIES+EA*FORCE)) then
            AnyAttack:=1;
        end;
    end;

  for C:=1 to 6 do // reinforce existing continents if necessary - to defend against STRONGEST front first
    if (COwner(C)=PMe) and (ToTerritory=0) and (AnyAttack=1) then
      begin
        for B:=1 to CTerritoriesCount(C) do
          begin
            T:=CTerritory(C,B);
            if TIsFront(T) then
              begin
                TStrongestFront(T,ET,EA);
                if (double(TArmies(T))<(MINARMIES+EA*FORCE)) then // shortfall in my territory T
                  if (ToTerritory=0) then ToTerritory:=T
                  else if (TArmies(T)>TArmies(ToTerritory)) then ToTerritory:=T;
              end;
          end;
      end;


  EnemyC:=TargetCplacement(small);
  EnemyT:=TargetTplacement(EnemyC, Small, Allfronts, onefronts, force);

  if (EnemyT<>0) and (double(MyTPressure(EnemyT,ALLFRONTS))<((MINARMIES+TArmies(EnemyT)*FORCE))) then
    begin
      // continue to reinforce until attack is possible - put them all in strongest country
      BestDiff:=SMALL;
      for B:=1 to TBordersCount(EnemyT) do
        begin
          T:=TBorder(EnemyT,B);
          Diff:=TArmies(T);
          if TIsFront(T) and (Diff>BestDiff) then
            begin
              BestDiff:=Diff;
              ToTerritory:=T;
            end;
        end;      
    end;

  if (ToTerritory=0) and (1=1) then // attack is already guaranteed.  beef up the target continent
    begin
      PT:=0;
      PA:=0;
      ET:=0;
      EA:=0;
      BestDiff:=SMALL;
      CAnalysis(EnemyC, PT, PA, ET, EA);
      if (double(PA-PT)<(MINARMIES+ET+EA*FORCE)) then
        begin // place more armies in the continent so that you can capture the whole thing
          for B:=1 to CTerritoriesCount(EnemyC) do
            begin
              T:=CTerritory(EnemyC,B);
              Diff:=TArmies(T); // put in strongest
              if (PNewArmies(PMe)>5) then
                Diff:=-TArmies(T);  // but put in weakest front until 5 armies left
              if TIsFront(T) and (Diff>BestDiff) then
                begin
                  ToTerritory:=T;
                  BestDiff:=Diff;
                end;
            end;
        end;
    end;

  for C:=1 to 6 do // reinforce existing continents if necessary - WEAKEST front first
    if (COwner(C)=PMe) and (ToTerritory=0) then // if you own the continent and already have an attack
      begin
        for B:=1 to CTerritoriesCount(C) do
          begin
            T:=CTerritory(C,B);
            if TIsFront(T) then
              begin
                TStrongestFront(T,ET,EA);
                if (double(TArmies(T))<(EA*FORCE)) then
                  if (ToTerritory=0) then ToTerritory:=T
                  else if (TArmies(T)>TArmies(ToTerritory)) then ToTerritory:=T;
              end;
          end;
      end;

  TWeakestFront(EnemyT,ET,EA);
  if (EnemyT<>0) and (ToTerritory=0) and (double(MyTPressure(EnemyT,ALLFRONTS))<(EA+MINARMIES+TArmies(EnemyT)*FORCE)) then
    begin
      // continue to reinforce until attack is possible - put them all in strongest country
      BestDiff:=SMALL;
      for B:=1 to TBordersCount(EnemyT) do
        begin
          T:=TBorder(EnemyT,B);
          if TIsMine(T) and (TArmies(T)>BestDiff) then
            begin
              BestDiff:=TArmies(T);
              ToTerritory:=T;
            end;
        end;      
    end;


  for C:=1 to 6 do // reinforce existing continents if necessary
    if (COwner(C)=PMe) and (ToTerritory=0) then // if you own the continent and already have an attack
      begin
        for B:=1 to CTerritoriesCount(C) do
          begin
            T:=CTerritory(C,B);
            if TIsFront(T) then
              begin
                if (double(TArmies(T))<(TPressure(T)*FORCE)) then
                  if (ToTerritory=0) then ToTerritory:=T
                  else if (TArmies(T)>TArmies(ToTerritory)) then ToTerritory:=T;
              end;
          end;
      end;


  if ToTerritory=0 then // attack is already guaranteed
    begin
      BestDiff:=SMALL;
      for T:=1 to 42 do
        begin
          TWeakestFront(T,ET,EA);
          Diff:=TArmies(T)+PNewArmies(PMe)-EA; // worthwhile to fortify this one?
          if (TContinent(T)=EnemyC) then
            Diff:=1; // but always worthwhile fortifying your target continent
          if TIsFront(T) and (Diff>0) then 
            begin  // territory is mine and front and can be made stronger than the weakest front
              Diff:=TPressure(T)-TArmies(T);
              if TIsBordering(T,EnemyT) then
                Diff:=TPressure(T)+(TArmies(T) div 8); // avoid fortifying around a country you're about to take
              if (TContinent(T)=EnemyC) then
                Diff:=Diff+CBONUS;
//              //If UBufferGet(15) then //umessage('Territory ',T,' is worthy of fortification with Pressure - Armies + Bonus of ',Diff);
              if (Diff>BestDiff) then
                begin
                  ToTerritory:=T;
                  BestDiff:=Diff;
                end;
            end;
        end;
    end;
    
    //#################################
    
    If UBufferGet(14)<>1 then CONTROL_PANEL;

begin

UBufferSet(10,0);
//Says the number of players and TotalArmies
A:=0;
B:=0;
    R:=False;
    PlayerStrong:=0;
    For J:=1 to 10 do
    If PTerritoriesCount(J)>0 then
    Begin

If PTerritoriesCount(J)>0 then D:=D+1;

B:=B+PArmiesCount(J);

if palive(J) then if ( pos('australian', lowercase(PProgram(J))) > 0 ) then UBufferSet(10,-J);
 
     A1:=False; 
     A2:=False;
     If J<>PMe then
     If NOT R then
     For C:=1 to 6 do
      Begin
       If A1 then A2:=True;
       If COwner(C)=J then A1:=True else A1:=False;
       If (A2 and A1 ) then Begin R:=True; PlayerStrong:=J; C:=6; end;
      end;
 
    end;
    
    If R then UBufferSet(37, 1) else UbufferSet(37, 0);
    If R then UBufferSet(36, PlayerStrong) else UBufferSet(36, 0); //What player have more than one continent
UBufferSet(39,D);
UBufferSet(49,B);

////umessage(' TotalArmies ', UBufferGet(49), ' number of players ', UBufferGet(39), ' PlayerStrong ', UBufferGet(36));
    

If PHuman(COwner(6)) then UBufferSet(10,-COwner(6));

//Detect accumulator
If false then
If UBufferGet(10)=0 then
 For J:=1 to 42 do 
  Begin
   If (PArmiesCount(TOwner(J))>25) and (PTerritoriesCount(TOwner(J))<5) and (TOwner(J)<>PMe) then UBufferSet(10,TOwner(J));
  end;


    CAnalysis(5,PT,PA,ET,EA);
    Reinforce:=NOT ( ((COwner(6)=PMe) and (PT>10) and (EA<20)) or (R=True) );
    //If ((COwner(1)<>PMe) and (COwner(1)<>0)) then Reinforce:=False;
    
     A:=0;
 For J:=1 to 38 do 
 Begin
 C:=-16;
 If TContinent(J)=5 then C:=0 else If (TContinent(J)=4) or (TContinent(J)=3) or (J<6) then C:=-10;
 
 If ( (TArmies(J)+C>A) and (NOT TIsMine(J)) ) then 
 Begin 
 A:=TArmies(J); 
 T:=J; 
 end;
 end;


ProtectAustralia:=False;
Danger:=0;
If COwner(6)=PMe then
Begin 
 If TContinent(T)=5 then C:=0 else C:=16;
 If (TContinent(T)=4) or (TContinent(T)=3) then C:=10;
 J:=0;
 If UBufferGet(36)<>0 then
  If (COwner(4)=trunc(UBufferGet(36))) or (COwner(3)=trunc(UBufferGet(36))) and TIsMine(27) then J:=1+trunc(URandom(4));
 If TOwner(T)=-(trunc(UBufferGet(10))) then C:=C-8+J;
 If TIsMine(31) then A:=TArmies(31) else A:=1;
If ((TArmies(T)>=TArmies(39)+A+C+J) and (COwner(6)=PMe) ) then ProtectAustralia:=True;
If (TArmies(30)+TArmies(32)>TArmies(31)-6) and (TOwner(30)=TOwner(32)) then ProtectAustralia:=True;
If (TContinent(T)=5) and (TArmies(T)-TArmies(39)-A >15) then Danger:=T;
If (UBufferGet(10)<0) then
  if (TOwner(T)=-(trunc(UBufferGet(10)))) and 
    (TArmies(T)-TArmies(39)-A-1 >0) then Danger:=T;
If (UBufferGet(39)=2) and (Not TIsFront(31)) then
 Begin
 Danger:=0;
 ProtectAustralia:=False;
 end;
end;

//ubufferset(39, 4);
             //   UMessage('here1');
If trunc(UBufferGet(39))> 3 then
Begin


IF Reinforce or ProtectAustralia then Begin //Reinforce#1      

       //Leave some armies on China 
       If ((PT>3) and (PT<8) and (COwner(6)=PMe)) then 
       begin
       If ( (PArmiesCount(PMe)>40) and TIsMine(32) and (TArmies(32)<6) and ((NOT TIsMine(33)) or (NOT TIsMine(29))) ) then ToTerritory:=32;
       If ( (PArmiesCount(PMe)>40) and TIsMine(30) and (TArmies(30)<2) ) then ToTerritory:=30;
       end;
       
       
       //Leave some armies in Mongolia 
       If ((ToTerritory<>35) and (ToTerritory<>36) and (ToTerritory<>38)) then
       If ( (UBufferGet(36)=0) and //##0==ok
            (not TIsMine(37)) and 
             TIsMine(33) and 
             (TArmies(33)<7) and 
             (UBufferGet(10)=0)
           ) then ToTerritory:=33;

     //Prefer China instead India to invade Asia
     If UBufferGet(39)>3 then
     If  ((TIsMine(31)=True) and 
          (TIsMine(30)=True) and 
          (TIsMine(32)=True) and 
          (COwner(6)=PMe) and
          (TArmies(30)>3) and
          (TArmies(32)<16) and
          (PT=3)) then ToTerritory:=32;
 
           
           
       //Put armies in S.A. if it isn't mine
       CAnalysis(2,PT,PA,ET,EA);
       If PT>0 then
       If (UBufferGet(39)>2) then
       If (UBufferGet(39)>4) or ((COwner(6)=PMe) and (PTerritoriesCount(PMe)>16)) or (COwner(6)<>PMe) or (COwner(1)=PMe) then
       Begin
       
       CAnalysis(5,PT2,PA2,ET2,EA2);
       If (((PA<2*EA) or (PA<30)) and ((PT2<6) or (UBufferGet(32)=1)) ) then
       Begin
       If ((COwner(2)<>PMe) and (TContinent(ToTerritory)<>2)) and TIsMine(11) then ToTerritory:=11;
       If ((COwner(2)<>PMe) and (TContinent(ToTerritory)<>2)) and TIsMine(13) then ToTerritory:=13;
       If ((COwner(2)<>PMe) or ((UBufferGet(32)=1) and (TContinent(ToTerritory)>2))) and TIsMine(12) then ToTerritory:=12;
       If ((COwner(2)<>PMe) or ((UBufferGet(32)=1) and (TContinent(ToTerritory)>2))) and TIsMine(10) then ToTerritory:=10;
       end;
       end;
       
         
      //Brazil 2
     If (COwner(2)=PMe) then 
     begin
     If (COwner(1)=PMe) then C:=0 else C:=4;
     If ((COwner(1)=PMe) and (TArmies(1)>TArmies(37)+12)) then C:=4;
     If ((TArmies(12)<20) and ((TArmies(12)<TArmies(14)+8+(C div 2)) OR (UBufferGet(39)>4))) then ToTerritory:=12;
     If ((TArmies(10)<6+C) and (TArmies(12)>11) ) then ToTerritory:=10; 
     If (TArmies(12)<10) then ToTerritory:=12;
     If ((TArmies(10)<6) and (TArmies(12)>11)) then ToTerritory:=10;
     If ((TArmies(10)<4) and (TArmies(12)>6) and (TArmies(12)>TArmies(14)+3) ) then ToTerritory:=10;
     If ((TArmies(12)<4)) then ToTerritory:=12;
     end;
      
            
    //Fill Indonesia with 4 armies#
    If ((TArmies(39)<2) and (COwner(6)=PMe) and (UBufferGet(45)<>0)) then 
     Begin
     ToTerritory:=39;
     UBufferSet(41, 0);
     end;
 

If ProtectAustralia then 
If UBufferGet(39)>3 then
Begin

      //Protect Siam with one more armie
      If (Reinforce or (TArmies(31)<10)) then
      If ( TIsMine(31) and (COwner(6)=PMe) and (TArmies(31)<16) and (UBufferGet(45)=0) ) then 
       Begin
        ToTerritory:=31;
        UBufferSet(45, 1);
        //If UBufferGet(15) then //umessage('Armie placed in Siam ' );
       end
      else
       UBufferSet(45, 2);
       
       If TIsMine(39) then ToTerritory:=39;
       If TIsMine(31) then ToTerritory:=31;

end;//Protect Australia   

      //Try Fill Koryak with 8 if Asia is mine 
      If ( TIsMine(37) and 
          (TArmies(37)<8) and 
          (NOT (COwner(1)=PMe)) and
          (COwner(5)=PMe) ) then  //Asia is mine
       Begin
        ToTerritory:=37;
        PT:=777;
        //If UBufferGet(15) then //umessage('Fill Koryak with 8');
       end;
       
end;  //Reinforce#1   


     CAnalysis(5,PT,PA,ET,EA);
     If PT=11 then
     Begin 
     
     If (TContinent(ToTerritory)=5) and (ToTerritory<>31) then
     Begin
     TStrongestFront(ToTerritory,ET2,EA2);
     If (TArmies(ToTerritory)>EA2+10) or (UBufferGet(36)=0) then A:=234;
     end;

//Put in Asia before putting on Europe or Africa or South America
If ((A=234) or (TContinent(Toterritory)=2) or (TContinent(Toterritory)=3) or (TContinent(Toterritory)=4)) then
Begin
B:=0;
C:=0;
  For T:=27 to 38 do //Find what is not mine
   begin 
    If (TIsMine(T)=False) then B:=T;
    If TIsBordering(B,T) and (B<>0) and TIsMine(T) and (TArmies(T)>TArmies(C)) then C:=T;
   end;

If TIsMine(C) then ToTerritory:=C;
If TIsBordering(B,37) and TIsMine(37) then ToTerritory:=37;
end;

end; //pt=11

     //Protect Koryak with one more armie 
      If ( TIsMine(37) and 
          (TArmies(37)<8) and 
          (NOT (COwner(1)=PMe)) and
          (UBufferGet(44)=0) and
          (PT>7) and 
          (TArmies(39)>9) ) then  //Indonesia secured
       Begin
        ToTerritory:=37;
        UBufferSet(44, 1);
        //If UBufferGet(15) then //umessage('Armie placed in Koryak');
       end;
       



      //Try Fill Koryak with 10+T if Asia is mine and Koryak was already filled with 8
      If ( TIsMine(37) and 
          ((TIsMine(1)=False) or(TIsMine(1) and (TArmies(1)<20))) and 
          ((TArmies(37)<14) OR ((NOT TIsMine(1)) and (TArmies(37)-TArmies(1)<10))) and 
          (NOT (COwner(1)=PMe)) and
          (TArmies(37)>7) and
          (PT<>777) and
          (COwner(5)=PMe) ) then
       Begin
        ToTerritory:=37;
        //If UBufferGet(15) then //umessage('Fill Koryak with 14');
       end;
       
If UBufferGet(36)<>0 then
If (Danger=0) or (trunc(UBufferGet(36))=TOwner(Danger)) or (ToTerritory<>31) then 
Begin
     //Put everything in India if someone have 2 continents 
     If ( (UBufferGet(36)>0) and 
           TIsMine(30) and 
          (TArmies(30)<14) and
    ( ((COwner(3)<>0) and (COwner(3)=UBufferGet(36))) OR 
      ((COwner(4)<>0) and (COwner(4)=UBufferGet(36))) ) and 
      (TIsMine(27)=False) and 
      (TIsMine(29)=False) ) then ToTerritory:=30;
      
     //Put everything in Kazakhstan if someone have 2 continents (one being EU or AF and M.E. not mine)
     If ( (UBufferGet(36)>0) and (TIsMine(29)=True) and (TArmies(29)<14) and
    ( ((COwner(3)<>0) and (COwner(3)=UBufferGet(36))) OR 
      ((COwner(4)<>0) and (COwner(4)=UBufferGet(36))) ) and 
      (TIsMine(27)=False) ) then ToTerritory:=29;


     //Put everything in Middle East if someone have 2 continents (one being EU or AF)
If UBufferGet(36)<>0 then
Begin

If (COwner(4)=0) then
 Begin
 A:=0;
 If ( (COwner(3)<>0) and (COwner(3)<>PMe) and (TArmies(26)<=TArmies(22)) ) then Begin A:=TArmies(26); T:=26; end;
 If ( (COwner(3)<>0) and (COwner(3)<>PMe) and (TArmies(22)< TArmies(26)) ) then Begin A:=TArmies(22); T:=22; end;
 end;
 
If (COwner(3)=0) then
 Begin
 B:=0;
 If ( (COwner(4)<>0) and (COwner(4)<>PMe) and (TArmies(16)<=TArmies(15)) ) then Begin B:=TArmies(16); T2:=16; end;
 If ( (COwner(4)<>0) and (COwner(4)<>PMe) and (TArmies(15)< TArmies(16)) ) then Begin B:=TArmies(15); T2:=15; end;
 end;
 

     If ( TIsMine(27) and (TArmies(27)<A+B+8) and
     ((COwner(3)=trunc(UBufferGet(36))) OR (COwner(4)=trunc(UBufferGet(36))))
      ) then ToTerritory:=27;

end;
end;

      //Do not permit placements in Africa, Europe and Asia if you hold South America
      //(Permit put on Asia if you hold Australia too)
      If (COwner(6)=PMe) then C:=4 else C:=5;
      If PTerritoriesCount(PMe)<22 then
      If ( Not ((COwner(5)=PMe) and (COwner(6)=PMe)) ) then
      If ( (((TContinent(ToTerritory)=3) or (TContinent(ToTerritory)=4) or (TContinent(ToTerritory)=C)) and (COwner(2)=PMe) and (PArmiesCount(PMe)<200)) OR
           ((ToTerritory=12) and (Tarmies(12)>(trunc(1.2*Tarmies(14)+10))) and (Tarmies(12)>36)) ) then 
      Begin
      If TIsMine(3) then ToTerritory:=3;
      If TIsMine(1) then ToTerritory:=1;
      If TIsMine(10) then ToTerritory:=10;
      If TIsMine(9) then ToTerritory:=9;
      If TIsMine(4) then ToTerritory:=4;
      If TIsMine(6) then ToTerritory:=6;
      If TIsMine(8) then ToTerritory:=8;
      If TIsMine(7) then ToTerritory:=7;
      If TIsMine(5) then ToTerritory:=5;
      
      If (COwner(1)=PMe) then
      Begin
      If (COwner(2)=PMe) then ToTerritory:=3;
      If (COwner(2)=PMe) then ToTerritory:=1;
      If ((TArmies(3)<32)) then ToTerritory:=3;
      If ((TArmies(1)<32)) then ToTerritory:=1;
      If ((TArmies(3)<12)) then ToTerritory:=3;
      If ((TArmies(1)<12)) then ToTerritory:=1;
      If ((double(TArmies(3))<(1.2*TArmies(20)+4)) and (Not TisMine(20))) then ToTerritory:=3;
      If ((double(TArmies(1))<(1.3*TArmies(37)+6)) and (Not TisMine(37))) then ToTerritory:=1;
      If ((TArmies(3)<4)) then ToTerritory:=3;
      If ((TArmies(1)<6)) then ToTerritory:=1;
      end;
      
      If (TIsMine(14) and (TArmies(14)<4)) then ToTerritory:=14;
      CAnalysis(2,PT,PA,ET,EA);
      If ((TArmies(12)<30) and TIsMine(12) and (PA<40)) then ToTerritory:=12;
      If ((TArmies(12)<10) and TIsMine(12)) then ToTerritory:=12;
      end;
   
      //Do not weaken these 
      If ( (PArmiesCount(PMe)>130) and (TArmies(3)<12) and (COwner(1)=PMe) ) then ToTerritory:=3;
      If ( (PArmiesCount(PMe)>130) and (TArmies(1)<12) and (COwner(1)=PMe) ) then ToTerritory:=1;
   
      //Basic N.A. Protection
      If (COwner(2)=PMe) then
      If ( (((TArmies(12)>35) and (TArmies(12)>TArmies(14))) or (TArmies(12)>TArmies(14)+16)) ) then
      Begin
      If (TIsMine(3) and (TArmies(3)<22) and (COwner(1)=PMe)) then ToTerritory:=3;
      If (TIsMine(1) and (TArmies(1)<32) and (COwner(1)=PMe)) then ToTerritory:=1;
      If (TIsMine(3) and (TArmies(3)<16) and (COwner(1)=PMe)) then ToTerritory:=3;
      If (TIsMine(1) and (TArmies(1)<24) and (COwner(1)=PMe)) then ToTerritory:=1;
      If (TIsMine(3) and (TArmies(3)<10) and (COwner(1)=PMe)) then ToTerritory:=3;
      If (TIsMine(1) and (TArmies(1)<16) and (COwner(1)=PMe)) then ToTerritory:=1;
      If (TIsMine(3) and (double(TArmies(3))<(1.2*TArmies(20)+2)) and (Not TisMine(20))) then ToTerritory:=3;
      If (TIsMine(1) and (double(TArmies(1))<(1.3*TArmies(37)+4)) and (Not TisMine(37))) then ToTerritory:=1;
      If (TIsMine(3) and (TArmies(3)<4)) then ToTerritory:=3;
      If (TIsMine(1) and (TArmies(1)<6)) then ToTerritory:=1;
      end;
      If ((COwner(2)=PMe) and (TArmies(12)>=20) and (TArmies(12)>TArmies(14))) then
      Begin
      If (TIsMine(3) and (TArmies(3)<6) and (COwner(1)=PMe)) then ToTerritory:=3;
      If (TIsMine(1) and (TArmies(1)<12) and (COwner(1)=PMe)) then ToTerritory:=1;
      end;
      
      If TArmies(9)>20 then C:=5 else C:=0;
      //Fortify Alaska instead Greenland if necessary
      If ((TArmies(1)<TArmies(37)+5+C) and (TIsMine(37)=False) and (COwner(1)=PMe) and ((ToTerritory=3) or ((ToTerritory=9) and (TArmies(9)>TArmies(10)+6))) and (TArmies(3)>TArmies(20)+3)) then  ToTerritory:=1;
   
      //Fortify Greenland instead Alaska if necessary
      If ((TArmies(3)<TArmies(20)+5+C) and (TIsMine(20)=False) and (COwner(1)=PMe) and ((ToTerritory=1) or ((ToTerritory=9) and (TArmies(9)>TArmies(10)+6))) and (TArmies(1)>TArmies(37)+10)) then  ToTerritory:=3;
   
     //Put everything in Brazil if enemy is heavy on North Africa
     If ((COwner(2)=PMe) and ((COwner(1)=0) or (COwner(1)=PMe)) and (TIsMine(14)=False) and (TArmies(12)<TArmies(14)+2)) then ToTerritory:=12;
      
     //Attack Mexico
      CAnalysis(1,PT,PA,ET,EA);
      If ((ET<=2) and (TIsMine(9)=False) and TIsMine(8) and ((TArmies(9)<30) or (PNewArmies(PMe)+TArmies(7)+TArmies(8)>TArmies(9)))) then ToTerritory:=8; 
      If ((ET<=2) and (TIsMine(9)=False) and TIsMine(7) and ((TArmies(9)<30) or (PNewArmies(PMe)+TArmies(7)+TArmies(8)>TArmies(9)))) then ToTerritory:=7;
     
     //Put everything in Northwest Territory if someone got in North America
     if TIsMine(2) then //and (TArmies(2)<EA+4*ET) 
      If ((ET<=2) and ((TIsMine(1)=False) or (TIsMine(3)=False)) and ((TArmies(12)>TArmies(14)) or TIsMine(14) or (TIsMine(12)=False)) ) then ToTerritory:=2; 
    
     //UBufferGet(43)= initial PNewArmies
     If (UBufferGet(43)=0) then UBufferSet(43, PNewArmies(PMe));
     

    
    //If Asia occupied try put in Alaska 
If( (COwner(5)<>0) and (COwner(5)=trunc(UBufferGet(36))) and TIsMine(1) and (TArmies(1)<6+TArmies(37) ) ) then ToTerritory:=1;
    
       If (COwner(5)=PMe) then
       Begin
       //Fortify comquered Asia
       If ((COwner(5)=PMe) and (TArmies(27)<14)) then ToTerritory:=27;
       If ((COwner(5)=PMe) and (TArmies(28)<8)) then ToTerritory:=28;
       If ((COwner(5)=PMe) and (TArmies(29)<8)) then ToTerritory:=29;
       If ((COwner(5)=PMe) and (TArmies(27)<10)) then ToTerritory:=27;
       If ((COwner(5)=PMe) and (NOT (COwner(1)=PMe)) and (TArmies(37)<8)) then ToTerritory:=37;

       //Mimimum reinforcement in Asia
       If ((COwner(5)=PMe) and (TArmies(28)<4)) then ToTerritory:=28;
       If ((COwner(5)=PMe) and (TArmies(29)<4)) then ToTerritory:=29;
       If ((COwner(5)=PMe) and (TArmies(37)<4)) then ToTerritory:=37;
       If ((COwner(5)=PMe) and (TArmies(27)<6)) then ToTerritory:=27;
       end;

If ((TContinent(ToTerritory)=3) or (TContinent(ToTerritory)=4)) then
Begin
If UBufferGet(39)>4 then 
Begin
       //Fortify Asia/Aust before putting something on Europe or Africa if Players>4
       If ((TArmies(28)<10) and TIsMine(28)) then ToTerritory:=28;
       If ((TArmies(29)<12) and TIsMine(29)) then ToTerritory:=29;
       If ((TArmies(27)<20) and TIsMine(27)) then ToTerritory:=27;
       If ((TArmies(28)<8) and TIsMine(28)) then ToTerritory:=28;
       If ((TArmies(37)<18) and TIsMine(37) and (NOT (COwner(1)=PMe))) then ToTerritory:=37;
       If ((TArmies(39)<12) and (COwner(5)=0) and TIsMine(39)) then ToTerritory:=39;
       If ((TArmies(31)<10) and (COwner(5)=0) and (UBufferGet(36)=0) and TIsMine(31)) then ToTerritory:=31;
       If (((TContinent(ToTerritory)=4)) and (COwner(5)=0) and (TArmies(33)<10) and TIsMine(33)) then ToTerritory:=33;
       
       end;  

       If ((TArmies(27)<4) and TIsMine(27)) then ToTerritory:=27;
       If ((TArmies(29)<4) and TIsMine(29)) then ToTerritory:=29;
       If ((TArmies(28)<4) and TIsMine(28)) then ToTerritory:=28;
       If ((TArmies(37)<4) and TIsMine(37)) then ToTerritory:=37; 
end;

     CAnalysis(2,PT2,PA2,ET2,EA2);
     If (UBufferGet(32)=0) or (PT2=0) or (PTerritoriesCount(PMe)>12) then
Begin//##
     //Prepare to attack Siam from India if China not mine
     If (((TIsMine(31)=False) and 
         (TIsMine(39)=False) and 
         (TIsMine(40)=False) and 
         (TIsMine(41)=False) and 
         (TIsMine(42)=False)) and
         (TArmies(31)+ TArmies(39)<(trunc(UBufferGet(43))+TArmies(30)) ) and
         (TIsMine(30)=True)) then 
       ToTerritory:=30;

    //Prepare to attack Siam from China  (#concentrate in kazak)  
    If ( ((TArmies(32)>TArmies(30)) and TIsMine(30)) or (TIsMine(30)=False) ) then
     If ((
         (TIsMine(31)=False) and 
         (TIsMine(39)=False) and 
         (TIsMine(40)=False) and 
         (TIsMine(41)=False) and 
         (TIsMine(42)=False)) and
         (TArmies(31)+ TArmies(39)+TArmies(40)+TArmies(41)+TArmies(42)-3<(trunc(UBufferGet(43))+TArmies(32)) ) and
          TIsMine(32) ) then 
          ToTerritory:=32;
     
    
    //Prepare to attack Indonesia from Siam
    CAnalysis(6,PT,PA,ET,EA);
      If ( TIsMine(31) and 
           (PT=0) and
           (COwner(6)<>PMe) and 
           (TArmies(31)+PNewArmies(PMe)>=TArmies(39)+TArmies(40)+TArmies(41)-4) and
           (TArmies(31)<TArmies(39)+TArmies(40)+TArmies(41)+TArmies(42)+6)
          ) then 
        ToTerritory:=31;
        
CAnalysis(6,PT,PA,ET,EA);
If PT=0 then
Begin
     //Fortify China to conquest Australia
     If (  TIsMine(32) and 
          (TIsMine(31)=False) and 
          (((TArmies(32)>TArmies(30)) and TIsMine(30)) or (TIsMine(30)=False)) and
          (TArmies(32)+PNewArmies(PMe)>TArmies(31)+TArmies(39)+TArmies(40))
         ) then ToTerritory:=32;
     
          //Fortify India to conquest Australia
     If (  TIsMine(30) and 
          (TIsMine(31)=False) and 
          (((TArmies(30)>=TArmies(32)) and TIsMine(32)) or (TIsMine(32)=False)) and
          (TArmies(30)+PNewArmies(PMe)>TArmies(31)+TArmies(39)+TArmies(40))
         ) then ToTerritory:=30;

          //Fortify Siam to conquest Australia
     If (  TIsMine(31) and 
          (TArmies(31)+PNewArmies(PMe)>TArmies(39)+TArmies(40)+TArmies(41)+TArmies(42)-4)
         ) then ToTerritory:=31;
end;

end;//##

end; //if UBufferGet(39)>3


//Case specific Players=3
 If UBufferGet(39)=3 then
Begin
CAnalysis(5,PT,PA,ET,EA);
CAnalysis(1,PT2,PA2,ET2,EA2);


If NOT ((UBufferGet(39)>4) or ((COwner(6)=PMe) and (PTerritoriesCount(PMe)>16)) or (COwner(6)<>PMe) or (COwner(1)=PMe)) then
      If (TContinent(ToTerritory)=2) then
      If UBufferGet(32)=0 then
       Begin
       //umessage(' larica ', ToTerritory);
       If TIsFront(33) then ToTerritory:=33;
       If TIsFront(27) then ToTerritory:=27;
       If TIsFront(32) then ToTerritory:=32;
       If TIsFront(30) then ToTerritory:=30;
       If TIsFront(31) then ToTerritory:=31;
       If TIsFront(39) then ToTerritory:=39;
       If (TContinent(ToTerritory)=2) then ToTerritory:=0;
       end;


       If ((TArmies(31)<4) and (PNewArmies(PMe)>8) and (COwner(6)=PMe) and TIsMine(31)) then ToTerritory:=31;
       
If ( (TContinent(ToTerritory)<>5) and (TContinent(ToTerritory)<>1) ) then
Begin

       If (((TContinent(ToTerritory)=3) and (COwner(6)=PMe)) and (TArmies(33)<4) and TIsMine(33)) then ToTerritory:=33;
       If (((TContinent(ToTerritory)=3)) and (TArmies(37)<6) and TIsMine(37)) then ToTerritory:=37;
       
//if c2 not mine
       If (((TContinent(ToTerritory)=2) or (TContinent(ToTerritory)=3) or (TContinent(ToTerritory)=4)) and (TArmies(32)<2) and (PT>4) and (PT<9) and TIsMine(32)) then ToTerritory:=32;
       If (((TContinent(ToTerritory)=2) or (TContinent(ToTerritory)=3) or (TContinent(ToTerritory)=4)) and (TArmies(30)<2) and (PT>4) and (PT<9) and TIsMine(30)) then ToTerritory:=30;
       If (((TContinent(ToTerritory)=2) or (TContinent(ToTerritory)=3) or (TContinent(ToTerritory)=4)) and (TArmies(33)<6) and (TArmies(33)+TArmies(35)+TArmies(36)+TArmies(38)<11) and (PT>4) and (PT<9) and TIsMine(33)) then ToTerritory:=33; 
       If ( (TContinent(ToTerritory)<>5) and (TArmies(27)<16) and TIsMine(27) and (PT>10)) then ToTerritory:=27;
       If (((TContinent(ToTerritory)=2) or (TContinent(ToTerritory)=3) or (TContinent(ToTerritory)=4)) and (TArmies(37)<4) and TIsMine(37) and (TIsFront(37) or (NOT TIsMine(27))) ) then ToTerritory:=37;
       If (((TContinent(ToTerritory)=2) or (TContinent(ToTerritory)=3) or (TContinent(ToTerritory)=4)) and (TArmies(29)<6) and (PT>4) and TIsMine(29)) then ToTerritory:=29; 
       If (((TContinent(ToTerritory)=2) or (TContinent(ToTerritory)=3) or (TContinent(ToTerritory)=4)) and (TArmies(28)<6) and (PT>4) and TIsMine(28)) then ToTerritory:=28;  
       If ( (TContinent(ToTerritory)<>5)  and (TArmies(27)<12) and TIsMine(27) and (PT>9)) then ToTerritory:=27;
end;


       If ((TArmies(39)<TArmies(31)) and (TIsMine(31)=False) and (COwner(6)=PMe)) then ToTerritory:=39;
       If TIsMine(1) then C:=9 else C:=8+TArmies(1); 
       If ((COwner(5)=PMe) and (NOT (COwner(1)=PMe)) and (TArmies(37)<C)) then ToTerritory:=37;
       If ((COwner(5)=PMe) and (TArmies(27)<10)) then ToTerritory:=27;
       If ((COwner(5)=PMe) and (TArmies(28)<4)) then ToTerritory:=28;
       If ((COwner(5)=PMe) and (TArmies(29)<4)) then ToTerritory:=29;
       If ((PT>9) and (TArmies(33)<2) and TIsMine(33)) then ToTerritory:=33;
       If ((COwner(5)=PMe) and (TArmies(37)<4)) then ToTerritory:=37;
       If ((COwner(5)=PMe) and (TArmies(27)<4)) then ToTerritory:=27;
       
       If ((COwner(2)=PMe) and (TArmies(12)<4)) then ToTerritory:=12;
       
       If (PT<9) and (EA2<16) and (PT2<8) then
       If (TContinent(ToTerritory)<>6) and (ToTerritory<>31) then
       Begin
       If TIsMine(1) and ((NOT TIsMine(2)) or (NOT TIsMine(4))) then T:=1;
       If TIsMine(7) and TIsFront(7)then T:=7;
       If TIsMine(8) and TIsFront(8)then T:=8;
       If TIsMine(6) and TIsFront(6) then T:=6;
       If TIsMine(4) and TIsFront(4) then T:=4;
       If TIsMine(2) and TIsFront(2) then T:=2;
       If TIsMine(5) and TIsFront(5) then T:=5;
       If ( ((TContinent(ToTerritory)=3) or (TContinent(ToTerritory)=2)) and TIsMine(T) ) then ToTerritory:=T;
       end;

If ( (COwner(2)=PMe) and (TArmies(12)<TArmies(14)+2) and (Not TIsMine(14)) ) then ToTerritory:=12;


      If (UBufferGet(10)<>0) and (COwner(6)=-(trunc(UBufferGet(10)))) then C:=6 else C:=0;
      If ToTerritory=12 then
      If (COwner(1)=PMe) and (COwner(2)=PMe) then
      If TArmies(12)-TArmies(14)>20 then C:= round((TArmies(12)-TArmies(14)-15)/3);  //#*# used round instead of trunc calculations using c will be slightly different than in ver 1.2 too complicated to fix

      If (COwner(1)=PMe) then
      Begin
      If (TOwner(20)=COwner(6)) and (NOT (TOwner(1)=COwner(6))) then C:=C+3;
      If (COwner(3)<>PMe) then
       If ((double(TArmies(3))<(1.2*TArmies(20)+5+C)) and ((Not TisMine(20)) or (TArmies(3)<20))) then ToTerritory:=3;
      If TOwner(37)=COwner(6) then C:=C+3;
      If (COwner(5)<>PMe) then 
       if TIsMine(20) or (TArmies(3)>TArmies(20)+1) then
        If ((double(TArmies(1))<(1.3*TArmies(37)+6+C)) and ((Not TisMine(37)) or (TArmies(1)<20))) then ToTerritory:=1;
      If ((TArmies(3)<6)) then ToTerritory:=3;
      If ((TArmies(1)<6)) then ToTerritory:=1;
      If ((TArmies(3)<4)) then ToTerritory:=3;
      If ((TArmies(1)<4)) then ToTerritory:=1;
      //umessage('n.a. put ', ToTerritory); 
      end;

If (UBufferGet(36)=0) or (Danger<>0) then //##00 ok
Begin
       If ProtectAustralia and TIsMine(39) then ToTerritory:=39;
       If ProtectAustralia and TIsMine(31) then ToTerritory:=31;
end;

If (UBufferGet(36)<>0) then
If (Danger=0) or 
((trunc(UBufferGet(36))=TOwner(Danger)) and 
      ( (PArmiesCount(-(trunc(UBufferGet(10))))<TArmies(31)) or (ToTerritory<>31) or (TArmies(31)<35) )) or 
(ToTerritory<>31) then 
Begin
     //Put everything in India if someone have 2 continents
     If (  (UBufferGet(36)<>0) and 
           TIsMine(30) and 
          (TArmies(30)<10) and
    ( ((COwner(3)<>0) and (COwner(3)=trunc(UBufferGet(36)))) OR 
      ((COwner(4)<>0) and (COwner(4)=trunc(UBufferGet(36)))) ) and 
      (TIsMine(27)=False) and 
      (TIsMine(29)=False) ) then ToTerritory:=30;
      
     //Put everything in Kazakhstan if someone have 2 continents (one being EU or AF and M.E. not mine)
     If ( (UBufferGet(36)<>0) and (TIsMine(29)=True) and (TArmies(29)<10) and
    ( ((COwner(3)<>0) and (COwner(3)=trunc(UBufferGet(36)))) OR 
      ((COwner(4)<>0) and (COwner(4)=trunc(UBufferGet(36)))) ) and 
      (TIsMine(27)=False) ) then ToTerritory:=29;


       //Put armies in SA c1 occupied
If (COwner(1)<>0) and (COwner(1)<>PMe) and (ToTerritory<>10) then //or UBufferGet(32)
Begin
       CAnalysis(2,PT,PA,ET,EA);
       CAnalysis(1,PT2,PA2,ET2,EA2);
       CLeader(6,LP,LT,LA);
       If NOT ((LT>0) and (UBufferGet(39)=3)) then
       If ( ((double(PA)<(1.5*EA+2)) and ((COwner(5)=PMe) or (LP<>PMe)) and (PT2<5)) or 
            ((PProgram(LP)=PProgram(PMe)) and (LP<>PMe)) ) then
       Begin
       //umessage( 'Put armies in SA c1 occupied');
       If ((COwner(2)<>PMe) and ( ((TContinent(ToTerritory)<>2) ) ) and TIsMine(11)) then ToTerritory:=11;
       If ((COwner(2)<>PMe) and ( ((TContinent(ToTerritory)<>2) ) ) and TIsMine(13)) then ToTerritory:=13;
       If ((COwner(2)<>PMe) and ( ((TContinent(ToTerritory)<>2) ) ) and TIsMine(12)) then ToTerritory:=12;
       If ((COwner(2)<>PMe) and ( ((TContinent(ToTerritory)<>2) ) ) and TIsMine(10)) then ToTerritory:=10;
       end;
end;


     //Put in Siam to atack EU or Af
    If UBufferGet(39)=3 then
     If (COwner(1)=0) and TIsMine(31) then
      If (COwner(3)=trunc(UBufferGet(36))) or (COwner(4)=trunc(UBufferGet(36))) then
       If (NOT TIsMine(27)) and (NOT TIsMine(28)) and (NOT TIsMine(29)) and (NOT TIsMine(30)) then
        If (TContinent(ToTerritory)<>1) and (TContinent(ToTerritory)<>4) and (TContinent(ToTerritory)<>2) then
         ToTerritory:=31;  

     //Put everything in Middle East if someone have 2 continents (one being EU or AF)
If (COwner(3)=trunc(UBufferGet(36))) or (COwner(4)=trunc(UBufferGet(36))) and (UBufferGet(36)<>0) then
Begin//one rule
A:=0;
If (COwner(4)=0) then
 Begin
 If ( (COwner(3)<>0) and (COwner(3)<>PMe) and (TArmies(26)<=TArmies(22)) ) then Begin A:=TArmies(26); T:=26; end;
 If ( (COwner(3)<>0) and (COwner(3)<>PMe) and (TArmies(22)< TArmies(26)) ) then Begin A:=TArmies(22); T:=22; end;
 end;
 
 Begin
 B:=0;
 If ( (COwner(4)<>0) and (COwner(4)<>PMe) and (TArmies(16)<=TArmies(15)) ) then Begin B:=TArmies(16); T2:=16; end;
 If ( (COwner(4)<>0) and (COwner(4)<>PMe) and (TArmies(15)< TArmies(16)) ) then Begin B:=TArmies(15); T2:=15; end;
 end;

     If ( (TIsMine(27)=True) and (TArmies(27)<A+B+8) and
    ( ((COwner(3)<>0) and (COwner(3)=trunc(UBufferGet(36)))) OR 
      ((COwner(4)<>0) and (COwner(4)=trunc(UBufferGet(36)))) )
      ) then ToTerritory:=27;
      
end;//one rule

end;

    //Prepare to attack Indonesia from Siam
If (COwner(6)<>PMe) then
If TIsMine(31) then
If (UBufferGet(39)>2) then
Begin
    CAnalysis(6,PT,PA,ET,EA);
      If ( 
           (PT=0) and
           (TArmies(31)+PNewArmies(PMe)>=TArmies(39)+TArmies(40)+TArmies(41)-4) and
           (TArmies(31)<TArmies(39)+TArmies(40)+TArmies(41)+TArmies(42)+6)
          ) then ToTerritory:=31;
end;


end; //Players=3

//Let the bubble with few players under extreme weakness
If UBufferGet(10)<0 then
If (UBufferGet(8)=0) and (UBufferGet(9)=0) then
Begin
If (UBufferGet(39)=3) then
If PTerritoriesCount(PMe)<1+trunc(UBufferGet(39)) then
 If (-(trunc(UBufferGet(10)))=COwner(6)) then UBufferSet(33, 0);

 If (UBufferGet(39)=4) then UBufferSet(33, 0);
end;

//N.A. invasion
If COwner(TContinent(ToTerritory))<>PMe then
If (TContinent(ToTerritory)<>1) and (TContinent(ToTerritory)<>6) then
If ToTerritory<>31 then
If UBufferGet(30)=0 then
Begin

A:=1;
For T:=1 to 9 do
 If Not TIsMine(T) then Begin C:=T; T:=9; end;
For T:=C+1 to 9 do
 If (Not TIsMine(T)) and (TOwner(C)<>TOwner(T)) then Begin A:=2; T:=9; end;

If A=1 then C:=12 else C:=8;

If COwner(6)<>PMe then
Begin
B:=0;
If TIsMine(30) then B:=TArmies(30);
If TIsMine(32) then B:=TArmies(32)+B;
If ((ToTerritory=30) or (ToTerritory=32)) and (PNewArmies(PMe)+B+1>TArmies(31)+TArmies(39)) then C:=-1000;
end;

CAnalysis(1,PT,PA,ET,EA);
CAnalysis(TContinent(ToTerritory),PT2,PA2,ET2,EA2);

If (PT<7) and (PT2 + ET2 > 0) then  // added (PT2 + ET2 > 0) to prevent divide by zero bug, Nathan Scarbrough 6-9-10 #*#
If (((double(PA2)+PT2)/(double(PA2)+PT2+EA2+PA2)<0.7) and (double(PT2)/(double(PT2)+ET2)<0.7)) or
((TContinent(ToTerritory)=5) and ((COwner(6)=-(trunc(UBufferGet(10)))) or (COwner(6)=trunc(UBufferGet(10)))))
then
If EA+ET-(PT+PA+PNewArmies(PMe)-3)<C then
Begin
//umessage('N.A. Invasion ', ToTerritory ); 
If TIsFront(9) then ToTerritory:=9;
If TIsFront(1) and ((Not TIsMine(2)) or (Not TIsMine(4))) then ToTerritory:=1;
If TIsFront(3) and ((Not TIsMine(2)) or (Not TIsMine(5)) or (Not TIsMine(6))) then ToTerritory:=3;
If TIsFront(8) then ToTerritory:=8;
If TIsFront(7) then ToTerritory:=7;
If TIsFront(6) then ToTerritory:=6;
If TIsFront(4) then ToTerritory:=4;
If TIsFront(2) then ToTerritory:=2;
If TIsFront(5) then ToTerritory:=5;

If (COwner(3)<>0) and TIsFront(3) then ToTerritory:=3;

end;

end;


end;//>2

     UBufferSet(46, 0); //Test Ukrania if occupant is strong
     UBufferSet(47, 0); //Test Egypt if occupant is strong
     

//ANY PLAYERS


//Put in 37 given this situation #
If TIsMine(37) then
If ((ToTerritory=35) or (ToTerritory=36) or (ToTerritory=38) or (ToTerritory=33)) then 
Begin
CAnalysis(5,PT,PA,ET,EA);
     If (PT>=10) and (PT<12) then
      If ((TFrontsCount(37)>=1) or ((TFrontsCount(37)=3) and (NOT TIsMine(1)))) then 
        If NOT (TIsMine(33) and TIsMine(35) and TIsMine(36) and TIsMine(38)) then ToTerritory:=37;
end;

//Fortify N.A. a bit 
If (COwner(1)=PMe) then 
begin
CAnalysis(2,PT,PA,ET,EA);
If UBufferGet(39)>2 then If ((TArmies(1)<6) and (COwner(1)=PMe) and (COwner(3)<>PMe)) then ToTerritory:=1;
If UBufferGet(39)>2 then If ((TArmies(3)<6) and (COwner(1)=PMe) and (COwner(3)<>PMe)) then ToTerritory:=3;

If PT>1 then C:=6 else C:=12;
If UBufferGet(39)=2 then C:=4;
If ((TArmies(9)<C) and TIsFront(9) and (COwner(1)=PMe) and (COwner(2)<>PMe)) then ToTerritory:=9;
If ((TArmies(1)<4) and (COwner(1)=PMe) and (COwner(3)<>PMe)) then ToTerritory:=1;
If ((TArmies(3)<4) and (COwner(1)=PMe) and (COwner(3)<>PMe)) then ToTerritory:=3;
If ((TArmies(9)<4) and (COwner(1)=PMe) and (COwner(2)<>PMe)) then ToTerritory:=9;

If UBufferGet(39)>2 then
If  (
(TArmies(3)>trunc(1.5*TArmies(20))) and 
(TArmies(3)>30) and
(TArmies(1)>trunc(1.5*TArmies(37))) and 
(TArmies(1)>34) and
((ToTerritory=3) or (ToTerritory=1)) 
) then
Begin 
If (COwner(6)=-UBufferGet(10)) or (UBufferGet(10)>0) then C:=6;
If TArmies(2)<8+C then ToTerritory:=2;

If ( (TArmies(10)<20) and 
      TIsMine(10) and
     (TArmies(7)+TArmies(8)+TArmies(9)<20) ) then ToTerritory:=10;

If TArmies(2)<8 then ToTerritory:=2;
If TArmies(6)<4 then ToTerritory:=6;
If TArmies(5)<4 then ToTerritory:=5;
If TArmies(4)<4 then ToTerritory:=4;
end;

end;


     //Swap ToTerritory= 35 to 37/27 #
     If (ToTerritory=35) then
     If ( (COwner(5)=PMe) and 
          (TArmies(35)>3) 
         ) then 
Begin
If (COwner(1)<>PMe) and (TArmies(37)<20) then ToTerritory:=37;
         
  If URandom(0)>0.3 then
Begin
  MaxRatio:=0;
  for T:=1 to 42 do begin
    if TIsFront(T) and TIsMine(T) then begin  // territory is mine and front
      Ratio :=TPressure(T) / TArmies(T);
      if Ratio>MaxRatio then begin
        ToTerritory:=T;
        MaxRatio:=Ratio;
      end;
    end;
  end;
end;

CAnalysis(1,PT,PA,ET,EA);
If (URandom(0)>0.3) and (PT>7) and TIsFront(27) and (TArmies(27)<20) then ToTerritory:=27;
         
end;


       //Protect with 2 S.A. territories#
       CAnalysis(2,PT,PA,ET,EA);
       If ((EA>3) and (PT<>4)) or (UBufferGet(32)=1) then 
       Begin
       If ((UBufferGet(39)=2) or (UBufferGet(32)=1)) then If ((TArmies(10)=1) and TIsMine(10)) then ToTerritory:=10;
       If (PT<>4) and ((UBufferGet(39)=2) or (UBufferGet(32)=1)) then If ((TArmies(11)=1) and TIsMine(11)) then ToTerritory:=11;
       If (TArmies(12)=1) and TIsMine(12) then ToTerritory:=12;
       If (PT<>4) and ((UBufferGet(39)=2) or (UBufferGet(32)=1)) then If ((TArmies(13)=1) and TIsMine(13)) then ToTerritory:=13;
       end;


     //Put armies in Northwest Territory if someone got in North America
     If ((TContinent(ToTerritory)<>6) and (ToTerritory<>31)) then
     Begin
      CAnalysis(1,PT,PA,ET,EA);
      If ((TArmies(7)<TArmies(9)+2) and TIsMine(7) and (NOT TIsMine(9)) and (PT>6) and (COwner(2)<>PMe) and ((COwner(5)=0) or (COwner(5)=PMe)) ) then  
      Begin
      ToTerritory:=7;
      If (NOT TIsMine(9)) and (TArmies(8)<4) and (TArmies(9)>12) and (PT=8) and (TArmies(7)+TArmies(8)+PNewArmies(PMe)<TArmies(9)) then ToTerritory:=8;
      //If (NOT TIsMine(9)) and (PT=8) and (TArmies(9)>30) and (URandom(0)>0.5) and (TArmies(7)+TArmies(8)+PNewArmies(PMe)<TArmies(9)) then ToTerritory:=8;
      end;
      
      If (ET<=2) then 
       If ((TArmies(12)>TArmies(14)) or TIsMine(14) or (TIsMine(12)=False)) then
      Begin
      If ((ET<=2) and ((TIsMine(1)=False) or (TIsMine(3)=False)) and TIsMine(2) and (TArmies(2)<=TArmies(1)+TArmies(3)+1)) then ToTerritory:=2;
      
      If ET=1 then
      Begin
      If UBufferGet(39)>2 then If ((ET=1) and (TIsMine(1)=False) and (TArmies(2)>=TArmies(4))) then ToTerritory:=2;
      If ((ET=1) and (TIsMine(1)=False) and (TArmies(4)>TArmies(2))) then ToTerritory:=4;
      If ((ET=1) and (TIsMine(1)=False) and (TArmies(2)<4) and (TArmies(1)>12)) and (TArmies(2)+TArmies(4)+PNewArmies(PMe)<TArmies(1)) then ToTerritory:=2;
      If ((ET=1) and (TIsMine(1)=False) and (TArmies(4)<4) and (TArmies(1)>12)) and (TArmies(2)+TArmies(4)+PNewArmies(PMe)<TArmies(1)) then ToTerritory:=4;

      If ((ET=1) and (TIsMine(3)=False) and (TArmies(2)>=TArmies(5)) and (TArmies(2)>=TArmies(6))) then ToTerritory:=2; 
      If ((ET=1) and (TIsMine(3)=False) and (TArmies(5)>TArmies(2)) and (TArmies(5)>=TArmies(6))) then ToTerritory:=5;
      If ((ET=1) and (TIsMine(3)=False) and (TArmies(6)>TArmies(2)) and (TArmies(6)>TArmies(5))) then ToTerritory:=6;
      If ((ET=1) and (TIsMine(3)=False) and (TArmies(2)<4) and (TArmies(3)>12) and (TArmies(2)+TArmies(5)+TArmies(6)+PNewArmies(PMe)-2<TArmies(3)) ) then ToTerritory:=2;
      If ((ET=1) and (TIsMine(3)=False) and (TArmies(5)<4) and (TArmies(3)>12) and (PNewArmies(PMe)+TArmies(5)+TArmies(6)+TArmies(2)-2<TArmies(3)) ) then ToTerritory:=5;
      If ((ET=1) and (TIsMine(3)=False) and (TArmies(6)<4) and (TArmies(3)>12) and (PNewArmies(PMe)+TArmies(5)+TArmies(6)+TArmies(2)-2<TArmies(3)) ) then ToTerritory:=6;
      end;//et=1
      end;
      end;

If (Danger=0) or (COwner(1)=TOwner(Danger)) then 
Begin//danger=0


//Put armies to attack North America#
If (TIsMine(37)=False) then
Begin
CAnalysis(5,PT,PA,ET,EA);
If (((TOwner(1)=COwner(1)) and (COwner(1)<>PMe)) or (PT=11)) then
If (COwner(1)=trunc(UBufferGet(36))) or ((UBufferGet(36)=0) and (UBufferGet(39)<6)) then //##ok
Begin

If TIsMine(33) then A:=TArmies(33) else A:=0;
If TIsMine(35) then B:=TArmies(35) else B:=0;
If TIsMine(36) then C:=TArmies(36) else C:=0;
If TIsMine(38) then D:=TArmies(38) else D:=0;
T:=33;
//If ( (A>=B) and (A>=C) and (A>=D) ) then T:=33;
If ( (B>A) and (B>=C) and (B>=D) ) then T:=35;
If ( (C>A) and (C>B) and (C>=D) ) then T:=36;
If ( (D>A) and (D>B) and (D>C) ) then T:=38;

If COwner(1)=trunc(UBufferGet(36)) then X:=12 else X:=4;

     If ( TIsMine(T) and 
          ( (COwner(1)=TOwner(37)) or (TArmies(37)<14) ) and 
          (TArmies(T)<=TArmies(37)+TArmies(1)+X)
         ) then ToTerritory:=T;
end;
end;


     //Put N+X on Koryak if someone have North America #
     If ((COwner(1)=trunc(UBufferGet(36))) and (trunc(UBufferGet(36))<>0)) then X:=12 else X:=8;
     If ( TIsMine(37) and 
          (TArmies(37)<=TArmies(1)+X) and
          (COwner(1)<>0) and 
          (COwner(1)<>PMe) and
          ( (trunc(UBufferGet(36))=TOwner(1)) or ((PTerritoriesCount(TOwner(1))>9+trunc(UBufferGet(39))) and (trunc(UBufferGet(36))=0)) ) //##ok
         ) then 
         If NOT ( 
   (ToTerritory=27) and (double(PNewArmies(PMe)+TArmies(37))<(0.8*TArmies(1))) and
   (COwner(4)=COwner(1)) and 
   ((PNewArmies(PMe)+TArmies(27)>TArmies(16)) or (PNewArmies(PMe)+TArmies(27)>TArmies(15))) 
   ) then ToTerritory:=37;

     //Put in Venezuela if PNewArmies can get in North America #
     if TIsMine(10) then
     If (NOT TIsMine(37)) or (TArmies(37)-TArmies(1)<TArmies(10)-TArmies(9)) then
     If ( (COwner(1)<>0) and (COwner(1)<>PMe) and (TArmies(10)<=TArmies(9)+3) and (TArmies(10)+PNewArmies(PMe)>=TArmies(9)) ) then ToTerritory:=10;

end; //Danger

If UBufferGet(39)>2 then
Begin

     //Put everything on Indonesia if enemy is heavy on Siam
     If ((COwner(6)=PMe) and (TIsMine(31)=False) and (double(TArmies(39))<(1.4*TArmies(31)+7))) then ToTerritory:=39;

     //Put everything on Siam if enemy is heavy on China
     If ((COwner(6)=PMe) and (TIsMine(32)=False) and (TIsMine(31)=True) and (TArmies(31)+TArmies(39)<TArmies(32)+12)) then ToTerritory:=31;

end; //>2

     //Put armies in Australia if it isn't mine 
If COwner(6)<>PMe then
Begin
CAnalysis(6,PT,PA,ET,EA);

If PT>0 then
Begin 

IF ((PA<EA+4) and (PA<6)) or (UBufferGet(39)>2) then 
If UBufferGet(32)=0 then
If (NOT ((PT=3) and (PA>EA+3+4) and (UBufferGet(39)<4)) ) then
Begin

       If ( (PT=3) and (NOT (TIsMine(40) and TIsMine(42))) ) then ToTerritory:=39;
       If (( ((TContinent(ToTerritory)<>6) ) ) and TIsMine(42)) then ToTerritory:=42;
       If (( ((TContinent(ToTerritory)<>6) ) ) and TIsMine(40)) then ToTerritory:=40;
       If (( ((TContinent(ToTerritory)<>6) ) ) and TIsMine(39)) then ToTerritory:=39;
       If (( ((TContinent(ToTerritory)<>6) ) ) and TIsMine(41)) then ToTerritory:=41;
       If TIsMine(40) and TIsMine(41) and TIsMine(42) and TIsMine(31) and (NOT TIsMine(39)) then ToTerritory:=31;
end;

If (UBufferGet(39)>2) then
 If (PA>EA+7) and (TContinent(ToTerritory)=6) then
  Begin
   ToTerritory:=0;
   If TIsMine(31) and (TArmies(31)<8) then ToTerritory:=31;
  end;

end;
end;

       
       //Die hard in Asia
       If UBufferGet(12)<30 then
       If (COwner(6)<>PMe) and (UBufferGet(30)=0) then
       Begin
       CAnalysis(5,PT,PA,ET,EA);
       If PA<3 then
       Begin
       B:=0;
       For T:=21 to 38 do If TIsMine(T) then If ((B=0) or (NOT ((T=37) and (B>27)))) then  B:=T;
       If ((TArmies(B)<2) and TIsMine(B)) then 
        if PTerritoriesCount(PMe)<6 then ToTerritory:=B;
       UBufferSet(12,UBufferGet(12)+1);
       end;
       end;


       //Protect with 2 Australia territories
       CAnalysis(6,PT,PA,ET,EA);
       If (((EA>3) and (UBufferGet(30)=1)) or ((EA>3) and (EA>PNewArmies(PMe)+PA))) then
       If (PT>1) or (UBufferGet(32)=0) then
       Begin
       If ((COwner(6)<>PMe) and (TArmies(39)=1) and TIsMine(39)) then ToTerritory:=39;
       If ((COwner(6)<>PMe) and (TArmies(40)=1) and TIsMine(40)) then ToTerritory:=40;
       If ((COwner(6)<>PMe) and (TArmies(41)=1) and TIsMine(41) and ((Not TIsMine(40)) or (Not TIsMine(42))) ) then ToTerritory:=41;
       If ((COwner(6)<>PMe) and (TArmies(42)=1) and TIsMine(42)) then ToTerritory:=42;
       end;

If PTerritoriesCount(-(trunc(UBufferGet(10))))=1 then
If (COwner(6)=PMe) then
If (UBufferGet(36)=0) or (((double(PArmiesCount(trunc(UBufferGet(36))))/UBufferGet(49))<0.4) and (COwner(6)=PMe)) then
For T:=39 downto 1 do
If TOwner(T)=-(trunc(UBufferGet(10))) then
 Begin
 TPStrongestBorder(T, PMe, PT,PA);
 If PT<>0 then
  If (PA+PNewArmies(PMe)>TArmies(T)) and (PA-TArmies(T)<9) then ToTerritory:=PT;
 T:=1;
 If (ToTerritory=31) and (UBufferGet(25)=1) then Danger:=T;
 //umessage('directed attack ', ToTerritory);
 end;

   
If UBufferGet(39)=3 then C:=4 else C:=2;
If (UBufferGet(39)<4) then
 If (TFrontsCount(ToTerritory)=1) then
  If TArmies(ToTerritory)>TArmies(TFront(ToTerritory,1))+C then
   If TFront(TFront(ToTerritory,1),1)<=0 then
    For T:=42 DOWNTO 1 do
 If TIsFront(T) then
  If (T<>ToTerritory) and (Not TIsBordering(T, TFront(ToTerritory,1))) then 
Begin
//umessage('ToTerritory ',ToTerritory, ' T  ', T);
ToTerritory:=T;
T:=1;
end;

//Kill crazy bub
If (not TIsMine(trunc(UBufferGet(6)))) or (TArmies(trunc(UBufferGet(6)))<3) then UBufferSet(6,0);


    
If UBufferGet(33)=0 then
Begin//KillBubble

//Reset if the Bubble was killed
 If (TIsMine(trunc(UBufferGet(20)))=False) then 
 Begin 
 UBufferSet(24,0);
 UBufferSet(25,0); 
 end;
 
CAnalysis(1,PT,PA,ET,EA);
If (PA+2*PT<EA+ET) then Bubble:=True else Bubble:=False;
If ((PA>20) and (EA<30)) then Bubble:=False;

CAnalysis(6,PT,PA,ET,EA);
CAnalysis(5,PT2,PA2,ET2,EA2);
CAnalysis(2,PT3,PA3,ET3,EA3);

If UBufferGet(10)<0 then C:=1 else C:=20;
If UBufferGet(10)<0 then D:=1 else D:=0;

//If (PArmiesCount(PMe)<40) then

If ( (UBufferGet(25)=0) and Bubble) then 
If (PTerritoriesCount(trunc(UBufferGet(36)))<20) or (COwner(6)=-(trunc(UBufferGet(10)))) then 
 If ( 
     ((PA=0) and (PA3<5) and (PT3<2) and (UBufferGet(30)=0) and (PT2<5) and (PTerritoriesCount(PMe)<6) and (UBufferGet(39)>3))
  OR ((COwner(6)=PMe) and TIsMine(31) and (PT3<=2*D) and (PT2>1) and (PT2<5+D) and (PA2-TArmies(31)<EA2-C) and (PTerritoriesCount(PMe)<8+2*D) and (((UBufferGet(36)=0) and (EA2>25)) or (UBufferGet(10)<0)) )
  OR ((PA=0) and (PA3=0) and (UBufferGet(30)=0) and (PTerritoriesCount(PMe)<5) and (PArmiesCount(PMe)<20))
  OR (((PA=0) or (UBufferGet(32)=1)) and (COwner(2)=PMe) and (COwner(1)=0) and (TArmies(12)>7) and (TArmies(10)>5) and (PTerritoriesCount(PMe)>4) and (PTerritoriesCount(PMe)<11))
   ) then 
 Begin  //?????
 UBufferSet(25,1); //Frank in Bubble Mode
 
 If (
     ((PT=0) and (PT2=0) and (UBufferGet(24)=0)) or (Cowner(2)=PMe)
    ) then 
  Begin
  W:=1;
  UBufferSet(24,1);
  end
  else W:=27; 

 B:=0; 
 For T:=W to 38 do 
 Begin
  If T=31 then
   if COwner(6)=PMe then T:=32;
  If (T>9) and (T<13) and (COwner(2)=PMe) then T:=14;
  
  If TIsMine(T) then
   If TArmies(T)>TArmies(B) then B:=T; //Choose the territory
 end;
 
   If (PT=0) and (B>0) then
   For T:=1 to 26 do
    If TIsMine(T) and (TArmies(T)>TArmies(B)+15) then Begin B:=T; UBufferSet(24,1); end;
 
 If COwner(2)=PMe then
  Begin
  If TIsMine(3) and (TArmies(B)-TArmies(3)<2) then B:=3;
  If TIsMine(9) and (TArmies(B)-TArmies(9)<2) then B:=9;
  If TIsMine(8) and (TArmies(B)-TArmies(8)<2) then B:=8;
  If TIsMine(7) and (TArmies(B)-TArmies(7)<2) then B:=7;
  If TIsMine(4) and (TArmies(B)-TArmies(4)<2) then B:=4;
  If TIsMine(2) and (TArmies(B)-TArmies(2)<2) then B:=2;
  If TIsMine(5) and (TArmies(B)-TArmies(5)<2) then B:=5;
  end;
  
 UBufferSet(20,B);
 ////If UBufferGet(15) then 
 //umessage('BUBBLE MODE ACTIVATED, BUBBLE= ',UBufferGet(20));
 If B=0 then Begin UBufferSet(25,0); UBufferSet(24,0); end;
 
 end;//?




//Any Bubble Release
If ((UBufferGet(25)=1) and (UBufferGet(36)<>0)) then
If COwner(6)<>-(trunc(UBufferGet(10))) then
If 
(
(

( (COwner(5)=trunc(UBufferGet(36))) and (TContinent(trunc(UBufferGet(20)))<>2) and ((COwner(5)=-(trunc(UBufferGet(10)))) or (UBufferGet(10)>=0)) ) OR

( (TContinent(trunc(UBufferGet(20)))=5) and 
  (COwner(6)=PMe) and
  (PTerritoriesCount(trunc(UBufferGet(36)))>18) or
 ((COwner(4)=trunc(UBufferGet(36))) OR (COwner(3)=trunc(UBufferGet(36)))) ) OR

//( (TContinent(trunc(UBufferGet(20)))=5) and
//  (COwner(6)<>trunc(UBufferGet(36))) and  
// ((COwner(4)=trunc(UBufferGet(36))) AND (COwner(3)=trunc(UBufferGet(36))) AND (COwner(6)<>COwner(3))) ) OR

( (TContinent(trunc(UBufferGet(20)))=5) and (COwner(6)<>-(trunc(UBufferGet(10)))) and
  (COwner(6)<>trunc(UBufferGet(36))) and 
 ((COwner(1)=trunc(UBufferGet(36))) AND (COwner(3)=trunc(UBufferGet(36)))) )

) AND

( ( (PArmiesCount(PMe)>60) or (TArmies(trunc(UBufferGet(20)))>24) ))

)
then
Begin 
UBufferSet(24,0);
UBufferSet(25,0);
////umessage(' Bubble Released - someone strong');
end;

If ((UBufferGet(25)=1) and (PT>0) and (PT<4)) then
Begin 
UBufferSet(24,0);
UBufferSet(25,0);
end;


//Asia Bubble Release
If ((UBufferGet(25)=1) and (UBufferGet(24)=0)) then
Begin
B:=200;
If PArmiesCount(-(trunc(UBufferGet(10))))>30 then C:=15 else C:=0;
If (COwner(6)=PMe) then B:=50+C+EA2-3*PT2;
If ((COwner(6)=PMe) and (EA2<30) and (TArmies(trunc(UBufferGet(20)))>2*EA2) ) then B:=0;
If ( TContinent(trunc(UBufferGet(20)))=6 ) then B:=EA; //Release if in Australia
If (COwner(6)=-(trunc(UBufferGet(10)))) and (TContinent(trunc(UBufferGet(20)))=5) then B:=500;

AsiaRelease:=B;
end;


//Release world Bubble
If ( (UBufferGet(24)=1) and (UBufferGet(25)=1) ) THEN 
Begin
CAnalysis(TContinent(trunc(UBufferGet(20))),PT,PA,ET,EA);
CAnalysis(1,PT2,PA2,ET2,EA2);
     If (TContinent(trunc(UBufferGet(20)))=2) then J:=5 else J:=20;
     If (TContinent(trunc(UBufferGet(20)))=1) and (EA2<25) then J:=5;
     If ((TContinent(trunc(UBufferGet(20)))<>3) and (TContinent(trunc(UBufferGet(20)))<>4)) then B:=EA+J else B:=400;
     If PA2>EA2+12 then B:=0;
     If (PT2>6) and (COwner(2)=PMe) then B:=0;
     If UBufferGet(39)<4 then J:=J-7;

end;

BypassRelease:=False;
If (NOT ((UBufferGet(20)=30) or (UBufferGet(20)=32)) ) then
If ((UBufferGet(24)=0) and (UBufferGet(25)=1)) then
Begin
CAnalysis(6,PT,PA,ET,EA);
If ( NOT(PProgram(COwner(6))=PProgram(PMe))) and ((UBufferGet(29)=1) ) then //Cooperative
IF ( ( (TArmies(trunc(UBufferGet(20)))>TArmies(31)+EA+10) and (COwner(6)<>PMe) ) OR
     ( (b=31) and (TArmies(trunc(UBufferGet(20)))>EA+10) and (COwner(6)<>PMe) ) 
    ) then BypassRelease:=True;
end;

//The Release
If ( (TArmies(trunc(UBufferGet(20)))>B) and (UBufferGet(25)=1) and (BypassRelease=False)) then 
Begin 
UBufferSet(24,0);
UBufferSet(25,0);


end;
 

 

//World Bubble 

//Make the World Bubble an Asia bubble if it get in Asia
If (TContinent(trunc(UBufferGet(20)))=5) then UBufferSet(24,0);

//Make the Asia Bubble a World Bubble 
If (UBufferGet(24)=0) then
If (UBufferGet(25)=1) then
Begin
CAnalysis(TContinent(trunc(UBufferGet(20))),PT,PA,ET,EA);
If ( (EA>100) and 
     (UBufferGet(24)=0) and 
     (COwner(6)<>0) and 
     (COwner(6)<>PMe) ) then UBufferSet(24,1);

If ((TContinent(trunc(UBufferGet(20)))<>5) and 
    (TContinent(trunc(UBufferGet(20)))<>6)) then UBufferSet(24,1);
    
CLeader(5,LP,LT,LA);
If (COwner(6)=LP) and (LT=11) and (LA>TArmies(trunc(UBufferGet(20)))+15) then UBufferSet(24,1);

end;    
 
////umessage('W   ', W, '   UBufferGet(20) ', UBufferGet(20), '   UBufferGet(24) ', UBufferGet(24), '   UBufferGet(25) ', UBufferGet(25));



//put in bubble
If UBufferGet(25)=1 then
begin
If COwner(1)=trunc(UBufferGet(36)) then C:=15 else C:=10;
////If UBufferGet(15) then //umessage('before Bubble ToTerritory=',ToTerritory);
 If (NOT (     ( ((ToTerritory=31) and ProtectAustralia) or 
((ToTerritory=39) and ((TArmies(39)<TArmies(31)+15) or ProtectAustralia)) ) or
              ( (((ToTerritory=37) and (TArmies(1)-TArmies(37)<C)) or (((ToTerritory=35) or (ToTerritory=36) or (ToTerritory=38)) and (TArmies(37)<C))) 
              and 
              ((Danger=0) or (COwner(1)=TOwner(Danger))) 
              and
              (((COwner(1)=trunc(UBufferGet(36))) and (UBufferGet(36)<>0)) 
              OR ((COwner(1)<>0) and (PArmiesCount(COwner(1))>40) and (UBufferGet(36)=0))) )  //##=0 ok
         )
     ) then
  Begin 
  CLeader(2, T2,T,A);
  If (T2=PMe) and (Not TIsMine(14)) and (TArmies(12)-TArmies(14)<10) then C:=7 else C:=12;
  If (T2=PMe) and (Not TIsMine(9)) and (TArmies(10)-TArmies(9)<10) then C:=7;
  If (T2=PMe) and (COwner(1)<>0) and (COwner(1)<>PMe) then C:=4;
  If (T2<>PMe) or (TArmies(trunc(UBufferGet(20)))<C) then ToTerritory:=trunc(UBufferGet(20));
  UBufferSet(21,0);
  end;

D:=20;
For T:=38 DOWNTO 15 do
 If (TArmies(T)>20) then
 If Not TIsMine(T) then
 If (TArmies(T)<30) then
  If (TOwner(T)=-(trunc(UBufferGet(10)))) or (T>=30) then 
  Begin D:=TArmies(T); T:=15; end;
  

  //Bubble restraint
  If TIsMine(31) then
  If ToTerritory=trunc(UBufferGet(20)) then
  //if TContinent(trunc(UBufferGet(20)))>2 then
  If NOT ((ToTerritory=27) and (UBufferGet(36)<>0) and ((COwner(3)=trunc(UBufferGet(36))) or (COwner(4)=trunc(UBufferGet(36))))) then
   If (COwner(6)=PMe) then
    If (TArmies(trunc(UBufferGet(20)))>D+3) and (UBufferGet(10)<0) then Toterritory:=31;
  
  CLeader(2, T2,T,A);
  If TArmies(31)>10 then C:=7 else C:=6;
  If (UBufferGet(32)=1) and (T2=PMe) and (TArmies(12)>10) and (TArmies(10)>7) then C:=11;
  If TIsMine(31) and (TArmies(31)<2) then C:=1;
  If TArmies(trunc(UBufferGet(20)))<C then ToTerritory:=trunc(UBufferGet(20)); //Protects the bubble
end;

end; //KillBubble



//#######Aust. - N.A. Attack  
If TIsMine(31) then
If COwner(6)=PMe then
If (TArmies(31)>70-PTerritoriesCount(trunc(UBufferGet(36)))) or (UBufferGet(9)<>0) then
If (NOT TIsMine(32)) and (NOT TIsMine(33)) and (NOT TIsMine(37)) and (NOT TIsMine(1)) then
If (UBufferGet(10)<0) or ((PTerritoriesCount(COwner(1))>22) and (COwner(1)<>PMe)) then

Begin
CAnalysis(1,PT,PA,ET,EA);
If ((COwner(1)<>0) and (trunc(UBufferGet(36))=COwner(1))) and (PArmiesCount(COwner(1))>60) 
then C:=10+3*trunc(UBufferGet(39)) else C:=36+3*trunc(UBufferGet(39));
If (PTerritoriesCount(COwner(1))>25) then C:=0;
D:=0;
If TOwner(20)=-(trunc(UBufferGet(10))) then D:=TArmies(20)-5;
If TOwner(10)=-(trunc(UBufferGet(10))) then D:=TArmies(10)-5;


if (double(TArmies(32))+TArmies(33)+TArmies(37)<(double(TArmies(31))/3)) or ((COwner(1)<>0) and (trunc(UBufferGet(36))=COwner(1))) then
 If TArmies(32)+TArmies(33)+TArmies(37)+TArmies(10)+TArmies(20)+EA+C-D<TArmies(31) then 
Begin
ToTerritory:=31;
end;
end;

//######Aust. - S.A. Attack  
If TIsMine(31) then
If (TArmies(31)>50) or (UBufferGet(9)<>0) then
If (NOT TIsMine(30)) and (NOT TIsMine(27)) and (NOT TIsMine(26)) then
If ((COwner(4)=COwner(3)) and ((COwner(2)=COwner(1)) or (COwner(2)=COwner(3))) and (COwner(2)<>PMe) and (COwner(2)<>0) and (COwner(2)<>PMe)) then
If PTerritoriesCount(COwner(2))>20 then 

Begin
CAnalysis(2,PT,PA,ET,EA);
If PTerritoriesCount(COwner(2))>29 then C:=7 else C:=20;
If TArmies(30)+TArmies(27)+TArmies(26)+TArmies(14)+EA<TArmies(31)-C-3*trunc(UBufferGet(39)) then
Begin
ToTerritory:=31;
end;
end;



If (UBufferGet(9)=33) and TIsMine(32) then ToTerritory:=32;

If (TIsMine(ToTerritory)=False) then
begin
//umessage('Placement BUG FOUND: Initial ToTerritory ',ToTerritory);
//UBufferSet(15, 1);

X:=0;
For T:=1 to 42 do 
 If ((TArmies(T)>X) and TIsMine(T) and TIsFront(T)) then Begin Y:=T; X:=TArmies(T); end;
ToTerritory:=Y;

  If TIsMine(27) then ToTerritory:=27;
  //umessage('Placement BUG FOUND: Final ToTerritory ',ToTerritory);
end;

////If UBufferGet(15) then //umessage('Final ToTerritory ',ToTerritory);

end;  //Placement

// procA
procedure Attack(var FromTerritory, ToTerritory: integer);
var
  EnemyC, T, T2, B, B2, C, Diff, BestDiff: integer;
  PT, PA, ET, EA, X, Y, XX, YY: integer;
  Ratio: double;
  SMALL, ALLFRONTS, ONEFRONTS, CBONUS, MINARMIES: integer;
  R, A2, A3: boolean;
  a1,a4,PT2,PA2, EA2,ET2,J,A,D,PlayerStrong,W,LPa,LTa,LAa: integer;
  FORCE, NEWRATIO: double;
  NormalBubble, GO, BypassStruggler, BypassBubble, GOAsia, attack3: boolean;

  CForce, P: integer;
  Points, MaxPoints: double;
  Vexer: integer;

  //STRUGGLER
  F,FCount: integer;
  Value,MaxValue: double;
  Label Bubble1, TryAsia;

begin
  // reset kill mode if the game no longer has human players
  if UBufferGet(98) > 0 then begin
   if GameHasNoHumans then UBufferSet(98, 0);
  end;

  // check for kill player mode
  if (UBufferGet(99) = 1) or (UBufferGet(98) > 0) then begin
    KillPlayer_Attack(FromTerritory, ToTerritory);
    If (not ((FromTerritory = 0) and (UBufferGet(98) > 0))) then exit;
  end;

BypassStruggler:=False;
begin //###Wyrm 

  SMALL:=-9999;       // CONSTANTS SECTION
  FORCE:=0.95;         // smaller FORCE than in PLACEMENT procedure to encourage attacks
  MINARMIES:=2;
  ALLFRONTS:=10;
  ONEFRONTS:=1;
  CBONUS:=5;          // bonus for reinforcing territories in current target continent
  NEWRATIO:=0.5;      // %-age of new armies that can go towards an out-of-continent attack
  
  
  //##############
  //CAnalysis(5, PT, PA, ET, EA);
  //If EA<10 then FORCE:=0.85 else FORCE:=0.95;
  //#############
  

  EnemyC:=TargetCattack(small);
  PT:=0;
  PA:=0;
  ET:=0;
  EA:=0;
  CAnalysis(EnemyC, PT, PA, ET, EA);

  BestDiff:=0; // will hold maximum number of armies controlled by leading player B
  for T:=1 to 10 do
    if (PActive(T)) and (T<>PMe) then
      if (PArmiesCount(T)>BestDiff) then
        begin
          BestDiff:=PArmiesCount(T);
          B:=T;
        end;


  if ((PA-PT)>trunc((double(MINARMIES)+ET+EA)/FORCE)) or (not SConquest) or (COwner(EnemyC)>0) then
    begin
      ToTerritory:=TargetTattack(enemyc, small, allfronts, onefronts, force);
      if (ToTerritory<>0) then
        begin
          // calculate the correct territory to attack from
          // 1)  weakest 1-front if ToTerritory armies > 2, otherwise strongest 1-front
          // 2)  highest TArmies-TPressure.  This may not be the best
          BestDiff:=SMALL*5;
          for B:=1 to TBordersCount(ToTerritory) do
            begin
              T:=TBorder(ToTerritory,B);
              if TIsMine(T) and (TArmies(T)>1) and ((TArmies(T)>2) or (TArmies(ToTerritory)=1)) then // no attacks ever with 2 or less armies
                begin
                  Diff:=TArmies(T)-(TPressure(T) div 3); // stress armies more than pressure
                  if (TArmies(T)<4) and (TArmies(ToTerritory)>1) then
                    Diff:=Diff+SMALL*2; // discourage these attacks with less than 4 armies
                  if (TFrontsCount(T)=1) then
                    begin
                      if (TArmies(ToTerritory)>2) then
                        Diff:=Diff-SMALL-TArmies(T)*2  // weakest 1-front will be picked
                      else
                        Diff:=Diff-SMALL; // strongest 1-front will be picked
                    end;
                  if (Diff>BestDiff) then
                    begin
                      BestDiff:=Diff;
                      FromTerritory:=T;
                    end;
                end;
            end;
          BestDiff:=(MyTPressure(ToTerritory,ALLFRONTS))-(TArmies(ToTerritory));
          if (BestDiff<0) then
            begin
//              //If UBufferGet(15) then //umessage('About to abort an attack on target continent ',EnemyC,' from ',FromTerritory,' to ',ToTerritory,' with enemy armies ',TArmies(ToTerritory),' and MyTPressure ',MyTPressure(ToTerritory,ALLFRONTS),' for a total negative difference of ',BestDiff);
//              //If UBufferGet(15) then //umessage('double checking - enemy armies ',TArmies(ToTerritory),' and MyTPressure ',MyTPressure(ToTerritory,ALLFRONTS),' for a total negative difference of ',BestDiff);
              FromTerritory:=0; // abort attacks that won't work
            end;
        end;
    end;
    
    
    
//#######ATTACK RULES 
////If UBufferGet(15) then //umessage('INITIAL: ToTerritory:=',ToTerritory, '  FromTerritory:=', FromTerritory, '  SConquest= ', SConquest);



//Says the number of players and TotalArmies and PlayerStrong
UBufferSet(10,0);
//A:=0;
B:=0;
    R:=False;
    PlayerStrong:=0;
    For J:=1 to 10 do
    If PTerritoriesCount(J)>0 then
    Begin

If PTerritoriesCount(J)>0 then D:=D+1;

B:=B+PArmiesCount(J);

if palive(J) then if ( pos('australian', lowercase(PProgram(J))) > 0 ) then UBufferSet(10,-J);
 
     A3:=False; 
     A2:=False;
     If J<>PMe then
     If NOT R then
     For C:=1 to 6 do
      Begin
       If A3 then A2:=True;
       If COwner(C)=J then A3:=True else A3:=False;
       If (A2 and A3 ) then Begin R:=True; PlayerStrong:=J; C:=6; end;
      end;
    end;
    
    If R then UBufferSet(37, 1) else UBufferSet(37,0);
    If R then UBufferSet(36, PlayerStrong) else UBufferSet(36, 0); 
UBufferSet(39,D);
UBufferSet(49,B);


//Release world Bubble
If (UBufferGet(25)=1) then
Begin
CAnalysis(TContinent(trunc(UBufferGet(20))),PT,PA,ET,EA);
CAnalysis(1,PT2,PA2,ET2,EA2);
If ( (UBufferGet(24)=1) and (UBufferGet(25)=1) ) THEN 
Begin
     B:=trunc(0.6*UBufferGet(49));
     If (TContinent(trunc(UBufferGet(20)))=2) then J:=5 else J:=20;
     If ((TContinent(trunc(UBufferGet(20)))<>3) and (TContinent(trunc(UBufferGet(20)))<>4) and (TContinent(trunc(UBufferGet(20)))<>5)) then B:=EA+J;      
     If (COwner(6)=-(trunc(UBufferGet(10)))) and (TContinent(trunc(UBufferGet(20)))=5) then B:=500;
     If (PA2>EA2+14) or (UBufferGet(39)=2) then B:=0;

//The Release
If ( (TArmies(trunc(UBufferGet(20)))>B) and (UBufferGet(25)=1) ) then 
Begin 
UBufferSet(24,0);
UBufferSet(25,0);
////umessage(' Bubble Released B= ', B);
end;

end;
end;

    
If ((FromTerritory=0) or (ToTerritory=0)) then 
     begin
      FromTerritory:=0;
      ToTerritory:=0;
     end;


//Stop big attacks
If UBufferGet(39)<5 then
If TArmies(Toterritory)>20 then
If (TArmies(Toterritory)>(PArmiesCount(PMe) div 2)) and 
   (UBufferGet(36)<>0) and
   (TOwner(Toterritory)<>trunc(UBufferGet(36))) then 
If Toterritory<39 then
   FromTerritory:=0;

CAnalysis(1,PT,PA,ET,EA); 
//Don't attack Koryak from Alaska if not needed
If ((FromTerritory=1) and (ToTerritory=37)) then
Begin
If TOwner(Toterritory)<>-(trunc(UBufferGet(10))) then
 If (UBufferGet(39)>2) and (( ((TArmies(1)<20) or (TArmies(37)>3)) and (COwner(5)=0) and (PT>=6) and (PArmiesCount(PMe)<160) )) then FromTerritory:=0;
 
 If SConquest then
  If TOwner(37)<>-(trunc(UBufferGet(10))) then
   If TOwner(37)<>COwner(6) then
    If TOwner(37)<>trunc(UBufferGet(36)) then
     If COwner(5)=0 then FromTerritory:=0;
end;

If (SConquest and (UBufferGet(39)=2)) then GOAsia:=False else GOAsia:=True;
CAnalysis(5,PT,PA,ET,EA);
   
 
If (((ET<=3) and (ET>0) and (EA<14)) OR (PA>2*EA+10+2*trunc(UBufferGet(39)))) then GOAsia:=True;

If COwner(6)<>PMe  then GOAsia:=False;

//Do not make weak attacks in Asia 
If SConquest then
If (TOwner(ToTerritory)<>-(trunc(UBufferGet(10)))) then //Lame hate
If (UBufferGet(39)>3) then
If ((TContinent(ToTerritory)=5) and 
   (TContinent(FromTerritory)=5) and
   (TArmies(FromTerritory)<4) and 
   (ET>2) and 
   (EA>5) 
   ) then 
   Begin
   FromTerritory:=0;

   //If UBufferGet(15) then //umessage('Weak attack blocked GOAsia ',GOAsia);
   end;

If SConquest and (EA>PA-TArmies(31)-12) and (UBufferGet(39)>3) then GOAsia:=False;
   
//Do not Attack NA if I am weak in SA
If UBufferGet(39)>3 then
If ((COwner(2)=PMe) and (COwner(1)=0) and (PArmiesCount(PMe)<100) and 
    (FromTerritory=10) and (ToTerritory=9) and (TArmies(12)<20)) then FromTerritory:=0;

//Do not attack S.A. from N.A. if strong
If FromTerritory=9 then
If ToTerritory=10 then
Begin
CAnalysis(2,PT,PA,ET,EA);
 If ((COwner(1)=PMe) and ((TArmies(12)>TArmies(9)) or (TArmies(11)>TArmies(9)))) then FromTerritory:=0;
 If ( (COwner(2)=0) and (EA>10) and ((EA+double(TArmies(14))/3 > double(TArmies(9))) OR (EA>30)) and (PA=0) ) then FromTerritory:=0;

end;

 
 
//Attack North Africa from Brazil only if Africa holder is strong
If ( (FromTerritory=12) and (ToTerritory=14) and 
     ((PArmiesCount(PMe)<210) or ((PTerritoriesCount(PMe)<22) and (PArmiesCount(PMe)<300))) ) then
BEGIN
 If ( (COwner(4)=0) or 
(
((COwner(4)<>0) and (PTerritoriesCount(COwner(4))<13)) or

(((COwner(4)<>0) and (PTerritoriesCount(COwner(4))<15)) and (PArmiesCount(-(trunc(UBufferGet(10))))>PArmiesCount(PMe)) and (TOwner(14)<>-(trunc(UBufferGet(10)))))
)

 ) then 
      Begin
       FromTerritory:=0; 
       ToTerritory:=0; 
       //If UBufferGet(15) then //umessage('Brazil->Africa attack blocked');
      end;

CLeader(5,LPa,LTa,LAa); 
If ( (COwner(4)<>0) and (COwner(4)<>trunc(UBufferGet(36))) and (COwner(6)<>COwner(4)) and 
  (COwner(6)=LPa) and (LTa>8) and (COwner(6)<>0) and (PTerritoriesCount(COwner(4))<15) ) then FromTerritory:=0;
  
END;

//Brazil to North Africa
If FromTerritory=12 then
If ( (UBufferGet(39)>2) and
    (ToTerritory=14) and 
    (TArmies(14)>25) and 
    (trunc(UBufferGet(36))<>TOwner(14)) and
  ( ((PArmiesCount(PMe)<200) AND (UBufferGet(10)>=0)) OR
    ((PArmiesCount(PMe)<150+PArmiesCount(-(trunc(UBufferGet(10))))) AND (UBufferGet(10)<0)) )
    ) then 
    Begin
    CLeader(4,LPa,LTa,LAa); 
    If (LPa<>PMe) or (LTa<5) then FromTerritory:=0;
    end;

  
If UBufferGet(39)>3 then
 Begin
    If ((FromTerritory=37) and (ToTerritory=1)) then 
 If ( (COwner(1)=0) and (PArmiesCount(PMe)<130) and (COwner(5)=0) and 
      ((PTerritoriesCount(PMe)>10) or (COwner(6)=PMe)) ) then 
     begin
      FromTerritory:=0;
      ////If UBufferGet(15) then //umessage('Attack to Alaska from Koryak stopped');
     end;
 end;

 
    //Don't attack Ukrania or Southern Europe if none holds Europe
    CAnalysis(3,PT,PA,ET,EA);
    Begin
     If ((PArmiesCount(PMe)<170) or (PTerritoriesCount(PMe)<16)) then
      If ( NOT (((PT>=4) and (PA>15) and (EA<25)) or (COwner(4)=PMe) or ((COwner(5)=PMe) and (COwner(3)<>0))) ) then 
       If ( ((ToTerritory=22) or (ToTerritory=26)) and
      ((FromTerritory=27) or (FromTerritory=28) or (FromTerritory=29)) and 
      (COwner(3)=0) ) then 
      Begin
      FromTerritory:=0; 
      ToTerritory:=0;
      GOAsia:=True;
      If SConquest and (EA>PA-TArmies(31)-10) and (UBufferGet(39)>3) then GOAsia:=False;
      //If UBufferGet(15) then //umessage('Europe attack blocked - no owner');
      end;
    end;

UBufferSet(46, 0);
If COwner(3)<>0 then
 If ( ((PArmiesCount(TOwner(22))>35) or (PTerritoriesCount(TOwner(22))>=12)) and (COwner(3)<>PMe) ) then UBufferSet(46, 1); // Europe holder is strong

    //If held, don't attack Ukrania or Southern Europe if player is weak
    If (UBufferGet(46)<>1) then
    If COwner(5)<>PMe then
     If ( (PArmiesCount(PMe)<130) or (PTerritoriesCount(PMe)<16) ) then
      If ( ((ToTerritory=22) or (ToTerritory=26)) and
      ((FromTerritory=27) or (FromTerritory=28) or (FromTerritory=29)) and 
      (COwner(3)<>0) ) then 
      Begin
      FromTerritory:=0; 
      GOAsia:=True;
      If SConquest and (EA>PA-TArmies(31)-10) and (UBufferGet(39)>3) then GOAsia:=False;
      //If UBufferGet(15) then //umessage('Europe attack blocked - still weak' );
      end;

//Don't attack Egypt or East Africa If no player holds Africa
CAnalysis(4,PT,PA,ET,EA);
IF (PT<=3) then //(PTerritoriesCount(PMe)<=18)
     If ((PArmiesCount(PMe)<170) and (PTerritoriesCount(PMe)<24)) then
      If ( ((ToTerritory=15) or (ToTerritory=16)) and 
           (COwner(4)=0) and 
           (FromTerritory=27) ) then 
      Begin
      FromTerritory:=0; 
      ToTerritory:=0;
      //If UBufferGet(15) then //umessage('Africa attack blocked - no owner');
      end;
If ( ((PArmiesCount(TOwner(15))>30) or (PTerritoriesCount(TOwner(15))>12)) and (COwner(4)<>0) and (COwner(4)<>PMe) ) then UBufferSet(47, 1) else UBufferSet(47, 0);// Egypt holder is strong

//In holding, dont't attack Egypt or East Africa If the player is weak
     If PArmiesCount(PMe)<140 then
      If ( ((ToTerritory=15) or (ToTerritory=16)) and 
           (FromTerritory=27) and
           (COwner(4)<>0) and 
           (UBufferGet(47)<>1) ) then 
      Begin
       FromTerritory:=0; 
       ToTerritory:=0; 
       //If UBufferGet(15) then //umessage('Africa attack blocked - still weak');
      end;


  

 // attack Australia with China if viable#
    If ( ((TArmies(32)>TArmies(30)) and TIsMine(30)) or (TIsMine(30)=False) ) then
      If ( (TIsMine(32)=True) and 
           (TIsMine(31)=False) and 
           (TIsMine(39)=False) and 
           (TIsMine(40)=False) and
           (TIsMine(41)=False) and
           (TIsMine(42)=False) and
           (TArmies(31)+TArmies(39)+TArmies(40)+TArmies(41)<TArmies(32))
          ) then 
      Begin
      ToTerritory:=31;
      FromTerritory:=32;
      end;
      
      B:=5;
      //attack India from Middle East if can get Indonesia later#
      If ( not (PProgram(COwner(6))=PProgram(PMe)) and (UBufferGet(29)=0)) then //Cooperative AU
      If ((TArmies(27)-B>TArmies(30)+TArmies(31)+TArmies(39)) and
          (TIsMine(27)=True) and 
          (TIsMine(30)=False) and 
          (TIsMine(31)=False) and
          (TIsMine(39)=False) 
         ) 
        then
          Begin
          ToTerritory:=30;
          FromTerritory:=27;
          B:=0;
          end;
  
      //Attack Siam from Indonesia 
      If (TIsMine(31)=False) then
      If (COwner(6)=PMe) then
      If (( (PTerritoriesCount(PMe)<10) and (FromTerritory=0) and (TArmies(39) div 3>=TArmies(31)) and ((TArmies(39)>15) or ((TArmies(39)>3) and (NOT SConquest))))) OR
         ((TArmies(39)>TArmies(31)+4) and (UBufferGet(39)=2))  then 
        Begin
        ToTerritory:=31;
        FromTerritory:=39;
        //If UBufferGet(15) then //umessage('Forced attack from Indonesia' );
        end;
      
      //Do not Attack Siam if a stronger force is waiting
       If ( (FromTerritory=39) and 
            (ToTerritory=31) and 
            (TIsMine(32)=False) and
            (TArmies(32)>TArmies(39)-TArmies(31)) 
          ) then FromTerritory:=0;

       If ( (FromTerritory=39) and 
            (ToTerritory=31) and 
            (TIsMine(30)=False) and
            (TArmies(30)>TArmies(39)-TArmies(31)) 
          ) then FromTerritory:=0;
      
If not TIsMine(31) then
Begin
      //attack Siam from India and China if can get Indonesia
      if ToTerritory<>31 then
      If ( (TArmies(30)+TArmies(32)-4>(trunc(0.8*(TArmies(31)+TArmies(39))))) and 
           (TArmies(30)+TArmies(32)>5) and
            TIsMine(30) and TIsMine(32) and (TIsMine(31)=False) ) then
      Begin
       If (TArmies(30)>TArmies(32)) then 
        Begin
        ToTerritory:=31;
        FromTerritory:=30;
        //If UBufferGet(15) then //umessage('attack from India to Siam' );
        end;
       If (TArmies(32)>=TArmies(30)) then
        Begin
        //If UBufferGet(15) then //umessage('attack from China to Siam ' );
        ToTerritory:=31;
        FromTerritory:=32;
        end;
      end;
      
      If (TIsMine(29) and TIsMine(33) and (TArmies(29)>TArmies(33))) then T:=29 else T:=33;
      If ((T=29) and (TIsMine(30)=False) and (TArmies(30)<TArmies(32))) then C:=30 else C:=32;
      
      If (TIsMine(T) and 
         (TIsMine(C)=False) and 
         (COwner(6)<>PMe) and
         (TArmies(T)>TArmies(C)+TArmies(31)+TArmies(39)+3)) then
         Begin
         ToTerritory:=C;
         FromTerritory:=T;
         UBufferSet(13,ToTerritory);
         end;
end;  

      // attack Indonesia from Siam if ratio <.8
      If not TIsMine(39) then
      If ( (COwner(6)<>0) and (TArmies(31)>5) and 
           (TArmies(31)> trunc(0.8*(TArmies(39)+TArmies(40)+TArmies(41)+TArmies(42))) ) and 
           TIsMine(31)) then
      If (PArmiesCount(PMe)-TArmies(31)>10) or 
         (PArmiesCount(-(trunc(UBufferGet(10))))<30) or 
         (PArmiesCount(PMe)-(0.8*double(TArmies(39))+TArmies(40)
                  +TArmies(41)+TArmies(42))>double(PArmiesCount(-(trunc(UBufferGet(10))))-15)) then
       Begin
       //If UBufferGet(15) then //umessage('attack from Siam to Indonesia ' );
       ToTerritory:=39;
       FromTerritory:=31;
       UBufferSet(25,0); //Frank is not in Bubble Mode
       end;

If COwner(6)=0 then
If TIsMine(39) or TIsMine(40) or TIsMine(41) or TIsMine(42) then
Begin

//Initiate attack to New Guinea if armies in Indonesia are > the sum of rest in Australia
If TIsMine(40) then a1:=0 else a1:=TArmies(40);
If TIsMine(41) then a4:=0 else a4:=TArmies(41);
If ((TArmies(39)>1) and 
    (a1+a4+TArmies(42)<TArmies(39)) and
    TIsMine(39) and 
    (TIsMine(42)= False)
   ) then
 Begin
 ToTerritory:=42;
 FromTerritory:=39;
 BypassStruggler:=True;
 end;
 
     //Initiate attack to Western Australia if armies in Indonesia are > the sum of rest in Australia
     If (FromTerritory=0) or (TContinent(ToTerritory)<>6) then 
     Begin
If TIsMine(42) then a1:=0 else a1:=TArmies(42);
If TIsMine(41) then a4:=0 else a4:=TArmies(41);
If ((TArmies(39)>1) and 
    (a1+a4+TArmies(40)<TArmies(39)) and
    TIsMine(39) and 
    (TIsMine(40)= False)
   ) then
 Begin
 ToTerritory:=40;
 FromTerritory:=39;
 BypassStruggler:=True;
 end;
end;


     //Initiate attack to Western Australia if armies in 41 are > the sum of rest in Australia
     If (FromTerritory=0) or (TContinent(ToTerritory)<>6) then
     Begin
If TIsMine(42) then a1:=0 else a1:=TArmies(42);
If TIsMine(39) then a4:=0 else a4:=TArmies(39);

If ((TArmies(41)>1) and 
    (a1+a4+TArmies(40)<TArmies(41)) and
    TIsMine(41) and 
    (TIsMine(40)= False)
   ) then
 Begin
 ToTerritory:=40;
 FromTerritory:=41;
 BypassStruggler:=True;
 end;
end;
 
     //Attack to Indonesia from Western Australia if armies > the sum of EA in Australia
     If (FromTerritory=0) or (TContinent(ToTerritory)<>6) then 
     Begin
If TIsMine(42) then a1:=0 else a1:=TArmies(42);
If TIsMine(41) then a4:=0 else a4:=TArmies(41);
If ((TArmies(40)>1) and 
    (a1+a4+TArmies(39)<TArmies(40)) and
    TIsMine(40) and 
    (TIsMine(39)= False)
   ) then
 Begin
 ToTerritory:=39;
 FromTerritory:=40;
 end;
end;


//Attack to Eastern Australia from New Guinea if armies > the sum of EA in Australia
     If (FromTerritory=0) or (TContinent(ToTerritory)<>6) then
     Begin
If TIsMine(39) then a1:=0 else a1:=TArmies(39);
If TIsMine(40) then a4:=0 else a4:=TArmies(40);
If ((TArmies(42)>1) and 
    (a1+a4+TArmies(41)<TArmies(42)) and
     TIsMine(42) and 
    (TIsMine(41)= False)
   ) then
 Begin
 ToTerritory:=41;
 FromTerritory:=42;
 BypassStruggler:=True;
 end;
end;


     //Attack to Eastern Australia from Western Australia if armies > the sum of EA in Australia
     If (FromTerritory=0) or (TContinent(ToTerritory)<>6) then
     Begin
If TIsMine(39) then a1:=0 else a1:=TArmies(39);
If TIsMine(42) then a4:=0 else a4:=TArmies(42);
If ((TArmies(40)>1) and 
    (a1+a4+TArmies(41)<TArmies(40)) and
    TIsMine(40) and 
    (TIsMine(41)= False)
   ) then
 Begin
 ToTerritory:=41;
 FromTerritory:=40;
 BypassStruggler:=True;
 end;
end;


     //Attack to Western Australia from Eastern Australia if armies > the sum of EA in Australia
     If (FromTerritory=0) or (TContinent(ToTerritory)<>6) then 
     Begin
If TIsMine(39) then a1:=0 else a1:=TArmies(39);
If TIsMine(42) then a4:=0 else a4:=TArmies(42);
If ((TArmies(41)>1) and 
    (a1+a4+TArmies(40)<TArmies(41)) and
    TIsMine(41) and 
    (TIsMine(40)= False)
   ) then
 Begin
 ToTerritory:=40;
 FromTerritory:=41;
 BypassStruggler:=True;
 end;
end;


     If (FromTerritory=0) or (TContinent(ToTerritory)<>6) then
     Begin
If TIsMine(39) then a1:=0 else a1:=TArmies(39);
If TIsMine(40) then a4:=0 else a4:=TArmies(40);
If ((TArmies(41)>1) and 
    (a1+a4+TArmies(42)<TArmies(41)) and
    TIsMine(41) and 
    (TIsMine(42)= False)
   ) then
 Begin
 ToTerritory:=42;
 FromTerritory:=41;
 BypassStruggler:=True;
 end;
end;


     //Attack to New Guinea from Western Australia if armies > the sum of EA in Australia
     If (FromTerritory=0) or (TContinent(ToTerritory)<>6) then 
     Begin
If TIsMine(39) then a1:=0 else a1:=TArmies(39);
If TIsMine(41) then a4:=0 else a4:=TArmies(41);
If ((TArmies(40)>1) and 
    (a1+a4+TArmies(42)<TArmies(40)) and
    (TIsMine(40)= True) and 
    (TIsMine(42)= False)
   ) then
 Begin
 ToTerritory:=42;
 FromTerritory:=40;
 BypassStruggler:=True;
 end;
end;

//42>40
If (FromTerritory=0) or (TContinent(ToTerritory)<>6) then
Begin
If TIsMine(39) then a1:=0 else a1:=TArmies(39);
If TIsMine(41) then a4:=0 else a4:=TArmies(41);
If ((TArmies(42)>1) and 
    (a1+a4+TArmies(40)<TArmies(42)) and
    TIsMine(42) and 
    (TIsMine(40)= False)
   ) then
 Begin
 ToTerritory:=40;
 FromTerritory:=42;
 BypassStruggler:=True;
 end;
end;

//42>39
     If (FromTerritory=0) or (TContinent(ToTerritory)<>6) then 
Begin
If TIsMine(30) then a1:=0 else a1:=TArmies(30);
If TIsMine(41) then a4:=0 else a4:=TArmies(41);
If ((TArmies(42)>1) and 
    (a1+a4+TArmies(39)<TArmies(42)) and
    TIsMine(42) and 
    (TIsMine(39)= False)
   ) then
 Begin
 ToTerritory:=39;
 FromTerritory:=42;
 BypassStruggler:=True;
 end;
end;

     If (FromTerritory=0) or (TContinent(ToTerritory)<>6) then
Begin
CAnalysis(6,PT,PA,ET,EA);
If TIsMine(39) and (TArmies(39)-4>EA) and (PT=1) then 
 Begin
 If TArmies(40)>=TArmies(42) then T:=42 else T:=40;
 ToTerritory:=T;
 FromTerritory:=39;
 BypassStruggler:=True;
 end;
end;

end; //C6 not mine

If (FromTerritory=31) then
Begin
       //Attack India from Middle East instead Siam if Middle East armies >4
       CAnalysis(5,PT,PA,ET,EA);
       If ((FromTerritory=31) and 
            (ToTerritory=30) and 
            TIsMine(27) and
            (TIsMine(30)=False) and
           (TArmies(27)>4) and
           (PT<9) and 
           ((UBufferGet(36)<>0)=False)
          ) then
           Begin
             //If UBufferGet(15) then //umessage('Attack to India swapped from Siam to Middle East');
            FromTerritory:=27;
            end;
 
       //Attack India from China instead Siam if China Stronger
       If ( (FromTerritory=31) and 
            (ToTerritory=30) and 
            TIsMine(32) and
            (TArmies(32)>TArmies(31)-1) and
            (TArmies(31)<30) ) then
             Begin
             //If UBufferGet(15) then //umessage('Attack swapped from Siam to China');
             FromTerritory:=32;
             end;
             
       //Attack China from India instead Siam if India Stronger
       If ( (FromTerritory=31) and 
            (ToTerritory=32) and 
            TIsMine(30) and (TIsMine(32)=False) and
            (TArmies(30)>TArmies(31)-1) and
            (TArmies(31)<30) ) then
             Begin
             //If UBufferGet(15) then //umessage('Attack swapped from Siam to India');
             FromTerritory:=30;
             end;
             
       //Attack China from Mongolia instead Siam if Mongolia Stronger
       If ( (FromTerritory=31) and 
            (ToTerritory=32) and 
            TIsMine(33) and (TIsMine(32)=False) and
            (TArmies(33)>TArmies(31)-1) and
            (TArmies(31)<35) ) then
             Begin
             //If UBufferGet(15) then //umessage('Attack swapped from Siam to Mongolia');
             FromTerritory:=33;
             end;
 
     //Choose less armies to attack from Siam
     If NOT ((ToTerritory=30) and (((COwner(3)=trunc(UBufferGet(36))) or (COwner(4)=trunc(UBufferGet(36)))) and (trunc(UBufferGet(36))<>0))) then
     If ( (COwner(6)=PMe) and 
          (FromTerritory=31) and
          ((ToTerritory=30) or (ToTerritory=32)) ) then 
     Begin
      If (((COwner(3)=trunc(UBufferGet(36))) or (COwner(4)=trunc(UBufferGet(36)))) and (UBufferGet(36)<>0)) then C:=2 else C:=0;
      If ((UBufferGet(39)<4) and (C=0)) then C:=1;
      if (TIsMine(32)=False) and (TArmies(32)+C<=TArmies(30)) then ToTerritory:=32;
      if (TIsMine(30)=False) and (TArmies(32)+C>TArmies(30)) then ToTerritory:=30;
      
      //If UBufferGet(15) then //umessage('Choose less armies to attack from Siam');
     end;
 
end;
 
       //Swap China attack to Kazakhstan from China to Mongolia if less= armies
       If ( (FromTerritory=32) and 
            (ToTerritory=29) and 
            (TIsMine(33)=False) and
            (TArmies(33)<=TArmies(29)) ) then
             Begin
             //If UBufferGet(15) then //umessage('China attack swapped of Kazakhstan to Mongolia');
             ToTerritory:=33;
             end;
   
      //Attack mexico if Venezuela strong
      If ((SConquest=False) and (FromTerritory=0)) then
      If (TIsMine(9)=False) and (COwner(2)=PMe) then
      If
        ( ((TArmies(10)>20) and (TArmies(9)<8) and (TArmies(12)>TArmies(14)+4)) OR 
          ((TArmies(10)>9 ) and (TArmies(9)=1)) ) then 
       Begin
        ToTerritory:=9;
        FromTerritory:=10;
        //If UBufferGet(15) then //umessage('Forced attack to Mexico= ');
        CAnalysis(1,PT,PA,ET,EA);
        If (double(TArmies(10)+PA)<(0.7*EA)) and (UBufferGet(24)=1) then UBufferSet(16,FromTerritory);
       end;

If TIsMine(12) then
Begin
  CAnalysis(2,PT,PA,ET,EA);
  //Brazil to Venezuela#
If( (PT=3) and 
    (TIsMine(10)=False) and
    (TArmies(12)>TArmies(10)+6)
   ) then
  Begin
   ToTerritory:=10;
   FromTerritory:=12;
   BypassStruggler:=True;
   //If UBufferGet(15) then //umessage('Brazil to Venezuela');
  end;


  //Brazil to Argentina
If( (TIsMine(13)=False) and
    (TArmies(12)>=4) and
    (TArmies(13)<=2) and
    (PA>7)
   ) then
  Begin
   ToTerritory:=13;
   FromTerritory:=12;
   //If UBufferGet(15) then //umessage('Brazil to Argentina');
  end;  

end;


 If (COwner(5)=0) then
 Begin
      //Don't attack from Siam if Armies<4 
      If ( (FromTerritory=31) and ((ToTerritory=30) or (ToTerritory=32)) ) then
       If (TArmies(31)<4) then 
       Begin
       FromTerritory:=0;
       //If UBufferGet(15) then //umessage('Attack from Siam Blocked');
       end;
 
       //Don't attack China or India from Siam if enemy stronger in China or India
       //If ( TIsMine(31) and (FromTerritory=31) and ((ToTerritory=30) or (ToTerritory=32)) and
        //   ( ((TArmies(31)<TArmies(32)) and (TIsMine(32)=False)) or
        //     ((TArmies(31)<TArmies(30)) and (TIsMine(30)=False)) 
        //    )
        //   ) then FromTerritory:=0;
           
 end;
 

        
      //North America 
      
      CAnalysis(1,PT2,PA2,ET2,EA2); // and (EA2<>0)
If PA2-PT2>2 then
Begin

A:=1;
For T:=1 to 9 do
 If Not TIsMine(T) then Begin C:=T; T:=9; end;
For T:=C+1 to 9 do
 If (Not TIsMine(T)) and (TOwner(C)<>TOwner(T)) then Begin A:=2; T:=9; end;


      CLeader(1,LPa,LTa,LAa);
      If ((PA2>trunc(1.3*EA2)) or ((LTa=8) and (TIsMine(1)=False) and (UBufferGet(39)>3)) ) then GO:=SConquest else GO:=False; 
      If (A=1) then
       If ((UBufferGet(39)<5) and (PA2>EA2) and 
      ((UBufferGet(25)=0) or (COwner(2)=PMe)) ) or (UBufferGet(39)=3) then GO:=SConquest; 
      
       
      //Try attack someone for cards from Mexico
      If (COwner(2)=PMe) then
      Begin
      TWeakestFront(9,ET,EA);
      If ( (SConquest=False) and (FromTerritory=0) ) then
       If ( TIsMine(9) and (TArmies(9)>8) and (EA<5) ) then
        If ET>0 then
       Begin
        ToTerritory:=ET;
        FromTerritory:=9;
If ToTerritory=10 then
 If ((COwner(1)=PMe) and ((TArmies(12)>TArmies(9)) or (TArmies(11)>TArmies(9)))) then FromTerritory:=0;
       end;
      end;
      
If PT2<9 then
If (SConquest=GO) and (FromTerritory=0) then
Begin 
      //Try attack someone for cards from Eastern US
      TWeakestFront(8,ET,EA);
      If ET>0 then
      If (SConquest=GO) and (FromTerritory=0) then
       If ( (TIsMine(8)=True) and (TArmies(8)>5) and (EA<4) ) then
       Begin
        ToTerritory:=ET;
        FromTerritory:=8;
        //If UBufferGet(15) then //umessage('Try attack someone for cards from Eastern US= ', ET );
       end;
       
      //Try attack someone for cards from Western US
      TWeakestFront(7,ET,EA);
      If ET>0 then
      If (SConquest=GO) and (FromTerritory=0) then
       If ( (TIsMine(7)=True) and (TArmies(7)>5) and (EA<4) ) then
       Begin
        ToTerritory:=ET;
        FromTerritory:=7;
        //If UBufferGet(15) then //umessage('Try attack someone for cards from Western US= ', ET );
       end;


      //Try attack someone for cards from Quebec
      TWeakestFront(6,ET,EA);
      If ET>0 then
      If (SConquest=GO) and (FromTerritory=0) then
       If ( (TIsMine(6)=True) and (TArmies(6)>5) and (EA<4) ) then
       Begin
        ToTerritory:=ET;
        FromTerritory:=6;
        //If UBufferGet(15) then //umessage('Try attack someone for cards from Quebec= ', ET );
       end;
      
      //Try attack someone for cards from Ontario
      TWeakestFront(5,ET,EA);
      If ET>0 then
      If (SConquest=GO) and (FromTerritory=0) then
       If ( (TIsMine(5)=True) and (TArmies(5)>5) and (EA<4) ) then
       Begin
        ToTerritory:=ET;
        FromTerritory:=5;
        //If UBufferGet(15) then //umessage('Try attack someone for cards from Ontario= ', ET );
       end;
      
      //Try attack someone for cards from Alberta
      TWeakestFront(4,ET,EA);
      If ET>0 then
      If (SConquest=GO) and (FromTerritory=0) then
       If ( (TIsMine(4)=True) and (TArmies(4)>5) and (EA<4) ) then
       Begin
        ToTerritory:=ET;
        FromTerritory:=4;
        //If UBufferGet(15) then //umessage('Try attack someone for cards from Alberta= ', ET );
       end;
       
              
      //Try attack someone for cards from Northwest Territory
      TWeakestFront(2,ET,EA);
      If ET>0 then
      If (SConquest=GO) and (FromTerritory=0) then
       If ( (TIsMine(2)=True) and (TArmies(2)>5) and (EA<4) ) then
       Begin
        ToTerritory:=ET;
        FromTerritory:=2;
        //If UBufferGet(15) then //umessage('Try attack someone for cards from Alberta= ', ET );
       end;
       

      //Try attack someone for cards from Mexico
      TWeakestFront(9,ET,EA);
      If ET>0 then
      If (SConquest=GO) and (FromTerritory=0) then
       If ( (TIsMine(9)=True) and (TArmies(9)>8) and (EA<5) ) then
       Begin
        ToTerritory:=ET;
        FromTerritory:=9;
If ToTerritory=10 then
 If ((COwner(1)=PMe) and ((TArmies(12)>TArmies(9)) or (TArmies(11)>TArmies(9)))) then FromTerritory:=0;
       end;

end; //PT2<9



//Try attack EU if the holder is strong
If (COwner(3)<>0) then
If NOT TIsMine(3) then 
Begin
CAnalysis(1,PT,PA,ET,EA);

If ((COwner(3)=trunc(UBufferGet(36))) or 
( (COwner(3)=TOwner(3)) and (PT>5) and (PT<8) and ((COwner(3)=TOwner(3)) or (COwner(3)=TOwner(5)) or (COwner(3)=TOwner(6))) )
)  then
 Begin
 TPStrongestBorder(3, PMe, PT2,PA2);
 If ((PA2>TArmies(3)) and (PT2<>0)) then
  Begin
   ToTerritory:=3;
   FromTerritory:=PT2;
   BypassStruggler:=True;
   If TArmies(FromTerritory)<30 then UBufferSet(13,ToTerritory); //Pass all
  end;
 end;
 
end;



//Attack Iceland if Europe is occupied
If (COwner(3)=TOwner(20)) then
Begin
      a1:=0;
      a4:=0;
CAnalysis(3,PT,PA,ET,EA);
If ((COwner(6)=-(trunc(UBufferGet(10)))) or (UBufferGet(39)>5)) and (COwner(6)<>0) then C:=12 else C:=9; 
If ((TArmies(3)>TArmies(20)) and 
     TIsMine(3) and 
    (TOwner(20)<>PMe) and 
    (COwner(3)<>0) and 
    (( (PTerritoriesCount(COwner(3))>C) or (TOwner(20)=-(trunc(UBufferGet(10)))) )) 
    ) then
      Begin
      a1:=FromTerritory;
      a4:=ToTerritory;
      ToTerritory:=20;
      FromTerritory:=3;
      BypassStruggler:=True;
      //umessage('Forced attack to Iceland' );
      end; 
end;


//Do not Attack Iceland from Greenland if none holds Europe
  // see also //Attack Iceland if Europe is occupied
If (FromTerritory=3) and (ToTerritory=20) then
Begin 
 if (COwner(3)=0) and (COwner(6)=-(trunc(UBufferGet(10)))) and (COwner(6)<>0) and (TArmies(3)-TArmies(20)-10<PArmiesCount(COwner(6))) then FromTerritory:=0; 
 if (COwner(3)=0) and (PArmiesCount(PMe)<180) then FromTerritory:=0;

CLeader(4,A,B,C);
CAnalysis(1,PT,PA,ET,EA);
CAnalysis(5,PT2,PA2,ET2,EA2);

If (PT2<10) then
 if (PArmiesCount(COwner(3))<70) and 
   ((PTerritoriesCount(COwner(3))<12) or (A<>COwner(3))) and (COwner(3)<>trunc(UBufferGet(36))) and 
 ((PArmiesCount(PMe)<220) and (PArmiesCount(-(trunc(UBufferGet(10))))>30)) 
  and (PT>6) and (COwner(6)=-(trunc(UBufferGet(10)))) then FromTerritory:=0;

If ((UBufferGet(36)<>0) and (trunc(UBufferGet(36))<>COwner(3)) and ( (COwner(4)=trunc(UBufferGet(36))) OR (COwner(4)=trunc(UBufferGet(36))) OR 
(((TArmies(21)>TArmies(3)+2) OR (TArmies(24)>TArmies(3)+2)) and (PT>6)) OR (COwner(5)=trunc(UBufferGet(36))) ))
 then FromTerritory:=0;

If (COwner(3)<>0) and (TArmies(20)>1) then
 If (trunc(UBufferGet(36))<>COwner(3)) and ((-UBufferGet(10)=UBufferGet(36)) or (UBufferGet(10)=UBufferGet(36))) then FromTerritory:=0;

if FromTerritory=0 then
 if (a1>0) and (a4>0) then
 if (a4<>20) then
 begin
 FromTerritory:=a1;
 ToTerritory:=a4;
end

end;

      //Try attack someone for cards from Greenland
      TWeakestFront(3,ET,EA);
      If ET>0 then
      If (SConquest=GO) and (FromTerritory=0) then
       If ( TIsMine(3) and (TArmies(3)-TArmies(20)>4) and ((EA=1) or ((EA<4) and (COwner(3)<>0))) ) then
       Begin
        ToTerritory:=ET;
        FromTerritory:=3;
        //If UBufferGet(15) then //umessage('Try attack someone for cards from Greenland= ', ET );
        if (SConquest and (ToTerritory=20) and (COwner(3)=0)) then FromTerritory:=0;
       end;
       
       //Do not Attack Island from Greenland if none holds Europe
If (FromTerritory=3) and (ToTerritory=20) then
 if SConquest and (COwner(3)=0) and (PArmiesCount(PMe)<180) then FromTerritory:=0;


//Use North Africa attack instead Island
If ((FromTerritory=3) and (ToTerritory=20)) then
If TArmies(12)>4+trunc(UBufferGet(39)) then
Begin
CAnalysis(1,PT,PA,ET,EA);
If PT=9 then C:=12 else C:=8;
If( 
    (PT>5) and
    (COwner(2)=PMe) and
    (COwner(3)<>PMe) and
    (COwner(3)<>0) and
    (NOT TIsMine(14)) and
  //(TArmies(3)-TArmies(20)<15) and
    ((TArmies(14)+TArmies(25)<TArmies(12)-4) or (TArmies(14)+TArmies(26)<TArmies(12)-4)) and
    ((TArmies(14)<C) or (COwner(3)=TOwner(14)) or (-(trunc(UBufferGet(10)))=TOwner(14))) and
    ((TArmies(14)+TArmies(25)<=TArmies(20)+1) or (TArmies(14)+TArmies(26)<=TArmies(20)+1)) and
    ((TArmies(25)<C-4) or (TArmies(26)<C-4)) 
   )
    then
  Begin
   ToTerritory:=14;
   FromTerritory:=12;
//umessage('Try North Africa attack instead Island');
  end;
  
If (TArmies(25)<3) or (TArmies(26)<3) then C:=4 else C:=0;

   If (COwner(3)<>0) and (COwner(2)=PMe) then
   If (COwner(3)=COwner(4)) and 
    ((PTerritoriesCount(COwner(3))>13) or (TArmies(14)+TArmies(25)-5<TArmies(20)) or (TArmies(14)+TArmies(26)-5<TArmies(20))) and 
    ( (TArmies(12)>TArmies(14)+TArmies(25)+8-C) or (TArmies(12)>TArmies(14)+TArmies(26)+8-C) ) and 
    ((TArmies(25)<6) or (TArmies(26)<6)) then
      Begin
   ToTerritory:=14;
   FromTerritory:=12;
//umessage('Try North Africa attack instead Island2222222222222222');
  end;
    
    
end;

end; //Have some terr in c1


//S.A.

      //Try attack someone for cards from Venezuela
      
      If ( (FromTerritory=0) and (SConquest=False) ) then
       If ( (COwner(2)=PMe) and (NOT TIsMine(9)) and (TArmies(10)>8) and (TArmies(9)<=(TArmies(10) div 8)) ) then
       Begin
        ToTerritory:=9;
        FromTerritory:=10;
        //If UBufferGet(15) then //umessage('Try attack someone for cards from Venezuela= ', ET );
       end;


If (FromTerritory=0) and (SConquest=False) then GOAsia:=True;
//GOAsia:=True;

//ASIA
CAnalysis(5,PT,PA,ET,EA);
If PA-PT>2 then
Begin

If PT<12 then
Begin
////umessage('GOAsia ', GOAsia, 'True ',True);

a1:=0;
If FromTerritory=31 then
If PT<8 then
If COwner(6)=PMe then
 If (TArmies(31)<PArmiesCount(-(trunc(UBufferGet(10))))) and (PA-TArmies(31)-PT>3) then
  If (ToTerritory<>-(trunc(UBufferGet(10)))) and (PTerritoriesCount(TOwner(ToTerritory))>1) then
 Begin
a1:=FromTerritory;
a4:=ToTerritory;
FromTerritory:=0;
//umessage('31 attempt');
end;


If ToTerritory=31 then
If TArmies(31)<3 then
If FromTerritory<>39 then
If COwner(6)<>PMe then
Begin
If (TArmies(30)>TArmies(32)) and TIsMine(30) and (TArmies(30)>2) then FromTerritory:=30;
If (TArmies(30)<=TArmies(32)) and TIsMine(32) and (TArmies(32)>2) then FromTerritory:=32;
end;

If FromTerritory=27 then
If UBUfferGet(36)>0 then
If COwner(TContinent(ToTerritory))=0 then
If (COwner(4)=trunc(UBUfferGet(36))) or (COwner(3)=trunc(UBUfferGet(36))) then
 Begin
a1:=FromTerritory;
a4:=ToTerritory;
FromTerritory:=0;
//umessage('27 attempt');
end;


//Protect Alaska by Asia
CAnalysis(1,PT2,PA2,ET2,EA2);
If ( ((FromTerritory=0) or (SConquest=False)) and (PT2>6) and (TIsMine(37)=False)) then
Begin

If ( (TArmies(33)>TArmies(37)) and (TArmies(33)>3) and TIsMine(33) ) then Begin FromTerritory:=33; ToTerritory:=37; end;
If ( (TArmies(36)>TArmies(37)) and (TArmies(36)>3) and TIsMine(36) ) then Begin FromTerritory:=36; ToTerritory:=37; end;
If ( (TArmies(35)>TArmies(37)) and (TArmies(35)>3) and TIsMine(35) ) then Begin FromTerritory:=35; ToTerritory:=37; end;
If ( (TArmies(38)>TArmies(37)) and (TArmies(38)>3) and TIsMine(38) ) then Begin FromTerritory:=38; ToTerritory:=37; end;
If TContinent(FromTerritory)=5 then UBufferSet(13,37);
end;

W:=0;

TryAsia:

If GOAsia and (FromTerritory=0) then
Begin //##1

//Try attack someone for cards from Mongolia
      TWeakestFront(33,ET,EA);
      ////If UBufferGet(15) then //umessage('TWeakestFront(33,ET,EA)= ', ET , ' ', EA);
      If ( GOAsia and (FromTerritory=0) ) then
      If ET>0 then
       If ( TIsMine(33) and (TArmies(33)>4-W) and (EA<4-W) ) then
       Begin
        If ((ET=28) and (TArmies(38)=TArmies(28)) and (TIsMine(38)=False)) then ET:=38;
        If ((ET=28) and (TArmies(36)=TArmies(28)) and (TIsMine(36)=False)) then ET:=36;
        If ((ET=28) and (TArmies(37)=TArmies(28)) and (TIsMine(37)=False)) then ET:=37;
        If ((ET=28) and (TArmies(34)=TArmies(28)) and (TIsMine(34)=False)) then ET:=34;
        ToTerritory:=ET;
        FromTerritory:=33;
        //If UBufferGet(15) then //umessage('Try attack someone for cards from Mongolia= ', ET );
       end;
 
      //Try attack someone for cards from Yakut
      TWeakestFront(35,ET,EA);
      If ( GOAsia and (FromTerritory=0) ) then
      If ET>0 then
       If ( TIsMine(35) and (TArmies(35)>4-W) and (EA<4-W) ) then
       Begin
        ToTerritory:=ET;
        FromTerritory:=35;
        //If UBufferGet(15) then //umessage('Try attack someone for cards from Yakut= ', ET );
       end;
       
      //Try attack someone for cards from Taymyr
      TWeakestFront(34,ET,EA);
      If GOAsia and (FromTerritory=0) then
      If ET>0 then
       If ( TIsMine(34) and (TArmies(34)>4-W) and (EA<4-W) ) then
       Begin
        ToTerritory:=ET;
        FromTerritory:=34;
        //If UBufferGet(15) then //umessage('Try attack someone for cards from Taymyr= ', ET );
       end;

      //Try attack someone for cards from China
      TWeakestFront(32,ET,EA);
      ////If UBufferGet(15) then //umessage('TWeakestFront(32,ET,EA)= ', ET , ' ', EA);
      If GOAsia and (FromTerritory=0) then
      If ET>0 then
       If ((TIsMine(32)=True) and (TArmies(32)>5-W) and (EA<4-W) ) then
       Begin
        ToTerritory:=ET;
        FromTerritory:=32;
        If ( (ToTerritory=29) and (TArmies(29)=TArmies(33)) and (TIsMine(33)=False) ) then ToTerritory:=33;
        //If UBufferGet(15) then //umessage('Try attack someone for cards from China= ', ET );
       end;

      //Try attack someone for cards from Buryat
      TWeakestFront(36,ET,EA);
      If GOAsia and (FromTerritory=0) then
      If ET>0 then
       If ( (TIsMine(36)=True) and (TArmies(36)>4-W) and (EA<4-W) ) then
       Begin
        ToTerritory:=ET;
        FromTerritory:=36;
        //If UBufferGet(15) then //umessage('Try attack someone for cards from Taymyr= ', ET );
       end;
       
      //Try attack China from Kazakhstan for cards
      If GOAsia and (FromTerritory=0) then
       If ( (TIsMine(29)=True) and (TIsMine(32)=False) and (TArmies(29)>5-W) and (TArmies(32)<4-W) ) then
       Begin
        ToTerritory:=32;
        FromTerritory:=29;
        //If UBufferGet(15) then //umessage('Try attack China from Kazakhstan for cards= ', ET );
       end; 

       
      //Try attack India from M.E. for cards 
      If GOAsia and (FromTerritory=0) then
       If ( (TIsMine(27)=True) and (TIsMine(30)=False) and (TArmies(27)>4-W) and (TArmies(30)<4-W) and (COwner(3)=0) and (COwner(4)=0) ) then
       Begin
        ToTerritory:=30;
        FromTerritory:=27;
        //If UBufferGet(15) then //umessage('Try attack India from M.E. for cards' );
       end;
       
       
      //Try attack someone for cards from India
      TWeakestFront(30,ET,EA);
      ////If UBufferGet(15) then //umessage('TWeakestFront(30,ET,EA)= ', ET , ' ', EA);
      If GOAsia and (FromTerritory=0) then
      If ET>0 then
       If ( TIsMine(30) and (TArmies(30)>4-W) and (EA<3-W) ) then
       Begin
        ToTerritory:=ET;
        FromTerritory:=30;
        //If UBufferGet(15) then //umessage('Try attack someone for cards from India= ', ET );
       end;
 
 
If (a1=31) or (a1=27) then
If FromTerritory=0 then
 Begin
 FromTerritory:=a1;
 ToTerritory:=a4;
 end;
 
 
 
      //Try attack someone for cards from Siam
      TWeakestFront(31,ET,EA);
      If (SConquest=False) and (FromTerritory=0) then
      If ET>0 then
       If ( TIsMine(31) and (TArmies(31)>=5) and (EA<=2) ) then
       Begin
        ToTerritory:=ET;
        FromTerritory:=31;
        UBufferSet(16,31);
        //If UBufferGet(15) then //umessage('Try attack someone for cards from Siam= ', ET );
       end;
   
 end; //##1
 

 
       //Don't attack China or India from Siam if enemy stronger in China or India #2
       If (FromTerritory=31) then
        If ( ((ToTerritory=30) or (ToTerritory=32)) and
           ( ((TArmies(31)<TArmies(32)) and (TIsMine(32)=False)) or
             ((TArmies(31)<TArmies(30)) and (TIsMine(30)=False)) 
            )
           ) then FromTerritory:=0;
           
           
           
     //Try attack India if someone strong in EU and Af
 If TIsMine(31) then
  If NOT TIsMine(27) then
   If ((ToTerritory=32) and (FromTerritory=31)) or (FromTerritory=0) then 
    If UBufferGet(39)<5 then
     If (UBufferGet(10)>=0) or ((UBufferGet(10)<0) and (TArmies(31)>PArmiesCount(-(trunc(UBufferGet(10))))+20)) then 
      If (((COwner(3)=trunc(UBufferGet(36))) or (COwner(4)=trunc(UBufferGet(36)))) and (trunc(UBufferGet(36))<>0)) then 
       If ( (NOT TIsMine(29)) and (NOT TIsMine(30))) then
        if (TArmies(31)>5) and (TArmies(31)>TArmies(30)+5) and (TArmies(30)<8) then
         If COwner(6)=PMe then
          If Not ((TContinent(ToTerritory)=3) or (TContinent(ToTerritory)=4)) then
         Begin
          ToTerritory:=30;
          FromTerritory:=31;
          ByPassStruggler:=True;
         end;
 

//testeeeee
       
end; //Rules if Asia isn't mine

If GOAsia and (FromTerritory=0) then
Begin //##2

      //Try attack someone for cards from Yamal-Nemets
      TWeakestFront(28,ET,EA);
      CAnalysis(3,PT2,PA2,ET2,EA2);
      ////If UBufferGet(15) then //umessage('TWeakestFront(28,ET,EA)= ', ET , ' ', EA);
       If ( TIsMine(28) and (TArmies(28)>4-W) and (EA<3-W) ) then
       If ET>0 then
       Begin
        ToTerritory:=ET;
        FromTerritory:=28;
        If (COwner(3)=0) and (ET=22) then 
        begin
        If ((TArmies(29)=TArmies(22)) and (TIsMine(29)=False)) then ToTerritory:=29;
        If ((TArmies(33)=TArmies(22)) and (TIsMine(33)=False)) then ToTerritory:=33;
        If ((TArmies(34)=TArmies(22)) and (TIsMine(34)=False)) then ToTerritory:=34;
        
        If ((TArmies(22)>1) and (COwner(3)=0)) then FromTerritory:=0;
        If (SConquest and (COwner(3)=0)) then FromTerritory:=0;
        end;
        
        If ToTerritory=22 then UBufferSet(16,22); //Pass nothing
        
        //If UBufferGet(15) then //umessage('Try attack someone for cards from Yamal-Nemets= ', ET );
       end;
       
   
      //Try attack someone for cards from Kazakhstan
      TWeakestFront(29,ET,EA);
      CAnalysis(3,PT2,PA2,ET2,EA2);
      ////If UBufferGet(15) then //umessage('TWeakestFront(29,ET,EA)= ', ET , ' ', EA);
      If ET>0 then
      If GOAsia and (FromTerritory=0) then
       If ( (TIsMine(29)=True) and (TArmies(29)>4-W) and (EA<3-W) ) then
       Begin
        ToTerritory:=ET;
        FromTerritory:=29;

        If COwner(3)=0 then
        Begin
        If ((ET=22) and (TArmies(27)=TArmies(22)) and (TIsMine(27)=False)) then ToTerritory:=27;
        If ((ET=22) and (TArmies(28)=TArmies(22)) and (TIsMine(28)=False)) then ToTerritory:=28;
        If ((ET=22) and (TArmies(30)=TArmies(22)) and (TIsMine(30)=False)) then ToTerritory:=30;
        If ((ET=22) and (TArmies(32)=TArmies(22)) and (TIsMine(32)=False)) then ToTerritory:=32;
        end;
        If ((ET=28) and (TArmies(32)=TArmies(28)) and (TIsMine(32)=False)) then ToTerritory:=32;
        If ((ET=27) and (TArmies(32)=TArmies(27)) and (TIsMine(32)=False)) then ToTerritory:=32;
        If ((ET=28) and (TArmies(30)=TArmies(28)) and (TIsMine(30)=False)) then ToTerritory:=30;
        If ((ET=27) and (TArmies(30)=TArmies(27)) and (TIsMine(30)=False)) then ToTerritory:=30;

        If ((ToTerritory=22) and (TArmies(22)>1) and (COwner(3)=0)) then FromTerritory:=0;
        If ((ToTerritory=22) and SConquest and (COwner(3)=0)) then FromTerritory:=0;

        If ToTerritory=22 then UBufferSet(16,22); //Pass nothing
        //If UBufferGet(15) then //umessage('Try attack someone for cards from Kazakhstan= ', ET );
       end;

// from 27 to 29
If GOAsia and (FromTerritory=0) then
 If (TIsMine(27) and (NOT TIsMine(29)) and (TArmies(27)>TArmies(29)+3) and (TArmies(29)<4)) then
  If (NOT (((COwner(3)=trunc(UBufferGet(36))) or (COwner(4)=trunc(UBufferGet(36)))) and (UBufferGet(36)<>0))) then 
       Begin
        ToTerritory:=29;
        FromTerritory:=27;
       end;
              
      //Try attack someone for cards from Koryak
      TWeakestFront(37,ET,EA);
      If ET>0 then
      If GOAsia and (FromTerritory=0) then
       If ((TIsMine(37)=True) and (TArmies(37)>2+EA-W) and (double(EA)<2+double(TArmies(37))/9-W)) then
       Begin
        ToTerritory:=ET;
        FromTerritory:=37;
        //If UBufferGet(15) then //umessage('Try attack someone for cards from Koryak= ', ET );
        If ToTerritory=1 then FromTerritory:=0; 
       end;

      //Try attack someone for cards from M.E.
      TWeakestFront(27,ET,EA);
      If ET>0 then
      If SConquest=False then
      If (FromTerritory=0) or 
      ( ((FromTerritory=28) or (FromTerritory=29)) and (ToTerritory=22) and (COwner(3)=0) and (EA<TArmies(22)) ) then
       If (TIsMine(27) and (TArmies(27)>2+EA) and 
       ((EA=1) or ((EA<4) and (COwner(TContinent(ET))<>0)) and (ET<>ToTerritory))) then
       Begin
        ToTerritory:=ET;
        FromTerritory:=27;
       end;

end; //##2



//Detect lone territory in Asia#
If ((TContinent(ToTerritory)<>5) or (FromTerritory=0)) then
Begin
CAnalysis(5,PT,PA,ET,EA);
If (PT=11) then 
Begin

B:=0;
B2:=0;
  For T:=27 to 38 do //Find what is not mine
   begin 
    If Not TIsMine(T) then B:=T;
    If (PTerritoriesCount(TOwner(T))=1) and (Not TIsMine(T)) then B2:=T;
   end;
   
//Detect lone game territory in Asia and try attack it     
If ( (PTerritoriesCount(TOwner(B2))=1) and (TArmies(B2)<35) ) then
 Begin
 TPStrongestBorder(B2, PMe, PT2,PA2);
 If ((PA2>TArmies(B2)) and (PT2<>0)) then
  Begin
   ToTerritory:=B2;
   FromTerritory:=PT2;
   ////umessage('Try attack to lone game territory in Asia from ', TName(PT2) );
   B:=775;
  end;
 end;


//Detect lone territory in Asia and try attack it     
If ( (ET=1) and (B<>0) and (EA<30) and (B<>775) ) then
 Begin
 TPStrongestBorder(B, PMe, PT2,PA2);
 If ((PA2>EA) and (PT2<>0)) then
  Begin
   ToTerritory:=B;
   FromTerritory:=PT2;
   ////umessage('Try attack lone territory in Asia from ', TName(PT2) );
  end;
 end;

end;
end;

If FromTerritory=0 then
If PT<11 then
If PT>1 then
If (Not SConquest) and (W=0) then
Begin
W:=1;
//umessage('Asia retry');
Goto TryAsia;
end;


//Swap 29 to 22 if necessary
 If TIsMine(22) then
 If ((ET>8) and TIsMine(28)) then
 If (FromTerritory=29) and (ToTerritory=27) and (TArmies(22)>=TArmies(29)) then
  FromTerritory:=22;
  
If (Not TIsMine(29)) and TIsMine(32) then
If TContinent(ToTerritory)<>3 then
If PTerritoriesCount(COwner(3))>14 then
If UBufferGet(39)<5 then
If (FromTerritory=0) or ((FromTerritory=32) and (COwner(1)<>COwner(3))) then
If TArmies(32)>TArmies(29)+TArmies(22)+1 then
 Begin
 FromTerritory:=32;
 ToTerritory:=29;
 UBufferSet(13,ToTerritory);
 end;

end; //I have more than 2 armies in asia



//Detect lone territory in N.A#
CAnalysis(1,PT,PA,ET,EA);

if PT>5 then
If PT<9 then
If ((FromTerritory=0) OR (PT=8)) then 
If ((TContinent(ToTerritory)<>1) or (FromTerritory=0)) or 
  ((TContinent(ToTerritory)=1) and 
   (TContinent(FromTerritory)=1) and 
   (TArmies(FromTerritory)<6) and 
   (PT=8)
  ) then
Begin

If (ToTerritory=9) then
If TArmies(9)<3 then
If (PT>6) and (TContinent(FromTerritory)=1) then
Begin
TPStrongestBorder(9, PMe, PT2,PA2);
ToTerritory:=9;
If (TContinent(PT2)=1) then FromTerritory:=PT2;
end;

B:=0;
B2:=0;
  For T:=1 to 9 do //Find what is not mine
   begin 
    If Not TIsMine(T) then B:=T;
    If ((PTerritoriesCount(TOwner(T))=1) and (Not TIsMine(T))) then B2:=T;
   end;
If B2<>0 then B:=B2;

   
If ( (ET<=4) and (PA>EA+8) and (B<>0) and ((EA<30) or (TOwner(B)=COwner(6))) and (B<>775) ) then
 Begin
 TPStrongestBorder(B, PMe, PT2, PA2);
 If ((B2<>0) OR (PT=8)) then C:=0 else C:=1;
 If ((PA2>TArmies(B)+C) and (PT2<>0)) then
  Begin
   ToTerritory:=B;
   FromTerritory:=PT2;
   //If UBufferGet(15) then //umessage('Try attack (ET<=2) territory in N.A. from ', TName(PT2) );
  end;
 end;
//umessage(b);


If PT=8 then
Begin

//If FromTerritory=0 then

A:=0;
For C:=1 to TBordersCount(B) do
If TIsMine(TBorder(B,C)) then A:=A + TArmies(TBorder(B,C));

If A>13 then D:=85 else D:=100; //changed from .85 and 1 so that D remains an integer

If (100*(A-TBordersCount(B)))>D*EA then  //mutiply everything D is compared to by 100
Begin
TPStrongestBorder(B, PMe, PT2, PA2);
FromTerritory:=PT2;
ToTerritory:=B;
end;
//umessage(a,b);

 If ToTerritory=B then
  If TContinent(FromTerritory)=1 then
   If TArmies(FromTerritory)<6 then
  Begin
  TPStrongestBorder(B, PMe, PT2, PA2);
  If (PA2>5) then FromTerritory:=PT2;
  end;

end;



end;


//Detect lone territory in S.A.#
CAnalysis(2,PT,PA,ET,EA);
If PT<4 then
If PA-PT>1 then
If ToTerritory<>14 then
Begin

If ((PA>EA+5) or (UBufferGet(39)=3)) then D:=1 else D:=0;
B:=0;
B2:=0;
  For T:=10 to 13 do //Find what is not mine
   begin 
    If Not TIsMine(T) then B:=T; 
    If ((PTerritoriesCount(TOwner(T))=1) and (Not TIsMine(T))) then B2:=T;
    //<0
   end;

If ((B=13) and 
     TIsMine(10) and 
     TIsMine(11) and 
    (NOT TIsMine(12)) and 
    (TArmies(11)<=TArmies(13)+1) and
    (TArmies(10)>TArmies(11))
   ) then B:=12;

If ((B=13) and 
     TIsMine(10) and 
     (ET=3)
   ) then B:=11;

If ((B2<>0) OR (PT=3)) then C:=0 else C:=1;
  
If ((ET<=2+D) and (B<>0)) then
 Begin
 TPStrongestBorder(B, PMe, PT2, PA2);
 If ((PA-4-C>TArmies(B)+C) and (PT2<>0)) then
  If (PA2>2) or (PA2>TArmies(B)) then
  Begin
   ToTerritory:=B;
   FromTerritory:=PT2;
  end;
  
  
If PT=3 then
Begin

 If (
    ((FromTerritory=12) OR (FromTerritory=10) OR (FromTerritory=13)) and 
     (ToTerritory<>11) and (ToTerritory<>14) and TIsMine(11) and
     (TArmies(11)>3) and ((TArmies(ToTerritory)>2) or ((ToTerritory=10) and (COwner(1)=0)))
    ) then FromTerritory:=11;
    
end;
    
    
 end;

end;




//Detect and try attack lone game territory anywhere
If (UBufferGet(39)>2) then
Begin
D:=0;

If UBufferGet(10)>=0 then
For J:=1 to 10 do
  If PTerritoriesCount(J)=1 then Begin D:=1; J:=10; end;

If (UBufferGet(10)<0) or (D=1) then
If (UBufferGet(10)<0) or (PTerritoriesCount(trunc(UBufferGet(36)))<25) OR (PTerritoriesCount(PMe)>25) then
Begin

//Lame fix
A:=0;
If UBufferGet(10)<0 then
 If (PArmiesCount(-(trunc(UBufferGet(10))))<8) or 
 ( (COwner(6)=PMe) and (UBufferGet(36)=0) and (PTerritoriesCount(-(trunc(UBufferGet(10))))<6) and (Not ((COwner(1)=PMe) or (COwner(5)=PMe))) ) then //##0 ok
   A:=343;

B:=0; 
For T:=1 to 42 do 
If NOT TIsMine(T) then
 If (PTerritoriesCount(TOwner(T))=1) OR ((A=343) and (TOwner(T)=-(trunc(UBufferGet(10))))) then 
Begin
T2:=B;
B:=T;
TPStrongestBorder(B, PMe, PT, PA);
If PT=0 then B:=T2; //If no contact, keep last success result B
end;

If B>0 then
Begin
TPStrongestBorder(B, PMe, PT, PA);
If (((UBufferGet(36)<>0)=False) and (COwner(6)=PMe)) then C:=10 else C:=0;
If (((PTerritoriesCount(TOwner(B))=1) and (TArmies(B)<10+C)) OR (TOwner(B)=-(trunc(UBufferGet(10))))) and (PT>0) and (PA>TArmies(B)) then 
  Begin
   ToTerritory:=B;
   FromTerritory:=PT;
   //If UBufferGet(15) then //umessage('Try attack lone GAME territory from ', TName(PT) );
   If (TArmies(B)<=2) and (Not SConquest) then BypassBubble:=True;
   If COwner(6)=PMe then
    If (TOwner(ToTerritory)=-(trunc(UBufferGet(10)))) and (PTerritoriesCount(-(trunc(UBufferGet(10))))<=3) then BypassBubble:=True;
  end;
  end;
end;
end;


//Get 33 from 32 if someone holds N.A.
If (COwner(1)<>0) and (COwner(1)<>PMe) then
If (COwner(1)=trunc(UBufferGet(36))) or ((UBufferGet(36)=0) and (UBufferGet(39)<6)) then //## 0 ok
Begin

 If NOT (TIsMine(33) or TIsMine(35) or TIsMine(36) or TIsMine(37)) then
  If TIsMine(32) and (TArmies(32)>TArmies(33)+2) and (TArmies(33)<8) then
   Begin
   ToTerritory:=33;
   FromTerritory:=32;
   end;



//Prepare to get Koryak to get Alaska#
If Not TIsMine(37) then
Begin

If TIsMine(33) then A:=TArmies(33) else A:=0;
If TIsMine(35) then B:=TArmies(35) else B:=0;
If TIsMine(36) then C:=TArmies(36) else C:=0;
If TIsMine(38) then D:=TArmies(38) else D:=0;
T:=33;
//If ( (A>B) and (A>C) and (A>D) ) then T:=33;
If ( (B>A) and (B>=C) and (B>=D) ) then T:=35;
If ( (C>A) and (C>B) and (C>=D) ) then T:=36;
If ( (D>A) and (D>B) and (D>C) ) then T:=38;

If ( (UBufferGet(29)=0) and (PProgram(COwner(1))<>PProgram(PMe)) ) then //Cooperative NA
 If( TIsMine(T) and 
    (TArmies(T)>TArmies(37)) and
    ( (TArmies(37)<14) OR (TOwner(37)=TOwner(1)) )
   ) then
  Begin
   ToTerritory:=37;
   FromTerritory:=T;
   BypassStruggler:=True;
   If (COwner(1)=trunc(UBUfferGet(36))) and (COwner(1)<>0) and (T<>trunc(UBufferGet(20))) then BypassBubble:=True;
   UBufferSet(13,37);
   //If UBufferGet(15) then //umessage('Try Koryak from Mongolia if North America occupied ######');
  end;
end;

end;


//Protect Asia from Europe
If (TContinent(FromTerritory)=3) or (FromTerritory=0) or 
   ((ToTerritory=22) and (TContinent(FromTerritory)=5)) then
If Not TIsMine(22) then
If TContinent(ToTerritory)<>4 then
Begin
If TIsMine(21) then A:=TArmies(21) else A:=0;
If TIsMine(23) then B:=TArmies(23) else B:=0;
If TIsMine(26) then C:=TArmies(26) else C:=0;
If A+B+C>4 then
Begin
T:=26;
IF ((A>=B) and (A>=C)) then T:=21;
IF ((B>A) and (B>=C)) then T:=23;

If ((COwner(5)=PMe) and TIsMine(T) and (TArmies(T)>4) and (NOT TIsMine(22))) then
Begin 
FromTerritory:=T; 
ToTerritory:=22; 
end;
end;
end;

//Always attack Africa if the holder is strong
If COwner(4)<>0 then
If TIsMine(27) then
If (trunc(UBufferGet(36))=COwner(4)) or ((FromTerritory=0) and (UBufferGet(39)=2)) then
If (COwner(5)<>PMe) or (TArmies(27)>6) then
If (COwner(6)=PMe) or (COwner(4)=COwner(6)) or (COwner(1)=PMe) or (COwner(2)=PMe) then
Begin
If COwner(4)=COwner(3) then C:=1 else C:=0;
If (( ((PTerritoriesCount(TOwner(15))>=12) or (trunc(UBufferGet(36))=COwner(4))) and (COwner(4)<>PMe) and (COwner(4)=TOwner(15))) and 
     TIsMine(27) and 
    (TArmies(15)>=TArmies(16)+C) and 
    (TArmies(27)>TArmies(16)+1)) then
      Begin
      ToTerritory:=16;
      FromTerritory:=27;
      BypassStruggler:=True;
      end;
If (( ((PTerritoriesCount(TOwner(15))>=12) or (trunc(UBufferGet(36))=COwner(4))) and 
      (COwner(4)<>PMe) and  
      (COwner(4)=TOwner(15))) and 
       TIsMine(27) and 
      (TArmies(16)+C>TArmies(15)) and 
      (TArmies(27)>TArmies(15)+1)) then
      begin
      ToTerritory:=15;
      FromTerritory:=27;
      BypassStruggler:=True;
      end;
      
 If FromTerritory=27 then
  If (TContinent(ToTerritory)=4) then     
   If Not TIsMine(26) then
 Begin
 
  If (COwner(3)=COwner(4)) and (COwner(4)<>0) then
  If TArmies(ToTerritory) + TArmies(14) + TArmies(25)>= TArmies(14) + TArmies(26) then
  If TArmies(FromTerritory)> TArmies(14) + TArmies(26) then
      begin
      ToTerritory:=26;
      BypassStruggler:=True;
      end;
 
 If (COwner(4)<>0) and (TArmies(14)<5) and ((TOwner(26)=TOwner(15)) or (TArmies(26)<4)) then
  If ( TArmies(ToTerritory) - (TArmies(14) + TArmies(26)) )>2 then
      begin
      ToTerritory:=26;
      BypassStruggler:=True;
      end;
  
  
  end;
   
end;

//Kamikaze attack
If FromTerritory=0 then
If COwner(4)<>0 then
If COwner(4)=trunc(UBufferGet(36)) then
If (TArmies(27)>4) then
If ((COwner(5)=PMe) and (COwner(3)=0)) or (UBufferGet(39)=2) then
If (COwner(6)=PMe) or (COwner(4)=COwner(6)) then
Begin
If (TArmies(16)<=TArmies(15)) then
 If (TArmies(16)>TArmies(27)+4) then
  Begin
  FromTerritory:=27;
  ToTerritory:=16;
  end;
  
If (TArmies(16)>TArmies(15)) then
 If (TArmies(15)>TArmies(27)+4) then
  Begin
  FromTerritory:=27;
  ToTerritory:=15;
  end;
end;



//attack East Africa instead Egypt if less armies
    If ( ((ToTerritory=15) or (ToTerritory=16)) and (FromTerritory=27) ) then
      If ((COwner(4)<>0) and ((COwner(3)=0) or ((TArmies(15)-1>TArmies(16)) and (ToTerritory=15)) ) ) then  
        If (TArmies(15)>=TArmies(16)) then ToTerritory:=16 else ToTerritory:=15;  
       
     If TIsMine(31)=False then
     if ToTerritory<>31 then
      If ( (TIsMine(30)=True) and  
           (TIsMine(39)=False) and 
           (TArmies(31)+TArmies(39)<TArmies(30))
          ) then 
      Begin
      ToTerritory:=31;
      FromTerritory:=30;
      BypassStruggler:=True;
      end;
   



If COwner(3)<>0 then
If COwner(3)<>PMe then
Begin// (COwner(3)<>0)



If ToTerritory=26 then
 If ((FromTerritory=27) and (Not TIsMine(22))) then
Begin
CAnalysis(5,PT,PA,ET,EA);
If PT>4 then
 If ((COwner(4)=0) and (TArmies(22)<=TArmies(26))) then ToTerritory:=22;
end;

If (COwner(3)=trunc(UBufferGet(36))) and (COwner(3)<>PMe) then
Begin

If ((FromTerritory=0) or ((FromTerritory=27) and (TContinent(ToTerritory)=5) )) then
 If ( //(TArmies(26)<TArmies(22)) and 
     (TArmies(26)<TArmies(27)) and
     ( ((TArmies(29)<=TArmies(22)) and TIsMine(29)) or (NOT TIsMine(29)) ) and 
     ( ((TArmies(28)<=TArmies(22)) and TIsMine(28)) or (NOT TIsMine(28)) ) and
      TIsMine(27) 
     ) then 
     Begin
     FromTerritory:=27;
     ToTerritory:=26;
     BypassStruggler:=True;
     end;
     
If ToTerritory=26 then
 If ((FromTerritory=27) and (Not TIsMine(22))) then
 If ((COwner(4)=0) and (TArmies(22)<TArmies(26))) then ToTerritory:=22;
 

If ((ToTerritory=22) and (FromTerritory=27)) then
If (COwner(3)=COwner(4)) then
Begin
 If TArmies(15)<TArmies(14) then A:=TArmies(15) else A:=TArmies(14);
 
 If (A<6) and (TArmies(26)-TArmies(22)<4) then
 If (TArmies(27)>TArmies(26)+A+1) then 
     Begin
     FromTerritory:=27;
     ToTerritory:=26;
     BypassStruggler:=True;
     end;
end;

end;



//Africa to Europe#
If (COwner(3)<>0) then
If (COwner(3)<>PMe) then
Begin
If TArmies(25)<TArmies(26) then T:=25 else T:=26;
If (TIsMine(15) and TIsMine(14) and (TArmies(15)>TArmies(14))) then T2:=15 else T2:=14;
If (TIsMine(15) and (Not TIsMine(14)) and (TArmies(26)<TArmies(14)+TArmies(25)) ) then Begin T2:=15; T:=26; end else T2:=14;

If( (COwner(3)<>PMe) and 
     TIsMine(T2) and 
    (TArmies(T2)>TArmies(T))
   ) then
  Begin
   ToTerritory:=T;
   FromTerritory:=T2;
   BypassStruggler:=True;
   //If UBufferGet(15) then //umessage('Africa to Europe');
  end;
end;


      //Don't miss an attack to destroy somebody's totality in Europe
      If ((FromTerritory=0) and 
          (COwner(4)=TOwner(26)) and
          (COwner(3)<>PMe) and 
          (COwner(3)<>0) and 
           TIsMine(27) and 
          (TArmies(26)<TArmies(27)) and
          (TArmies(26)<TArmies(22)) and
          (TArmies(26)<4) 
         ) then 
      Begin
      ToTerritory:=26;
      FromTerritory:=27;
      ////If UBufferGet(15) then 
      //umessage('Must not appear##################3Forced attack to Europe' );
      UBufferSet(28,0);
      If ((TArmies(14)<=3) and (TArmies(27)>TArmies(14)+2)) then UBufferSet(28,TArmies(14)+2);
      If ((COwner(4)=COwner(1)) and (TArmies(14)+TArmies(12)<5) and (TArmies(27)>TArmies(14)+TArmies(12)+2)) then UBufferSet(28,TArmies(14)+TArmies(12)+2);
      UBufferSet(27,26);
      BypassStruggler:=True;
      end;
      

end; //(COwner(3)<>0)



//Attack North Africa if can get in Europe by Western Europe later#
If ((COwner(3)<>0) or (COwner(2)<>0)) then
If NOT ((FromTerritory=15) and (ToTerritory=26)) then
Begin
If ( TIsMine(16) and (TIsMine(14)=False) ) then
 If (((TArmies(14)+TArmies(25)<TArmies(16)) and (COwner(3)<>0)) OR ((TArmies(14)+TArmies(12)<TArmies(16)) and (COwner(2)<>0))) then
      Begin
      ToTerritory:=14;
      FromTerritory:=16;
      UBufferSet(13,14);
      end;
If ( TIsMine(15) and (TIsMine(14)=False) ) then
 If (((TArmies(14)+TArmies(25)<TArmies(15)) and (COwner(3)<>0)) OR ((TArmies(14)+TArmies(12)<TArmies(15)) and (COwner(2)<>0))) then
      Begin
      ToTerritory:=14;
      FromTerritory:=15;
      UBufferSet(13,14);
      end;

end;

//Asia protection attack
If COwner(5)=PMe then
If (FromTerritory=0) or ((COwner(TContinent(ToTerritory))=0) and (not Sconquest) and (ToTerritory<>22)) then
If ((TArmies(28)<4) or (TArmies(29)<4)) and (TArmies(22)=1) then
If not TIsMine(22) then
Begin
If TArmies(29)>TArmies(28) then FromTerritory:=29 else FromTerritory:=28;
If (TArmies(FromTerritory)<3) or 
   ( (TOwner(23)=TOwner(22)) and (TArmies(23)-1>TArmies(FromTerritory)) ) or
   ( (TOwner(21)=TOwner(22)) and (TArmies(21)-1>TArmies(FromTerritory)) ) then FromTerritory:=0;
ToTerritory:=22;
end;

//Choose a good attack to Ukrania
If ToTerritory=22 then 
Begin
CAnalysis(5,PT,PA,ET,EA);
GO:=((PT=12) or ( (PT=11) and ((Not TIsMine(37)) or (Not TIsMine(36)) or (Not TIsMine(35)) or (Not TIsMine(38))) ));
If ( GO and (FromTerritory=27) ) then
Begin
If ((PT=12) and (TArmies(27)>6)) then C:=2 else C:=1;
If ((TArmies(29)+C>=TArmies(27)) and (TArmies(29)> TArmies(28))) then FromTerritory:=29;
If ((TArmies(28)+C>=TArmies(27)) and (TArmies(28)>=TArmies(29)) and (TArmies(28)>1)) then FromTerritory:=28;
end;

If ( GO and ((FromTerritory=28) or (FromTerritory=29)) ) then
Begin
If ( (FromTerritory=29) and (TArmies(28)>=TArmies(29)) ) then FromTerritory:=28;
If ( (FromTerritory=28) and (TArmies(29)> TArmies(28)) ) then FromTerritory:=29;
If (TArmies(27)>2*TArmies(FromTerritory)+2) then FromTerritory:=27;
end;

If (GO and 
   (FromTerritory=27) and 
   ( SConquest or ((TArmies(27)<8) and (PT=12)) ) and
   (COwner(3)=0)) then FromTerritory:=0;

end;


//Try attack Middle East if someone got 2 continents
If ( NOT ((COwner(3)<>0) and ((ToTerritory=22) or (ToTerritory=26))) ) then
If ( (TIsMine(27)=False) and 
     ((UBufferGet(36)<>0) and ((COwner(3)=trunc(UBufferGet(36))) or (COwner(4)=trunc(UBufferGet(36))))) ) then 
Begin
 TPStrongestBorder(27, PMe, PT2,PA2);
 If ( (PA2-1>TArmies(27)) and ((TArmies(27)<10) or (TOwner(27)=trunc(UBufferGet(36)))) ) then
   Begin
    ToTerritory:=27;
    FromTerritory:=PT2;
    //If UBufferGet(15) then //umessage('Try conquest Middle East to "get in touch" with the strong player ' );
    If ((FromTerritory=29) and (TArmies(22)<TArmies(29)) and (TArmies(22)<=TArmies(26)+1) and (COwner(3)=TOwner(22)) and (COwner(3)=trunc(UBufferGet(36)))) then ToTerritory:=22;
   end;
end;    

 
  
//26 to 14
If TIsMine(26) then
If (Cowner(4)<>0) then
 If ( (Cowner(4)<>PMe) and ((TArmies(26)>TArmies(14)) or (TArmies(26)>TArmies(15))) ) then
  Begin
   if (TArmies(14)<15) then ToTerritory:=14;
   If (TArmies(15)<=TArmies(14)) and ((COwner(2)=0) or (TArmies(12)+TArmies(14)>TArmies(26))) then ToTerritory:=15;
   If (ToTerritory=14) or (ToTerritory=15) then 
   Begin
   FromTerritory:=26;
   BypassStruggler:=True;
   end;
  end;
  
  
  
  
If (COwner(1)<>0) then
If (COwner(1)<>PMe) then
Begin //c1
  
//North Africa attack strategy#
If TIsMine(14) then
If COwner(1)=COwner(2) then
If( (COwner(3)<>COwner(1)) and 
    (TIsMine(10)=False) and
    (TIsMine(12)=False) and
    (TArmies(14)>TArmies(12)+TArmies(10)+TArmies(9)+1)
   ) then
  Begin
   ToTerritory:=12;
   FromTerritory:=14;
   //If UBufferGet(15) then //umessage('Try attack South America and North America');
  end;
  

//Brazil to Venezuela if can get Mexico#
If( TIsMine(12) and 
    (TIsMine(10)=False) and
    (TArmies(12)>TArmies(10)+TArmies(9)+1)
   ) then
  Begin
   ToTerritory:=10;
   FromTerritory:=12;
   BypassStruggler:=True;
   //If UBufferGet(15) then //umessage('Brazil to Venezuela to get Mexico');
  end;

  
//If North America occupied try Alaska attack
If TIsMine(37) then
If ( NOT ( 
(COwner(1)<>trunc(UBufferGet(36))) and 
(UBufferGet(36)<>0) and
(PTerritoriesCount(COwner(1))<15) 
)) then
If( (TOwner(1)=COwner(1)) and
    ( (TArmies(37)>TArmies(1)) or ((TArmies(37)>trunc(0.8*TArmies(1)-0.7)) and (TArmies(37)>3)) )
   ) then
  Begin
   ToTerritory:=1;
   FromTerritory:=37;
   BypassStruggler:=True;
   If (COwner(1)=trunc(UBufferGet(36))) and (COwner(1)<>0) and (37<>UBufferGet(20)) then BypassBubble:=True;
  end;
  
end;//c1



// Venezuela to Mexico if North America occupied#
If ( ((FromTerritory=0) and (SConquest=False) and (COwner(2)=PMe)) OR 
     ((COwner(1)<>0) and (COwner(1)<>PMe)) ) then 
begin
CLeader(1,LPa,LTa,LAa);
CAnalysis(1,PT,PA,ET,EA);
If( (((LTa>=8) and (double(EA)<(1.4*LTa)) and (TArmies(9)<4) and (TArmies(10)>15) and (TOwner(9)=TOwner(8)) and (TOwner(9)=TOwner(7)) )) and 
     TIsMine(10) and 
    (NOT TIsMine(9)) and 
    (TArmies(10)>TArmies(9))
   ) then
  Begin
   ToTerritory:=9;
   FromTerritory:=10;
  end;
  
If ((LTa=9) and (LPa<>PMe) and (TArmies(10)>TArmies(9)) and TIsMine(10)) then 
  Begin
   ToTerritory:=9;
   FromTerritory:=10;
   BypassStruggler:=True;
  end;
  
end;




//Attack from Indonesia if someone holds Asia
If FromTerritory=0 then
If COwner(6)=PMe then
 If (COwner(5)<>PMe) and ((COwner(5)<>0) or (TOwner(31)=trunc(UBufferGet(36)))) then
  If TArmies(39)>TArmies(31) then
       Begin
       ToTerritory:=31;
       FromTerritory:=39;
       BypassStruggler:=True;
       end;



//If Asia occupied try Koryak attack
If TIsFront(1) then
If TArmies(1)>1 then
Begin //TIsFront(1)

If TOwner(37)=COwner(5) then
If( 
    (COwner(5)<>PMe) and 
    ((TArmies(1)>TArmies(37)) or ((TArmies(1)>3) and (TArmies(1)>trunc(0.8*TArmies(37)-0.7))))
   ) then
  Begin
   ToTerritory:=37;
   FromTerritory:=1;
   BypassStruggler:=True;
   //If UBufferGet(15) then //umessage('Try attack Koryak if Asia occupied');
  end;
  
      
      //Try attack someone for cards from Alaska
      TWeakestFront(1,ET,EA);
      If (SConquest=GO) and (FromTerritory=0) then
       If ( (TIsMine(1)=True) and (TArmies(1)>5) and (EA<4) ) then
       Begin
        ToTerritory:=ET;
        FromTerritory:=1;
        If (ET=37) and SConquest then FromTerritory:=0;
        //If UBufferGet(15) then //umessage('Try attack someone for cards from Alaska= ', ET );
       end;

//Don't attack Koryak from Alaska if not needed 
If ((FromTerritory=1) and (ToTerritory=37)) then
 If SConquest then
  Begin
   if UBufferGet(10)<>0 then C:=40 else C:=20;
   If ( (TArmies(1)<C) and (COwner(5)=0) and (PArmiesCount(PMe)<100+C) ) then FromTerritory:=0;
  end;
 
  
end; //TIsFront(1)


//Do not weaken Koryak if someone holds North America
If ((COwner(1)<>0) and (COwner(1)<>PMe) and (FromTerritory=37) and (TContinent(ToTerritory)=5) and (TArmies(ToTerritory)<=2) ) then UBufferSet(16,37); //Pass nothing

//Attack from Brazil for cards
If TIsMine(12) then 
If (FromTerritory=0) then
If ((SConquest=False) and (TArmies(12)>6) and (TArmies(12)>TArmies(14)+1) and (TIsMine(14)=False) and 
( (TArmies(14)=1) or (TArmies(14)<4) and (PTerritoriesCount(COwner(4))>11) )) then
  Begin
   ToTerritory:=14;
   FromTerritory:=12;
   UBufferSet(13,14);
  end;  



//Lame block attacks 
If FromTerritory=31 then
If ((ToTerritory=30) or (ToTerritory=32)) then
If (TArmies(ToTerritory)>3) or 
   ((TArmies(ToTerritory)>2) and ((TArmies(32)>5) or (TArmies(30)>5)) )
    or SConquest then
If (PArmiesCount(-(trunc(UBufferGet(10))))>40) and (UBufferGet(9)>=0) then
if PTerritoriesCount(PMe)<21 then
Begin
CAnalysis(5,PT,PA,ET,EA);
D:=0;
For T:=1 to 38 do
 If (TArmies(T)>30) then
  If (TOwner(T)=-(trunc(UBufferGet(10)))) then
   If PArmiesCount(-(trunc(UBufferGet(10))))-TArmies(T)<=TArmies(T) then
    Begin
    D:=T;
    T:=38;
    end;

If (PT>1) or (TArmies(ToTerritory)>2) then
if (TArmies(D)>TArmies(31)-TArmies(ToTerritory)+6) then
  If (TOwner(ToTerritory)<>-(trunc(UBufferGet(10)))) then
   Begin 
    FromTerritory:=0;
    //umessage('Lame block attacks ToTerritory ',ToTerritory);
   end;

end;

//Crazy Bubble
If UBufferGet(6)<>0 then
If FromTerritory=0 then
Begin

TWeakestFront(trunc(UBufferGet(6)),ET,EA);
If UBufferGet(39)=2 then C:=0 else C:=1;
If (TContinent(ET)=TContinent(trunc(UBufferGet(6)))) and (TArmies(trunc(UBufferGet(6)))-EA>C) then
Begin
FromTerritory:=trunc(UBufferGet(6));
ToTerritory:=ET;
//umessage('Crazy bub ', UBufferGet(6), '> ', ET);
end
 else
 UBufferSet(6,0);
 
end;


//Try get cards
If ((FromTerritory=0) or ((FromTerritory=trunc(UBufferGet(20))) and (trunc(UBufferGet(25))=1))) and (not SConquest) then
Begin

For T:=1 to 42 do
If TIsFront(T) then
If TArmies(T)>2 then
If COwner(TContinent(T))<>PMe then
If T<>trunc(UBufferGet(20)) then
Begin
TWeakestFront(T,ET,EA);
If EA=1 then
  Begin
   ToTerritory:=ET;
   FromTerritory:=T;
   //umessage('cards attak ', T, '> ', ET);
   T:=42;
  end;
end;

If FromTerritory=0 then
For T:=1 to 42 do
If TIsFront(T) then
If TArmies(T)=2 then
If COwner(TContinent(T))<>PMe then
If T<>trunc(UBufferGet(20)) then
Begin
TWeakestFront(T,ET,EA);
If EA=1 then
  Begin
   ToTerritory:=ET;
   FromTerritory:=T;
   //umessage('cards attak2 ', T, '> ', ET);
   T:=42;
  end;  
end;

If ((UBufferGet(9)<>0) or (UBufferGet(8)<>0)) and 
   ((FromTerritory=31) or (FromTerritory=32) or (FromTerritory=30) or 
   (FromTerritory=trunc(UBufferGet(20))) or (FromTerritory=trunc(UBufferGet(9))) or (ToTerritory=trunc(UBufferGet(9)))) then FromTerritory:=0;
end;


If (TContinent(ToTerritory)=1) or (TContinent(ToTerritory)=4) or (TContinent(ToTerritory)=3) then BypassStruggler:=True;
If (FromTerritory=27) or (ToTerritory=27) then BypassStruggler:=True;

If UBufferGet(25)=1 then
Begin 

If COwner(2)=PMe then
Begin
CAnalysis(1,PT,PA,ET,EA);
If ((PA+TArmies(10)>trunc(0.8*EA)) and (TContinent(ToTerritory)=1)) 
   or ((TContinent(FromTerritory)=2) and (COwner(TContinent(ToTerritory))<>0)) then BypassBubble:=True;
end;

If (TContinent(ToTerritory)=2) and (FromTerritory<>trunc(UBufferGet(20))) then BypassBubble:=True;
If (TContinent(ToTerritory)=1) and (COwner(2)=PMe) then BypassBubble:=True;
end;


//#########################BUBBLE ATTACK
a1:=FromTerritory;
a4:=ToTerritory;

//If (((TContinent(FromTerritory)=6) or (TContinent(ToTerritory)=6)) and (COwner(6)<>PMe)) then UBufferSet(25,0);


If (UBufferGet(25)=1) then
begin //buble
////If UBufferGet(15) then //umessage('before1 Bubble attack: FromTerritory= ',FromTerritory, '    ToTerritory= ', ToTerritory, '  W= ',W);

b:=trunc(UBufferGet(20));
NormalBubble:=True;
FromTerritory:=0;


If TIsFront(9) then
 If COwner(2)=PMe then
Begin
TWeakestFront(b,ET,EA);
 if EA>2 then
  if TContinent(trunc(UBufferGet(20)))>2 then
   If TArmies(trunc(UBufferGet(20)))-TArmies(9)<4 then UBufferSet(20,9);
end;

//Bubble attack to Alaska

CAnalysis(1,PT,PA,ET,EA);
A:=0;
If (b=33) or (b=37) then D:=TArmies(trunc(UBufferGet(20))) else D:=0;
If (TArmies(b)>EA+TArmies(33)+TArmies(37)-D+20) then A:=333;

If UBufferGet(36)<>0 then
If (COwner(6)<>-(trunc(UBufferGet(10)))) or (PTerritoriesCount(COwner(1))>26) then
If ( (UBufferGet(29)=0) and (PProgram(COwner(1))<>PProgram(PMe)) ) then //Cooperative
If (
   (COwner(1)=trunc(UBufferGet(36))) and 
   (COwner(1)<>0) and 
   ( ((TArmies(b)>TArmies(1)+6) and (COwner(6)=PMe)) or (TArmies(b)>TArmies(1)+20) )
   ) then A:=333;

If A=333 then
Begin //change (TArmies(37)<10)
If (TOwner(37)=COwner(1)) then C:=13 else C:=25;  //changed from 1.3 and 2.5

  If ( TIsBordering(33,b) and 
      (double(TArmies(33))<(double(TArmies(b)) / 3)) and
     ((double(TArmies(37))<((double(TArmies(b))/ (double(C)/10) )))) and  // divide by 10 to match change made above
      (TArmies(b)-TArmies(33)-TArmies(37)>TArmies(1)) and 
      (TIsMine(37)=False) and
      (TIsMine(33)=False) ) then Begin 
          ToTerritory:=33; FromTerritory:=b; UBufferSet(13,ToTerritory); end;

T:=0;
If Not TIsMine(35) then T:=35;
If Not TIsMine(36) then T:=36;
If ( (Not TIsMine(35)) and (Not TIsMine(36)) and (TArmies(35)< TArmies(36)) ) then T:=35;
If ( (Not TIsMine(35)) and (Not TIsMine(36)) and (TArmies(35)>=TArmies(36)) ) then T:=36;

If ( (T<>0) and (TArmies(T)<=TArmies(33)) ) then
  If ( TIsBordering(T,b) and 
      (double(TArmies(T))<(double(TArmies(b)) / 3)) and
     ((double(TArmies(37))<(double(TArmies(b)) / (double(C)/10) ))) and  // divide by 10 to match change made above
      (TArmies(b)-TArmies(T)-TArmies(37)>TArmies(1)) and 
      (TIsMine(37)=False) and
      (TIsMine(T)=False) ) then Begin ToTerritory:=T; FromTerritory:=b; UBufferSet(13,ToTerritory); end;
      
      
  If ( TIsBordering(37,b) and 
      (TIsMine(37)=False) and
     ((double(TArmies(37))<(double(TArmies(b)) / (double(C)/10) ))) and
      (TArmies(37)+TArmies(1)<TArmies(b))
  ) then Begin ToTerritory:=37; FromTerritory:=b; UBufferSet(13,ToTerritory); end;
  
  If ( TIsBordering(1,b) and (TIsMine(1)=False) ) then Begin ToTerritory:=1; FromTerritory:=b; end;

  
  If ToTerritory=1 then
   If (TArmies(b)>EA+15) or ((TArmies(b)>EA) and (EA<18)) then 
    Begin
    UBufferSet(13,1);
    If (TArmies(b)>EA+15) then UBufferSet(7,1);
    If (TArmies(b)>EA+2) and (COwner(6)=PMe) then UBufferSet(7,1);
    end;  
    
    

  If FromTerritory=0 then NormalBubble:=True else NormalBubble:=False;
end;


//Bubble attack to Australia
CAnalysis(6,PT,PA,ET,EA);
If ( (UBufferGet(29)=0) and (PProgram(COwner(6))<>PProgram(PMe)) ) then //Cooperative
IF ( ( (TArmies(b)>TArmies(31)+EA+12) and (b<>31) and (COwner(6)<>PMe) ) OR
     ( (b=31) and (TArmies(b)>EA+8) and (COwner(6)<>PMe) ) 
    ) then
If Not ((PTerritoriesCount(trunc(UBufferGet(36)))>24) and (COwner(6)<>trunc(UBufferGet(36)))) then
If NOT ( (UBufferGet(36)>0) and (UBufferGet(36)<>-UBufferGet(10)) and (Cowner(6)=-(trunc(UBufferGet(10)))) ) then
 Begin
  If ( TIsBordering(33,b) and (TIsMine(33)=False) and (TIsMine(32)=False) and (TIsMine(31)=False) and (double(TArmies(33))<(double(TArmies(b)) / 3)) and (TArmies(33)+TArmies(32)+TArmies(31)+EA<TArmies(b)) ) then
  Begin 
  ToTerritory:=33; 
  If (b=28) and (TIsMine(29)=False) and (TArmies(29)<TArmies(33)) then ToTerritory:=29; 
  FromTerritory:=b; 
  UBufferSet(13,ToTerritory); 
  end;
  
  If ( TIsBordering(30,b) and (TIsMine(30)=False) and (TIsMine(31)=False) and (TArmies(b)>TArmies(31)+TArmies(30)+EA)) then Begin ToTerritory:=30; FromTerritory:=b; UBufferSet(13,ToTerritory); end;
  If ( TIsBordering(32,b) and (TIsMine(32)=False) and (TIsMine(31)=False) and (TArmies(b)>TArmies(31)+TArmies(32)+EA)) then Begin ToTerritory:=32; FromTerritory:=b; UBufferSet(13,ToTerritory); end;
  
  If ( TIsBordering(32,b) and TIsBordering(30,b) and (TArmies(32)<=TArmies(30)) and (TIsMine(31)=False) and (TIsMine(32)=False) and (TArmies(b)>TArmies(31)+TArmies(32)+EA)) then Begin ToTerritory:=32; FromTerritory:=b; UBufferSet(13,ToTerritory); end;
  If ( TIsBordering(32,b) and TIsBordering(30,b) and (TArmies(32)> TArmies(30)) and (TIsMine(31)=False) and (TIsMine(30)=False) and (TArmies(b)>TArmies(31)+TArmies(30)+EA)) then Begin ToTerritory:=30; FromTerritory:=b; UBufferSet(13,ToTerritory); end;

  If ( TIsBordering(31,b) and (TIsMine(31)=False) ) then Begin ToTerritory:=31; FromTerritory:=b; UBufferSet(13,ToTerritory); end;
  If ( TIsBordering(39,b) and (TIsMine(39)=False) ) then Begin ToTerritory:=39; FromTerritory:=b; end;
  If b=39 then UBufferSet(25,0);
 
  If FromTerritory=0 then NormalBubble:=True else NormalBubble:=False;
 end;
 
 //Bubble attack to S.A.
If (b>6) and (b<28) then
Begin

 C:=1000;
 For T:=15 to 27 do
  If
  TIsBordering(b, T) and 
  TIsBordering(T, 14) and 
  (NOT TIsMine(T)) and
  (TArmies(T)<C) then
  Begin
   A:=T;
   C:=TArmies(T);
  end;
 
 CAnalysis(2,PT,PA,ET,EA);
 If (COwner(2)=trunc(UBufferGet(36))) and (COwner(2)<>0) and ((UBufferGet(10)=0) or (COwner(2)=-(trunc(UBufferGet(10))))) then D:=12 else D:=25;
 If TIsBordering(b, 9) then
 If TArmies(b)>EA+D+TArmies(9)+4+(TArmies(14) div 3) then
 If Not TIsMine(9) then
 Begin
  ToTerritory:=9;
  FromTerritory:=b;
  NormalBubble:=False;
  UBufferSet(13,ToTerritory); 
 End;
 
 If (b=9) then
 If TArmies(b)>EA+D+(TArmies(14) div 3) then
 If Not TIsMine(10) then
 Begin
  ToTerritory:=10;
  FromTerritory:=b;
  NormalBubble:=False;
  UBufferSet(13,ToTerritory); 
 End;
 
 
 If TIsBordering(b, A) then
 If ((TArmies(b)>EA+D+C+TArmies(14)) and (Not TIsMine(14))) and 
 ((EA<35) OR ((trunc(UBufferGet(36))=COwner(2)) and (COwner(2)<>0)) )  then
 If (b<>27) or (COwner(6)<>PMe) then
 Begin
  ToTerritory:=A;
  FromTerritory:=b;
  NormalBubble:=False;
  UBufferSet(13,ToTerritory); 
 End;
 
 If TIsBordering(14,b) or (b=14) then
Begin
 
 If ((TArmies(b)>EA+D+TArmies(14)) and (Not TIsMine(14)) and ((EA<35) OR (trunc(UBufferGet(36))=TOwner(13))) ) then
 Begin
 ToTerritory:=14; 
 FromTerritory:=b; 
 NormalBubble:=False;
 UBufferSet(13,ToTerritory); 
 end;

 If (TArmies(b)>EA+D-1) and (Not TIsMine(12)) and (b=14) then
   Begin
   ToTerritory:=12; 
   FromTerritory:=b; 
   NormalBubble:=False;
   UBufferSet(13,ToTerritory); 
   end;
end;
end;//S.A. Bubble attack


If NormalBubble then
Begin //NormalBubble
 If (SConquest=False)  then 
  begin 
        If (UBufferGet(24)=1) then W:=1 else W:=27;
        If (UBufferGet(24)<>1) then
        Begin
        If COwner(3)<>0 then W:=22;
        If COwner(4)<>0 then W:=15;
        end;
Bubble1:
        
        FromTerritory:=0;
        ToTerritory:=0;
        a:=99999;
        b:=trunc(UBufferGet(20));
        For T:=W to 42 do //delimiter
         If TIsBordering(T,b) then
          If NOT TIsMine(T) then
          Begin
           If (TArmies(T)<a) or 
          ((TOwner(T)=trunc(UBufferGet(36))) and (TOwner(ToTerritory)<>trunc(UBufferGet(36))) and (TArmies(T)<=a+1))
            then begin a:=TArmies(T); ToTerritory:=T; end;
          end;

D:=trunc(URandom(101));

if ( (UBufferGet(21)=1) or (TArmies(ToTerritory)<3) or ((UBufferGet(21)=0) and (D>80)) ) then   //changed to 80 from .8
  If ( (TArmies(ToTerritory)<4) and (ToTerritory<>0) ) then 
          Begin  //20%
          FromTerritory:=b;
          UBufferSet(21,1);
          end
         else 
          Begin
          FromTerritory:=0;
          UBufferSet(21,0);
          end;

IF (D<80) or (UBufferGet(21)=2) THEN  // changed from .8
  If ( ((double(TArmies(ToTerritory))<(double(TArmies(b)) / 10)) or (TArmies(ToTerritory)<4)) and (ToTerritory<>0) ) then
Begin
FromTerritory:=b;

If UBufferGet(21)=0 then
 If NOT ((ToTerritory=33) and (TArmies(ToTerritory)<5)) then
  If TArmies(ToTerritory)>2 then
Begin
If (TArmies(ToTerritory)>3) and (URandom(0)<0.8) and (URandom(0)<(double(TArmies(ToTerritory))/10)) then FromTerritory:=0;

If (COwner(6)<>PMe) and (TArmies(ToTerritory)>2) and (URandom(0)<0.7) and (URandom(0)<(double(TArmies(ToTerritory)))/8) then FromTerritory:=0;
end;

UBufferSet(21,2);
end;

If TArmies(b)<4 then FromTerritory:=0;
  
end; //sconquest false




          
//Randomize the bubble movement a bit
If a1=b then
If ( ((URandom(0)>0.15) or (TOwner(a4)=-(trunc(UBufferGet(10))))) and (FromTerritory=b)) then
 If (TArmies(ToTerritory)=TArmies(a4)) or (TOwner(a4)=-(trunc(UBufferGet(10)))) then
 If ((a4<>22) and (a4<>28) and (a4<>29) and (a4<>3) and (a4<>1) and (a4<>37)) or (TOwner(a4)=-(trunc(UBufferGet(10)))) then 
 If COwner(6)=PMe then
 If TArmies(b)>3 then
  Begin
  FromTerritory:=a1;
  ToTerritory:=a4;
  If TContinent(a4)<>5 then UBufferSet(17, 1);
  ////umessage('random movement');
  end;
 
//Territory Preferences
//If ((trunc(UBufferGet(36))<>COwner(3)) or (trunc(UBufferGet(36))<>COwner(4))) and (UBufferGet(36)<>0) then
If (ToTerritory=27) and (FromTerritory=29) and (TArmies(28)=TArmies(27)) and (NOT TIsMine(28)) and TIsFront(28) then ToTerritory:=28;

If TIsBordering(FromTerritory,33) then
 If (TArmies(33)=TArmies(ToTerritory)) and (NOT TIsMine(33)) then ToTerritory:=33;

If (W>1) then
 If ((COwner(TContinent(ToTerritory))=0) or (FromTerritory=0)) then
  If ((TArmies(ToTerritory)>1) or (FromTerritory=0)) then
Begin
W:=1;
Goto Bubble1;
end;



UBufferSet(17, 0);

If (
((FromTerritory=0) and (a1<>b) and (a1<>31) and 
((a1<>39) or (TArmies(31)<5)) and (SConquest=False)) 
or BypassBubble 
or ((a1=14) and (TContinent(ToTerritory)=3) and (COwner(2)=PMe))

) then // and (a1>34)
          Begin
          FromTerritory:=a1;
          ToTerritory:=a4;
          If (a1=b) then
           If (TContinent(ToTerritory)<>5) and (TContinent(b)=5) then 
           Begin
           UBufferSet(17, 1); //don't change the bubble position in this attack
           UBufferSet(16,b); //Pass nothing
           end;
          end;



end; //NormalBubble
If b=39 then UBufferSet(25,0);


If (FromTerritory=b) and (TContinent(ToTerritory)=5) then UBufferSet(17, 0);

If (FromTerritory=0) and (COwner(6)=0) then
Begin
CAnalysis(6,PT,PA,ET,EA);
If TIsMine(39) and (TArmies(39)-4>EA) and (PT=1) then 
 Begin
 If TArmies(40)>=TArmies(42) then T:=42 else T:=40;
 ToTerritory:=T;
 FromTerritory:=39;
 BypassStruggler:=True;
 end;
end;

end; //bubble 



//Hold the Wyrm's result in the case players=2
XX:=FromTerritory;
YY:=ToTerritory;

end;
    


    //Go STRUGGLER attack if a bug is found
    

   If FromTerritory<>0 then 
    If ( (TIsMine(ToTerritory)=True) or 
         (TIsMine(FromTerritory)=False) or
         (TArmies(FromTerritory)<=1) or
         (TIsBordering(ToTerritory, FromTerritory)=False)
        )
     then 
        Begin
        a4:=222;
        //umessage('Attack bug found!!! Report it and receive the latest version of Frank. Attacking with STRUGGLER: FromTerritory= ', FromTerritory,'  ToTerritory= ', ToTerritory);
        end;
        
  If (UBufferGet(39)=2) then
   If 	(FromTerritory<12) and (FromTerritory>25) then ByPassStruggler:=True;

//Attack with struggler if strong player and 3 players
attack3:=False;
If FromTerritory=0 then
if UBufferGet(39)=3 then  
if (
((PTerritoriesCount(COwner(3))>20) and (COwner(3)<>PMe)) or
((PTerritoriesCount(COwner(1))>20) and (COwner(1)<>PMe)) or
((PTerritoriesCount(COwner(5))>20) and (COwner(5)<>PMe)) or
((PTerritoriesCount(COwner(6))>20) and (COwner(6)<>PMe)) or
((PTerritoriesCount(COwner(4))>20) and (COwner(4)<>PMe))
) then
attack3:=True;



  
//###STRUGGLER
If ((BypassStruggler=False) or (a4=222) or attack3) then
Begin

If ((a4=222) or attack3 or (UBufferGet(19)<>0) or (UBufferGet(39)=2)) then 
//If FromTerritory=0 then
BEGIN
 
begin
  // perform the attack with highest point value if force ratio>=1.2
  FromTerritory:=0;
  ToTerritory:=0;
  MaxValue:=0;
  // scan all territories
  for T:=1 to 42 do begin
    if TIsFront(T)                      // territory is mine and front
    and (TArmies(T)>1) then begin       // and attack is possible
      // scan all possible fronts
      FCount:=TFrontsCount(T);
      for F:=1 to FCount do begin
        T2:=TFront(T,F);
        Ratio :=double( TArmies(T) ) / TArmies(T2);
        if Ratio>=1.2 then begin
          Value:=Eval(T,T2);
          // consider only strategic attacks
          if Value>=1.0 then begin
            if Value>MaxValue then begin
              FromTerritory:=T;
              ToTerritory:=T2;
              MaxValue:=Value;
            end;
          end; 
        end;
      end;
    end;
  end;
end;



//## Struggler rules
 // attack Australia with China if viable#
 If not TIsMine(31) then
 If TIsMine(32) then
    If ( ((TArmies(32)>TArmies(30)) and TIsMine(30)) or (TIsMine(30)=False) ) then
      If ( (TIsMine(39)=False) and 
           (TIsMine(40)=False) and
           (TIsMine(41)=False) and
           (TIsMine(42)=False) and
           (TArmies(31)+TArmies(39)+TArmies(40)+TArmies(41)<TArmies(32))
          ) then 
      Begin
      ToTerritory:=31;
      FromTerritory:=32;
      end;
     
      
      B:=5;
      //attack India from Middle East if can get Indonesia later#
      If ((TArmies(27)-B>TArmies(30)+TArmies(31)+TArmies(39)) and
          (TIsMine(27)=True) and 
          (TIsMine(30)=False) and 
          (TIsMine(31)=False) and
          (TIsMine(39)=False) 
         ) 
        then
          Begin
          ToTerritory:=30;
          FromTerritory:=27;
          B:=0;
          end;
          
//Attack Af 
If TIsMine(12) then
 If COwner(4)<>0 then 
  If COwner(4)<>PMe then 
   If TArmies(12)>TArmies(14) then
         Begin
          ToTerritory:=14;
          FromTerritory:=12;
         end;
         
If COwner(1)<>0 then
if COwner(1)<>PMe then
Begin //c1<>PMe

//Prepare to get Koryak to get Alaska#
If( TIsMine(33) and 
    (TIsMine(37)=False) and
    (TArmies(33)>TArmies(37)+1) 
   ) then
  Begin
   ToTerritory:=37;
   FromTerritory:=33;
   //If UBufferGet(15) then //umessage('Try Koryak from Mongolia if North America occupied ######');
   UBufferSet(27,37);
   UBufferSet(28,9999);
  end;
  
  
//Brazil to Venezuela if can get Mexico#
If( 
     TIsMine(12) and 
    (TIsMine(10)=False) and
    (TArmies(12)>TArmies(10)+TArmies(9)+1)
   ) then
  Begin
   ToTerritory:=10;
   FromTerritory:=12;
   //If UBufferGet(15) then //umessage('Brazil to Venezuela to get Mexico');
  end;

// Venezuela to Mexico if North America occupied#
If( 
     TIsMine(10) and 
    (TArmies(10)>TArmies(9))
   ) then
  Begin
   ToTerritory:=9;
   FromTerritory:=10;
   //If UBufferGet(15) then //umessage('Try get in North America from Venezuela');
  end;
  
end; //c1<>PMe
 
 
//If UBufferGet(15) then //umessage('Struggler end: ToTerritory:=',ToTerritory, '  FromTerritory:=', FromTerritory, '  SConquest= ', SConquest);

END; //STRUGGLER

end; //BypassStruggler=False

//All players Rules


//Attack Mexico with strongest territory
If ToTerritory=9 then
 If TIsMine(7) and TIsMine(8) then
  If ((FromTerritory=7) or (FromTerritory=8)) and (TArmies(9)<3) then
   If TArmies(7)>TArmies(8) then FromTerritory:=7 else FromTerritory:=8;


//Attack optimization to 2 and 3 players
X:=0; 
Y:=0;
D:=0;
If (FromTerritory=0) then
//If (UBufferGet(39)=2) or ((UBufferGet(39)=3) and (PTerritoriesCount(trunc(UBufferGet(36)))>20) ) then
If (UBufferGet(39)=2) or attack3 then
If (PTerritoriesCount(PMe)<=42-12) or (NOT SConquest) then 
If UBufferGet(25)=0 then
For T:=1 to 42 do
If TIsfront(T) or (T=42) then
  If (TArmies(T)>3+D) or (T=42) then
   If (FromTerritory=0) or ((TArmies(ToTerritory)>1) and (FromTerritory<>0)) then
    If (COwner(TContinent(T))<>PMe) or (TArmies(T)>6) then
     If NOT (attack3 and (PTerritoriesCount(TOwner(T))<12) and SConquest) then
    Begin
    If T<>42 then
    Begin //<>42
    TWeakestFront(T, ET,EA);
    
     If EA=1 then
     Begin
      FromTerritory:=T;
      ToTerritory:=ET;
     end;
     
     if EA>1 then
     If ((TArmies(ToTerritory)>1) and (FromTerritory<>0)) or (FromTerritory=0) then
     If TArmies(T)-EA>2+D then
     If (FromTerritory=0) or ((TArmies(T)-EA>TArmies(FromTerritory)-TArmies(ToTerritory)) and (FromTerritory<>0)) then
     Begin
      FromTerritory:=T;
      ToTerritory:=ET;
     end;
     
     Ea2:=666; 
     //umessage(FromTerritory, ToTerritory);
     
     
     If (FromTerritory=31) and (COwner(6)=PMe) and (TArmies(31)+TArmies(39)<7) then FromTerritory:=0;
     
     If (FromTerritory=20) and (COwner(1)=PMe) and (TArmies(3)<4) then FromTerritory:=0;
     If (FromTerritory=37) and (COwner(1)=PMe) and (TArmies(1)<4) then FromTerritory:=0;
     If (FromTerritory=14) and (COwner(2)=PMe) and (TArmies(12)<4) then FromTerritory:=0;
     If (FromTerritory=27) and ((COwner(3)=PMe) or (COwner(4)=PMe)) and (TArmies(27)<10) then FromTerritory:=0;
//     If (((FromTerritory>8) and (FromTerritory<13)) and (TArmies(FromTerritory)<11)) and ((COwner(1)=PMe) or (COwner(4)=PMe)) then FromTerritory:=0;
     If (FromTerritory=31) and (ToTerritory=32) and SConquest and (COwner(6)=PMe) and (UBufferGet(39)=3) then FromTerritory:=0;
     //If (UBufferGet(39)=3) and (TOwner(ToTerritory)<>trunc(UBufferGet(36))) then FromTerritory:=0;

If attack3 and SConquest then
 If ((PTerritoriesCount(TOwner(ToTerritory))<21) and (trunc(UBufferGet(36))<>TOwner(ToTerritory))) then FromTerritory:=0;
     
     If FromTerritory<>0 then 
     Begin
      Y:=ToTerritory;
      X:=FromTerritory;
     end;

     If FromTerritory=0 then 
     Begin
      ToTerritory:=Y;
      FromTerritory:=X;
     end;
     
     end;//dif 42
     
     //umessage('ttttttttttttttt', D, T, 'FromTerritory ',FromTerritory);
     
   If (D=0) and (T=42) and (FromTerritory=0) then 
      Begin D:=-1; T:=1; 
      //umessage('DDDDDDDDDDDDDDDDd', D, T); 
      end;
      
//If (COwner(TContinent(FromTerritory))=PMe) then C:=1;     
If (FromTerritory<>0) and (COwner(TContinent(FromTerritory))<>PMe) then UBufferSet(11,ToTerritory) else UBufferSet(11,0);
     
    end;

If Not (UBufferGet(39)>2) then
If (a4<>222) and (XX<>0) and (YY<>0) and ( (FromTerritory=0) or (TContinent(XX)=2) or (TContinent(YY)=2) or (TContinent(XX)>4) or (XX=1) or (YY=1) or (XX=3) or (YY=3) or (YY=9) ) then
Begin
FromTerritory:=XX;
ToTerritory:=YY;
end;


//Lame Bubble
If TArmies(30)<=TArmies(32) then C:=TArmies(30) else C:=TArmies(32);

If TIsMine(31) then
If NOT (TIsMine(30) and TIsMine(32)) then
If PTerritoriesCount(-(trunc(UBufferGet(10))))<3 then
If PArmiesCount(-(trunc(UBufferGet(10))))>70 then
 If (UBufferGet(36)=0) then  //##=0 ok
  If (COwner(6)=PMe) then
   If PArmiesCount(-(trunc(UBufferGet(10))))+10<TArmies(31)-C then
   Begin
   A:=0; For T:=1 to 38 do If (A=0) and (TOwner(T)=-(trunc(UBufferGet(10)))) then A:=T;
   
 If (TArmies(A)>=PArmiesCount(-(trunc(UBufferGet(10))))-1) or (TArmies(A)=1) then UBufferSet(8, 31);
 
 //If (PTerritoriesCount(trunc(UBufferGet(36)))>18) then UBufferSet(8, 31);
 end;


If (UBufferGet(8)<>0) then
Begin
If (ToTerritory<>31) and (FromTerritory<>31) and (trunc(UBufferGet(8))=FromTerritory) then FromTerritory:=0;
 
If PArmiesCount(-(trunc(UBufferGet(10))))=0 then UBufferSet(8, 0);

If (UBufferGet(8)=31) then
 Begin
 If TIsMine(31) and (Not TIsMine(30)) then
 If (TArmies(30)<TArmies(32)) and (double( TArmies(30) ) < double( TArmies(31) )/10) then
  Begin
  ToTerritory:=30;
  FromTerritory:=31;
  UBufferSet(8, 30);
  UBufferSet(13, 30);
  end;
  
 If TIsMine(31) and (Not TIsMine(32)) then
 If (TArmies(30)>=TArmies(32)) and (double( TArmies(32) ) < (double( TArmies(31) )/10)) then
  Begin
  ToTerritory:=32;
  FromTerritory:=31;
  UBufferSet(8, 32);
  UBufferSet(13, 32);
  end;
  //umessage('lame bubble att');
  UBufferSet(9, 444);
 end;

 


If TIsMine(trunc(UBufferGet(8))) then
 If TIsBordering(31, trunc(UBufferGet(8))) then
Begin
CAnalysis(6,PT,PA,ET,EA);
If (Not TIsMine(31)) and (TArmies(trunc(UBufferGet(8)))>trunc(0.9*(TArmies(31)+EA))) then
  Begin
  ToTerritory:=31;
  FromTerritory:=trunc(UBufferGet(8));
  UBufferSet(13, 31);
  If (UBufferGet(9)=444) and (TOwner(39)<>-(trunc(UBufferGet(10)))) then UBufferSet(9, 555);
  end;

If TIsMine(trunc(UBufferGet(8))) and (TArmies(trunc(UBufferGet(8)))<22) and (TArmies(31)>21) 
 and TIsMine(31) and (COwner(6)=PMe) then UBufferSet(8, 0);
 
If TIsMine(31) then C:=0 else C:=TArmies(31);

If (UBufferGet(8)=30) or (UBufferGet(8)=32) then
If TIsMine(trunc(UBufferGet(8))) then
If (double(TArmies(trunc(UBufferGet(8))))<(0.9*(C+EA))) then
If TArmies(trunc(UBufferGet(8)))>TArmies(trunc(UBufferGet(20)))+5 then
Begin
UBufferSet(20,UBufferGet(8));
UBufferSet(25,1);
UBufferSet(8,0); 
end;

end;
 
end;//lame b.

 
//########Aust. - N.A. Attack  
If TIsMine(31) then
If COwner(6)=PMe then
If (TArmies(31)>70-PTerritoriesCount(trunc(UBufferGet(36)))) or (UBufferGet(9)<>0) then
If (NOT TIsMine(32)) and (NOT TIsMine(33)) and (NOT TIsMine(37)) and (NOT TIsMine(1)) then
If (UBufferGet(10)<0) or ((PTerritoriesCount(COwner(1))>22) and (COwner(1)<>PMe)) then

Begin
CAnalysis(1,PT,PA,ET,EA);
//If (PArmiesCount(-(trunc(UBufferGet(10))))>100) OR 
//   ((COwner(1)=trunc(UBufferGet(36))) and (PTerritoriesCount(-(trunc(UBufferGet(10))))>16)) OR
//    then
If ((COwner(1)<>0) and (trunc(UBufferGet(36))=COwner(1))) and (PArmiesCount(COwner(1))>60) 
then C:=10+3*trunc(UBufferGet(39)) else C:=36+3*trunc(UBufferGet(39));
If (PTerritoriesCount(COwner(1))>25) then C:=0;
D:=0;
If TOwner(20)=-(trunc(UBufferGet(10))) then D:=TArmies(20)-5;
If TOwner(10)=-(trunc(UBufferGet(10))) then D:=TArmies(10)-5;


if (double(TArmies(32))+TArmies(33)+TArmies(37)<(double(TArmies(31)) / 3)) or ((COwner(1)<>0) and (trunc(UBufferGet(36))=COwner(1))) then
 If TArmies(32)+TArmies(33)+TArmies(37)+TArmies(10)+TArmies(20)+EA+C-D<TArmies(31) then 
Begin
ToTerritory:=32;
FromTerritory:=31;
UBufferSet(9, 32);
UBufferSet(13, 32);
UBufferSet(25, 0); //Frank is not in Bubble Mode
If PTerritoriesCount(trunc(UBufferGet(36)))<15+2*trunc(UBufferGet(39)) then
 If PArmiesCount(-(trunc(UBufferGet(10))))>35 then UBufferSet(8, -1); //Stop one round
end;
end;

//######Aust. - S.A. Attack  
If TIsMine(31) then
//If COwner(6)=PMe then
If (TArmies(31)>50) or (UBufferGet(9)<>0) then
If (NOT TIsMine(30)) and (NOT TIsMine(27)) and (NOT TIsMine(26)) then
If ((COwner(4)=COwner(3)) and ((COwner(2)=COwner(1)) or (COwner(2)=COwner(3))) and (COwner(2)<>PMe) and (COwner(2)<>0) and (COwner(2)<>PMe)) then
If PTerritoriesCount(COwner(2))>20 then 
If UBufferGet(9)<>32 then

Begin
CAnalysis(2,PT,PA,ET,EA);
If PTerritoriesCount(COwner(2))>29 then C:=7 else 
Begin If (UBufferGet(9)=30) then C:=16 else C:=20; end;

If TArmies(30)+TArmies(27)+TArmies(26)+TArmies(14)+EA<TArmies(31)-C-3*trunc(UBufferGet(39)) then
Begin
ToTerritory:=30;
FromTerritory:=31;
UBufferSet(9, 30);
UBufferSet(13, 30);
UBufferSet(25, 0); //Frank is not in Bubble Mode
end;
end;



If UBufferGet(9)<>0 then
If (UBufferGet(9)<444) then
Begin
//CAnalysis(1,PT,PA,ET,EA);



if false then
if (UBufferGet(9)=33) then
 If COwner(6)=PMe then
 If PArmiesCount(-(trunc(UBufferGet(10))))>80 then
  If ((PTerritoriesCount(COwner(1))>15) and (PTerritoriesCount(COwner(1))<27) and 
  (COwner(1)=trunc(UBufferGet(36)))) then UBufferSet(8, -1); //Stop one round

If TArmies(27)<40 then C:=3 else C:=8;
If COwner(3)=0 then C:=1;

if (UBufferGet(9)=30) and TIsMine(30) then UBufferSet(9, 27);
if (UBufferGet(9)=27) and TIsMine(27) then
 Begin
 If (TArmies(26)-TArmies(15)<C) then UBufferSet(9, 26) else UBufferSet(9, 15);
 If (UBufferGet(9)=15) and (TArmies(16)<TArmies(15)) then UBufferSet(9, 16);
 end;
 
If (UBufferGet(9)=26) and TIsMine(26) then 
Begin 
UBufferSet(9, 0);
UBufferSet(25, 1);
UBufferSet(20, 26);
UBufferSet(24, 1);
end;
If (UBufferGet(9)=15) and TIsMine(15) then 
Begin 
UBufferSet(9, 0);
UBufferSet(25, 1);
UBufferSet(20, 15);
UBufferSet(24, 1);
end;
If (UBufferGet(9)=16) and TIsMine(16) then 
Begin 
UBufferSet(9, 0);
UBufferSet(25, 1);
UBufferSet(20, 16);
UBufferSet(24, 1);
end;

                                                  // bug fix (by NS) #*#
if (UBufferGet(9)=27) and (NOT TIsMine(27)) and TIsMine(30) then
 Begin
  ToTerritory:=27;
  FromTerritory:=30;
  UBufferSet(13, 27);
 end;

If TIsMine(27) then begin // bug fix (by NS) #*#
 if (UBufferGet(9)=26) and (NOT TIsMine(26)) then
 Begin
  ToTerritory:=26;
  FromTerritory:=27;
  UBufferSet(13, 26);
 end;

 if (UBufferGet(9)=15) and (NOT TIsMine(15)) then
 Begin
  ToTerritory:=15;
  FromTerritory:=27;
  UBufferSet(13, 15);
 end;

 if (UBufferGet(9)=16) and (NOT TIsMine(16)) then
 Begin
  ToTerritory:=16;
  FromTerritory:=27;
  UBufferSet(13, 16);
 end;
end;
 
if (UBufferGet(9)=32) and TIsMine(32) then UBufferSet(9, 33);
if (UBufferGet(9)=33) and TIsMine(33) then UBufferSet(9, 37);
if (UBufferGet(9)=37) and TIsMine(37) then UBufferSet(9, 1);
If (UBufferGet(9)=1)  and TIsMine( 1) then Begin UBufferSet(9, 0); UBufferSet(25, 0); end;
//If (NOT TIsMine(39)) and (NOT TIsMine(32)) then UBufferSet(9, 0);

if (UBufferGet(9)=33) and (NOT TIsMine(33)) then
 if TIsMine(32) then
 Begin
  ToTerritory:=33;
  FromTerritory:=32;
  UBufferSet(13, 33);
  
If (UBufferGet(9)=33) then
if ((TArmies(33)>40) and (TOwner(33)<>trunc(UBufferGet(36))) and (NOT TIsMine(33))) or
   ((TArmies(37)>40) and (TOwner(37)<>trunc(UBufferGet(36))) and (NOT TIsMine(37))) then
Begin
UBufferSet(9, 0);
UBufferSet(8, 32);
end;

 end;
 

if (UBufferGet(9)=37) and (NOT TIsMine(37)) then
 if TIsMine(33) then
 Begin
  ToTerritory:=37;
  FromTerritory:=33;
  UBufferSet(13, 37);
 end;
 
if UBufferGet(9)=1 then
 if TIsMine(37) and (NOT TIsMine(1)) then
 Begin
  ToTerritory:=1;
  FromTerritory:=37;
  UBufferSet(13, 1);
  UBufferSet(7,1);
 end;


//umessage('ALASKA ATTACK= ', UBufferGet(9) );
If (UBufferGet(9)<>0) and (TArmies(FromTerritory)<7) then UBufferSet(9, 0);

end;



//end the turn
If (UBufferGet(9)<>0) then
If ((UBufferGet(8)=-1) and TIsMine(32)) 
 then 
 Begin
  If (TOwner(39)<>-(trunc(UBufferGet(10)))) then FromTerritory:=0;
  UBufferSet(8, 0);
 end;

 
If (UBufferGet(9)=555) then 
  Begin
  FromTerritory:=0;
  UBufferSet(9, 0);
  end;
  

//conquest mode
If UBufferGet(7)<>0 then
If ToTerritory<>20 then
Begin

If TIsMine(4) and (Not TIsMine(7)) and (TArmies(4)>TArmies(7)) then Begin FromTerritory:=4; ToTerritory:=7; end;

If TIsMine(5) and (Not TIsMine(4)) and (TArmies(5)>TArmies(4)) then Begin FromTerritory:=5; ToTerritory:=4; end;

If TIsMine(6) and (Not TIsMine(5)) and (TArmies(6)>TArmies(5)) then Begin FromTerritory:=6; ToTerritory:=5; end;

If TIsMine(1) and (Not TIsMine(2)) and (TArmies(1)>TArmies(2)) then Begin FromTerritory:=1; ToTerritory:=2; end;

If TIsMine(2) and (Not TIsMine(3)) and (TArmies(2)>TArmies(3)) then Begin FromTerritory:=2; ToTerritory:=3; end;

If TIsMine(3) and (Not TIsMine(6)) and (TArmies(3)>TArmies(6)) then Begin FromTerritory:=3; ToTerritory:=6; UBufferSet(25,0); UBufferSet(24,0); end;

end;

 
 
//Plays Strugger until 4 territories are conquered
If (PTerritoriesCount(PMe)>(UBufferGet(19))+4) then UBufferSet(19,0); 

UBufferSet(30, 0); //End of the First placement 
////If UBufferGet(15) then //umessage('Final2: ToTerritory:=',ToTerritory, '  FromTerritory:=', FromTerritory, '  SConquest= ', SConquest);

// code added by Nathan Scarbrough 5-31-10
// When Frank was written the PCardTurnInValue function didn't exist.
// This code takes Card Turn in value into account
// if no attack then check to see if it would be wise to get a card

  if (ToTerritory = 0) and (not SCardsBasedOnCombo) and (not SConquest) then begin
    Vexer:= 0;
    For P:= 1 to 10 do if (PProgram(P) = 'vexer.trp') and PAlive(P) then vexer:= P;
    if (not (  (PArmiesCount(PMe) < 11) and (PArmiesCount(Vexer) > 20) and ( (PCardCount(PMe) > 1) or (PCardCount(PMe) + PCardCount(Vexer) >= 4) )  ))
     or (PCardCount(PMe) + PCardCount(Vexer) >= 5) then begin

      CForce:= (PCardTurnInValue(PMe) div 3) + 2;
      // if I haven't earned a card in the last 3 turns then increase CForce
      if (bg(61) > 2) and (not SCardsBasedOnCombo) then begin
      if GameHasOneHuman(P) and (  PArmiesCount(P) > ( trunc(0.9 * double(PArmiesCount(PMe))) )  ) then
        CForce:= trunc(double(CForce) * 1.4 * double(bg(61) - 1)) + 2
      else
        CForce:= trunc(double(CForce) * 1.8 * double(bg(61) - 1)) + 3;
      end;
      // look for the attack with the best chance to win
      MaxPoints:=0;
      Points:= 0;
      for T:=1 to 42 do begin
        if TIsFront(T) and (TArmies(T) > 2) then begin
          TWeakestFront(T, ET, EA);
          if (EA < CForce) and (TArmies(T) > EA) then begin
            Points:= (1/double(EA)) - (1/double(TArmies(T)));
            if (Points > MaxPoints) then begin
              MaxPoints:= Points;
              FromTerritory:= T;
              ToTerritory:= ET;
            end;
          end;
        end;
      end;
    end;
  end;
end;

// procO
procedure Occupation(FromTerritory, ToTerritory: integer; var Armies: integer);
var
  FromIsFront, ToIsFront: boolean;
  EA, ET, Buffer ,LP,LT,LA, trail ,PT,PA,PT2,PA2,ET2,EA2,A,C,T: integer;

BEGIN
  // check for kill player mode
  if (UBufferGet(99) = 1) or (UBufferGet(98) > 0) then begin
    KillPlayer_Occupation(FromTerritory, ToTerritory, Armies);
    exit;
  end;


if (UBufferGet(39)=2) then begin //###Unsimple

  Armies:=0;
  IF TIsFront(FromTerritory) AND TIsFront(ToTerritory) THEN
  BEGIN
    IF TArmies(FromTerritory)>TArmies(ToTerritory) THEN
    BEGIN
      IF (TFrontsCount(FromTerritory)=1) AND (TFrontsCount(ToTerritory)=1) THEN
      BEGIN      // It makes a following attack easier if the troops stay together, therefore move all
        IF (TFront(FromTerritory,1)=TFront(ToTerritory,1)) AND ((double(TArmies(FromTerritory))+2)/(double(TArmies(TFront(ToTerritory,1))))>1.2) THEN Armies:=TArmies(FromTerritory)-1;
      END
      ELSE Armies:=(TArmies(FromTerritory)-TArmies(ToTerritory)) div 2;
    END;
  END
  ELSE IF TIsFront(ToTerritory) THEN
   Armies:=TArmies(FromTerritory)-1;
   
END;


//((UBufferGet(28)=-1) or ((UBufferGet(28)<>-1) and (trunc(UBufferGet(27))<>ToTerritory)))
If True then
Begin //Bypass PROCEDURE Occupation

if UBufferGet(39)>2 then  //###Wyrm
begin
  // very simple but effective routine
  // moves ARMIES from FROMTERRITORY to TOTERRITORY (which was just conquered)

  FromIsFront :=TIsFront(FromTerritory);
  ToIsFront :=TIsFront(ToTerritory);
  Armies:=0;

  if  FromIsFront and ToIsFront then  // if both territories are 'front'
      begin
        TStrongestFront(FromTerritory,ET,EA); // idea is to leave behind only what you need
	Buffer:=TArmies(FromTerritory) div 8;
        if (Buffer<3) then
          Buffer:=3;
        EA:=EA+Buffer; // leave some extra
        ET:=(1+TArmies(FromTerritory)-TArmies(ToTerritory)) div 2; // balancing move
        if (EA>TArmies(FromTerritory)-ET) then
          Armies:=ET // will always move at least armies to balance territories
        else Armies:=TArmies(FromTerritory)-EA; // but maybe more
      end 
    else if FromisFront then // only "From" territory is front
      begin 
        // all armies stay in From territory, so there's nothing to do
      end
    else
      begin
        // all armies in the conquered territory (except one which must stay)
        Armies:=TArmies(FromTerritory)-1;
      end;
   end;
   //###############################
  

//Reset Alaska attack if failed
if (UBufferGet(9)=32) and (Not TIsMine(32)) then UBufferSet(9, 0);



If (PArmiesCount(PMe)<200) or (COwner(6)=-(trunc(UBufferGet(10)))) then
Begin


If ((FromTerritory=39) and (ToTerritory=31)) then
 if (UBufferGet(39)>2) then
  if NOT ( (UBufferGet(39)=3) and (PTerritoriesCount(trunc(UBufferGet(36)))>30) ) then
 Begin
   If Armies>4 then Armies:=5;
   
If TArmies(39)-3*trunc(UBufferGet(39))>0 then
Begin
   A:=0;
   For C:=1 to 38 do
    If ((TArmies(C)>25) and (NOT TIsMine(C))) then A:=1;
   
   If ((A=0) or (UBufferGet(39)<4)) then 
   Begin
    If TArmies(39)>20 then 
     Begin
      Armies:=TArmies(39)-3*trunc(UBufferGet(39));
     end;
    If (UBufferGet(39)<4) and (A=0) then 
     If (TArmies(39)<16) and (TArmies(39)>5) then Armies:=TArmies(FromTerritory)-2;
   end;
end;

If (UBufferGet(10)<0) OR (UBufferGet(39)<4) then Armies:=TArmies(FromTerritory)-1;
 end;

If ((FromTerritory=9) and (ToTerritory=10)) then 
If UBufferGet(39)>2 then
Begin
CAnalysis(2,PT,PA,ET,EA);
If (COwner(6)=-(trunc(UBufferGet(10)))) and (TArmies(31)>40) then C:=round(double(TArmies(31))/4) else C:=0;  //#*# rounding makes it not exactly the same as before but close
If TIsMine(14) then A:=0 else A:=TArmies(14);

If (COwner(1)=PMe) and (EA+A+C>TArmies(9)) then
 If (TArmies(9)>2) then Armies:=1 else Armies:=0;
 //umessage('%%%%%%%%%%%%%%%%%%%%%%%%% ' , Armies);
end;
 

//Brazil to Venezuela
If ((FromTerritory=12) and (ToTerritory=10)) then 
Begin
CAnalysis(1,PT,PA,ET,EA);
Armies:=((TArmies(12)+TArmies(10)) div 2) - TArmies(10);
If TArmies(12)<=TArmies(14) then Armies:=0;
IF (COwner(1)<>0) and (EA>0) and (TArmies(12)>EA) then 
Begin
Armies:=TArmies(FromTerritory)-1;
If (TArmies(12)-EA>4) and (COwner(2)=PMe) and (TArmies(14)<8) then Armies:=TArmies(FromTerritory)-4;
If (TArmies(12)>EA+TArmies(14)+10) then Armies:=EA -10 + (TArmies(12)-EA) div 2;
end;
end;

//Venezuela to Peru 
If ((FromTerritory=10) and (ToTerritory=11)) then 
Begin
CAnalysis(2,PT,PA,ET,EA);
If ((EA<PA-4-3) and (ET=3)) then Armies:=ET-3-3;
If ((EA<PA-8-3) and (ET=3)) then Armies:=ET-5-3;
If ((EA<PA-14-3) and (ET=3)) then Armies:=ET-9-3;
If TIsFront(11) then
 If ((UBufferGet(39)=2) and TIsMine(9) and (PA>EA+3)) then Armies:=TArmies(FromTerritory)-1;
end;

//Venezuela to Mexico
If ((FromTerritory=10) and (ToTerritory=9)) then 
Begin
CLeader(1,LP,LT,LA);
CAnalysis(1,PT,PA,ET,EA);
If ((LT=8) and (LP<>PMe) and (TArmies(10)>2)) then Armies:=TArmies(FromTerritory)-2;
If ((EA<20) and (TArmies(10)>15)) then Armies:=TArmies(FromTerritory)-2;
If (LT=8) and (LP<>PMe) and (EA<TArmies(10)) then Armies:=TArmies(FromTerritory)-1;
end;
   

    //Armies when conquering Alaska from Koryak
If ( (FromTerritory=37) and (ToTerritory=1) and (UBufferGet(39)>2)) then 
 Begin
 CAnalysis(1,PT,PA,ET,EA);
 CAnalysis(5,PT2,PA2,ET2,EA2);
 CLeader(1,LP,LT,LA);
 
 If ((TArmies(FromTerritory)-Armies=1) and (Armies>0)) then Armies:=TArmies(FromTerritory)-2;
 If ((TArmies(FromTerritory)-Armies<4) and (TArmies(37)>8)) then Armies:=TArmies(FromTerritory)-4;
 If ((TArmies(FromTerritory)-Armies<8) and (TArmies(37)>16)) then Armies:=TArmies(FromTerritory)-8;
 If ((EA>60) and (COwner(1)=0)) then Armies:=0;
 If ((Armies>20) and (COwner(5)<>PMe)) then Armies:=20;
 If ((PT2>6) and (PT2<120)) then Armies:=1;
 
 If ((TArmies(2)+TArmies(4)<5) and (ET=8) and (PT2=12)) then
Begin
If (TArmies(37)>12) then Armies:=TArmies(FromTerritory)-2;
If (TArmies(37)>24) then Armies:=20; 
end;

//Lame fix
If (TArmies(37)>80) and 
   (TArmies(31)<20) and 
   (PArmiesCount(-(trunc(UBufferGet(10))))>100) then Armies:=TArmies(FromTerritory)-2;

If (PT=12) and (TArmies(37)=4) then Armies:=0;

If (Not TIsMine(27)) or ((TArmies(27)<TArmies(26)) and (TArmies(27)<TArmies(22))) then
If (LT=8) and (LP=COwner(3)) and (COwner(3)<>0) and (PT2<9) and 
(TArmies(2)+TArmies(3)+TArmies(20)<8) and (TArmies(37)>TArmies(2)+TArmies(3)+TArmies(20)) then
Armies:=TArmies(2)+TArmies(3)+TArmies(20);

If (COwner(6)=PMe) or (EA<14) then
If ((COwner(2)=LP) or (LP=trunc(UBufferGet(36)))) and (LP<>0) and (LP<>PMe) then
If (UBufferGet(9)=0) and ((UBufferGet(25)=0) or (UBufferGet(20)<>37)) then
Begin
If (LT=8) and (PT2<10) and (TArmies(37)>5) and ((UBufferGet(39)<5) or (LP=trunc(UBufferGet(36)))) then
 If (COwner(5)=PMe) then Armies:=TArmies(37)-4 else Armies:=TArmies(37)-2;
If (Armies>10) and (TArmies(37)<4) and (COwner(5)=PMe) then Armies:=TArmies(37)-4;
If (LT=8) and (Armies>1) and ((UBufferGet(39)<5) or (LP=trunc(UBufferGet(36)))) and 
((PT2<10) or (TArmies(37)-Armies>3)) then UBufferSet(6,1);
end;
 
 end;
  
 //Pass few armies when conquering Europa or Africa from Asia
 If ( (TContinent(FromTerritory)=5) and 
     ((TContinent(ToTerritory)=3) or (TContinent(ToTerritory)=4)) and (Armies>9)) then Armies:=9;
    
 //Leave 2 in Asia
 If ((TContinent(FromTerritory)=5) and 
     (TContinent(ToTerritory)<>5) and
     (TArmies(FromTerritory)-Armies=1) and
     (TArmies(FromTerritory)>=3)
    ) then Armies:=TArmies(FromTerritory)-2;
 
 //Pass few armies from Asia
 If ( (TContinent(FromTerritory)=5) and 
     ((TContinent(ToTerritory)=3) or (TContinent(ToTerritory)=4)) and (PArmiesCount(PMe)<150) and (Armies>1)) then 
     Begin
     Armies:=1;
     If (TArmies(FromTerritory)<5) then Armies:=0;
     end; 
 
 //Try a good defence in Ukrania
 If (COwner(5)=PMe) and (ToTerritory=22) then
 Begin
 If (FromTerritory=28) and (TArmies(28)>TArmies(29)) then Armies:=TArmies(28)-TArmies(29);
 If (FromTerritory=29) and (TArmies(29)>TArmies(28)+2) then Armies:=TArmies(29)-TArmies(28)-2;
 end;


//22 to C3
If ((FromTerritory=22) and (TContinent(ToTerritory)=3)) then 
Begin
If (ToTerritory<>26) then Armies:=1;
If (TArmies(22)-Armies=1) then Armies:=Armies-1;
end;


end;//end 200 armies


//Armies from Alaska to Koryak
If (FromTerritory=1) and (ToTerritory=37) then
If ( (UBufferGet(39)>2) and ((PArmiesCount(PMe)<200) or (COwner(1)<>PMe)) ) then 
 Begin
 If ( (TArmies(1)>8) or (2*((TArmies(1)+1) div 2)=(TArmies(1)+1)) ) then Armies:=1 else Armies:=0;
 If (COwner(1)<>PMe) then Armies:=0;
 end;
 

//Don't pass to 41 if C6 is mine
If ((ToTerritory=41) and (COwner(6)=PMe)) then Armies:=0;

//Don't pass armies from Greenland to Iceland
If (FromTerritory=3) and (ToTerritory=20) then
If ((PTerritoriesCount(PMe)<24) and (UBufferGet(39)>2)) then
Begin
CLeader(3,LP,LT,LA); 
If (TArmies(3)>8) and (LT=6) and (TArmies(21)<4) and (TArmies(24)<4) then Armies:=1 else Armies:=0;
CLeader(1,LP,LT,LA);
If (LP=PMe) and ((LT=8) or (LT=7)) then Armies:=0;
end;
     

//Armies in upper N. A.
If TContinent(FromTerritory)=1 then
If ((ToTerritory=1) or (ToTerritory=2) or (ToTerritory=4)) then
Begin
CLeader(1,LP,LT,LA);
If (LT=8) and ((NOT TIsMine(1)) or ((NOT TIsMine(4)) and (ToTerritory=1)) ) then Armies:=TArmies(FromTerritory)-1;
If ((ToTerritory=1) and (LT=9)) then Armies:=TArmies(FromTerritory)-1;
end;


//Don't pass armies from Koryak
If ((FromTerritory=37) and (TContinent(ToTerritory)=5) and (COwner(5)=PMe)) then Armies:=0;
If (FromTerritory=37) and (NOT TIsFront(ToTerritory)) then Armies:=0;
     
//Pass all armies to Middle East from India
If ((ToTerritory=27) and 
    (FromTerritory=30) ) then Armies:=TArmies(FromTerritory)-1;
    
//Pass all armies to Middle East from China to Mongolia if Someone holds N. A.
If (ToTerritory=33) then
 If ((FromTerritory=32) and (COwner(1)<>0) and (COwner(1)<>PMe)) then Armies:=TArmies(FromTerritory)-1;

//Armies from Siam 
If ( (FromTerritory=31) and ((ToTerritory=30) or (ToTerritory=32)) ) then 
Begin

    Armies:=0;
    CAnalysis(5,PT,PA,ET,EA);
    If ((ToTerritory=30) or (PT>8)) then C:=1 else C:=0;
    If (UBufferGet(39)=3) and (UBufferGet(10)=0) and (TArmies(31)>12) then C:=C+3;
    If (TArmies(31)>2) then Armies:=1;
    If (TArmies(31)>9) then Armies:=3+C;
    If (TArmies(31)>12) then Armies:=4+C;
    If (TArmies(31)>18) then Armies:=7 +2*C;
    If (TArmies(31)>24) then Armies:=9 +2*C;
    If UBufferGet(39)<4 then A:=2 else A:=3;
    If (TArmies(31)>100) then Armies:=TArmies(31) div A;
    For C:=27 to 38 do 
     If ((TArmies(C)>TArmies(31)+6) and (NOT TIsMine(C))) then If Armies>1 then Armies:=1;
    If PT=2 then 
    Begin
     If (ToTerritory=32) then
      Begin
      If TArmies(33)>TArmies(30) then Armies:=TArmies(33) else Armies:=TArmies(30);
      If (Not TIsFront(32)) and (UBufferGet(39)>3) then Armies:=0;
      end;
     If (ToTerritory=30) then
      If TArmies(32)>TArmies(29) then Armies:=TArmies(32) else Armies:=TArmies(29);
     If (Armies>=TArmies(31)) and (TArmies(31)>1) then Armies:=1; 
     If (Armies>11) then Armies:=11;
    end;
     
//end; // @@@ (page down)


//Pass more armies from Siam to India if someone strong in Africa or Europe
If ( (FromTerritory=31) and (ToTerritory=30) ) then
 If UBufferGet(10)>=0 then
 If ( ((COwner(3)=trunc(UBufferGet(36))) or (COwner(4)=trunc(UBufferGet(36)))) and (NOT TIsMine(27)) and (UBufferGet(36)<>0)) then
  Begin
  If TArmies(31)>6 then Armies:=2;
  If TArmies(31)>10 then Armies:=6;
  If TArmies(31)>15 then Armies:=10;
  If TArmies(31)>25 then Armies:=14;
  If TArmies(31)>35 then Armies:=20;
  end;
  

  
//Lame fix
If UBufferGet(10)<>0 then 
  Begin

A:=PArmiesCount(-(trunc(UBufferGet(10))));
For C:=38 DOWNTO 1 do
 If (TArmies(C)>(TArmies(31) div 2)) then
  If (TOwner(C)=-(trunc(UBufferGet(10)))) or (TOwner(C)=trunc(UBufferGet(10))) then 
  Begin A:=TArmies(C); C:=1; end;
  
  If (PT=2) and (A>TArmies(31)-Armies) then Armies:=Armies div 2;
  if (A>TArmies(31)-Armies) then Armies:=1;
  if (A>TArmies(31)+5-Armies) then Armies:=0;
  If (PT=2) and (Armies=0) then Armies:=1;
  If (Armies>3) and (trunc(UBufferGet(36))=COwner(1)) and (UBufferGet(10)<0) then Armies:=1;

  end;


If (UBufferGet(39)=2) and (TArmies(31)>4) then Armies:=TArmies(31)-4;
 
   
end; // @@@



If ( (FromTerritory=16) and (ToTerritory=27) ) then 
 If UBufferGet(39)>2 then Armies:=TArmies(FromTerritory)-1;

//Prepare to attack a Strong Player in Europe
If ((ToTerritory=2) or (ToTerritory=5) or (ToTerritory=6)) then 
If NOT TIsMine(3) then 
If (COwner(3)=trunc(UBufferGet(36))) and (UBufferGet(36)<>0) then
If TArmies(FromTerritory)>TArmies(3)+TArmies(20) then
If (COwner(5)<>PMe) or (FromTerritory<>1) then
if TArmies(3)+TArmies(20)<9 then
Begin
If TArmies(FromTerritory)>TArmies(3)+TArmies(20)+1 then C:=1 else C:=0;
If Armies<TArmies(3)+TArmies(20)+C then Armies:=TArmies(3)+TArmies(20)+C;
end;
    
    
    //Pass all but one armie when conquering Siam from India or China
If ( ((FromTerritory=30) or (FromTerritory=32)) and (ToTerritory=31) ) then 
 Armies:=TArmies(FromTerritory)-1;

//Armies from North Africa to Congo
If ( (FromTerritory=14) and (ToTerritory=17) ) then
 Begin
 A:=(TArmies(18)+TArmies(19))+3;
 If ((NOT TIsMine(18)) and (NOT TIsMine(19)) and (TArmies(14)>A)) then Armies:=A;
 end;

//Armies from North Africa to Brazil
If ( (FromTerritory=14) and (ToTerritory=12) ) then
Begin
 If ((COwner(1)<>0) and 
     (COwner(1)<>PMe) and 
     (TArmies(10)+TArmies(9)<TArmies(14)-1+3)) then Armies:=TArmies(FromTerritory)-1;
 
 If (COwner(4)<>PMe) then Armies:=TArmies(FromTerritory)-1;
end;
 
 
     //Pass all armies when conquering India from Middle East
If ((TIsMine(32)=False) and TIsMine(31) and (UBufferGet(39)>2)) then
If (FromTerritory=27) and (ToTerritory=30) and (TArmies(27)>4) then 
 Armies:=TArmies(FromTerritory)-4;
 
//29 to 27
If ToTerritory=27 then
Begin
 If ( ((FromTerritory=29) or (FromTerritory=22)) ) then
  If ( ((NOT (Cowner(5)=PMe)) or TIsMine(22)) and (COwner(4)=trunc(UBufferGet(36))) and (COwner(4)<>0) ) then If TArmies(FromTerritory)>1 then Armies:=TArmies(FromTerritory)-2 else Armies:=TArmies(FromTerritory)-1;

If (Cowner(5)=PMe) and (FromTerritory=29) and (TArmies(29)-Armies>TArmies(28)) then Armies:=TArmies(29)-TArmies(28);
end;
   
//26 to 14
If FromTerritory=26 then
If ( (ToTerritory=14) and (COwner(2)<>0) and (COwner(3)<>PMe) ) then Armies:=TArmies(FromTerritory)-1;


      //Pass armies when conquering Indonesia from Siam
If (FromTerritory=31) and (ToTerritory=39) then 
Begin
Armies:=TArmies(FromTerritory)-1;
C:=10; If (TArmies(40)+TArmies(41)+TArmies(42)<4) or (UBufferGet(39)=2) then C:=5;
 If (COwner(6)=PMe) then Armies:=0 else 
    If TArmies(31)>(TArmies(40)+TArmies(41)+TArmies(42)+C) then
     Armies:=(TArmies(40)+TArmies(41)+TArmies(42)+C);
end;
 
      //Pass all armies when conquering Koryak if North America occupied
If ToTerritory=37 then
If (  (COwner(1)<>PMe) and (COwner(1)<>0) ) then
 If (FromTerritory=35) or (FromTerritory=36) or (FromTerritory=33) or (FromTerritory=38) then 
  Armies:=TArmies(FromTerritory)-1;
 

 
     //Pass all armies when conquering Venezuela from Peru
If FromTerritory=11 then
Begin
If ToTerritory=10 then 
 Armies:=TArmies(FromTerritory)-1;
 
If ToTerritory=13 then 
 If TIsMine(10) and (NOT TIsMine(12)) then 
 Armies:=TArmies(FromTerritory)-1;
end;

//Pass all armies when conquering Koryak from Mongolia
If ToTerritory=37 then
 If ( (FromTerritory>32) and (COwner(5)=PMe) ) then 
 Armies:=TArmies(FromTerritory)-1;
 
//Pass few armies when conquering Africa from Middle East
If FromTerritory=27 then
Begin //from=27


CLeader(4,LP,LT,LA);
//Don't pass armies from 27 if PlayerStrong in c4
 If (LT>=5) and ((TContinent(ToTerritory)=5) or (ToTerritory=22)) and (LP<>PMe) and
 ((LP=trunc(UBufferGet(36))) or (COwner(2)=LP) or 
  ((TOwner(15)=PMe) and (TArmies(15)=3)) or ((TOwner(16)=PMe) and (TArmies(16)=3))
  ) then Armies:=0;
 
 
//Pass all armies from Middle East if can get in Australia
If ( (ToTerritory=30) and 
     (TArmies(31)+TArmies(39)+TArmies(40)<TArmies(27)) and 
     (TIsMine(31)=False) and
     (COwner(6)<>PMe) and (COwner(6)<>0) ) then Armies:=TArmies(FromTerritory)-1;

If ((ToTerritory=15) or (ToTerritory=16)) and (UBufferGet(39)>2) then 
Begin
 Begin
  Armies:=0;
  If (TArmies(27)>22) then Armies:=3;
  If (TArmies(27)>34) then Armies:=9;
  //If UBufferGet(15) then //umessage('Pass few armies when conquering Africa from Middle East ', Armies);
 end;
 If (PTerritoriesCount(PMe)<10) or (COwner(6)<>PMe) then Armies:=0;
end;


//Armies to South Europe
If (FromTerritory=27) and (ToTerritory=26) then
Begin

If COwner(4)<>0 then
Begin
If TArmies(27)>7 then C:=1 else C:=0;
If COwner(4)<>PMe then A:=TArmies(14) else A:=0;
If (COwner(4)<>PMe) and (TArmies(15)<TArmies(14)) and ((COwner(2)<>COwner(4)) or (TArmies(14)+TArmies(12)<5+C)) then A:=TArmies(15);

If ((COwner(2)=COwner(4)) and 
    (COwner(2)<>PMe) and 
    (TArmies(12)<3+C)) then 
    Begin 
    A:=TArmies(12)+TArmies(14);
    If (COwner(2)=COwner(1)) and (TArmies(10)+TArmies(9)=2) then Begin A:=A+2; C:=C+2; end;
    end;
    
If A>5+C then Armies:=0 else Armies:=A;
If TArmies(27)>1 then
 If ( ((TArmies(27)-Armies<6) and (COwner(5)=PMe)) or (TArmies(27)-Armies<2) ) then Armies:=Armies-2;

If Armies>=TArmies(27) then Armies:=0;
  
If COwner(4)<>PMe then
 If (TArmies(15)=1) and 
 ((COwner(2)=0) or ((Armies=4) and ((TArmies(12)>1) or (TArmies(14)>1))) ) then Armies:=0;
 
end;

If COwner(4)=0 then
 If ((COwner(2)=0) or (TArmies(12)+TArmies(14)>6)) and 
    (UBufferGet(39)>2) and (PTerritoriesCount(PMe)<20) and 
    (TArmies(27)<30) then Armies:=0;
 
   
end;



//If Europe or S.A. occupied by someone else try get it by Africa
If ( (FromTerritory=27) and ((ToTerritory=15) or (ToTerritory=16)) ) then
Begin
If TArmies(27)>7 then C:=1 else C:=0;
A:=0;
If ((COwner(2)=LP) and 
    (COwner(2)<>PMe) and 
    (COwner(2)<>0) and 
    (TArmies(12)<3+C)) then A:=TArmies(12);
    
If ((COwner(3)=LP) and 
    (COwner(3)<>PMe) and 
    (COwner(3)<>0) and 
    (TArmies(25)<TArmies(26)) and 
    (TArmies(25)<3+C)) then A:=TArmies(25);
    
If ((TArmies(27)-A<6) and (COwner(5)=PMe)) then A:=0;
    
If A<>0 then
 If ( (TIsMine(14)=False) and (TArmies(14)+A<=5) and (TArmies(27)>TArmies(14)+A) ) then Armies:=TArmies(14)+A;

If (COwner(2)=LP) and (COwner(2)<>0) and (COwner(2)<>PMe) and (COwner(1)=COwner(2)) and 
(TArmies(14)+TArmies(12)+TArmies(10)+TArmies(9)<=5) and (TArmies(27)>Armies+2) then Armies:=Armies+A;
end;

//Try a better proportion when conquering Kazakhstan from Middle East
If ((FromTerritory=27) and (ToTerritory=29) and (COwner(5)=PMe)) then 
 If (Armies>(TArmies(27) div 2)) then Armies:=TArmies(27) div 3;
 
 If (COwner(6)<>PMe) then
  If (ToTerritory=26) or (ToTerritory=15) or (ToTerritory=16) then Armies:=0;

end;//end from=27



//Pass all from 16 or 15 to 14 if COwner c3 or c2<>0
If ( (ToTerritory=14) and ((FromTerritory=15) or (FromTerritory=16)) ) then 
 If UBufferGet(39)>2 then 
  If ( ((COwner(2)<>0) and (COwner(2)<>PMe)) OR ((COwner(3)<>0) and (COwner(3)<>PMe)) ) 
   then Armies:=TArmies(FromTerritory)-1;
 
 
//Try a better proportion when conquering 28 from 29
If ((FromTerritory=29) and (ToTerritory=28) and (COwner(5)=PMe)) then Armies:=TArmies(29) div 2 - 1;
 
 
//Pass all armies from 29 if someone strong in c4 
If ( (FromTerritory=29) and (ToTerritory=27) ) then 
Begin
 CAnalysis(5,PT,PA,ET,EA);
 If ((COwner(4)=trunc(UBufferGet(36))) and (UBufferGet(36)<>0) and (PT<11)) then Armies:=TArmies(FromTerritory)-1;
end;

//Pass all to Koryak if c5 mine 
If ((COwner(5)=PMe) and (ToTerritory=37)) then UBufferSet(13,37);

//Pass all if can get c6
If TContinent(ToTerritory)=6 then
Begin
CAnalysis(6,PT,PA,ET,EA);

If (PT=3) then
If NOT ((NOT TIsMine(41)) and (ToTerritory=39)) then
If TIsFront(ToTerritory) and (TArmies(ToTerritory)+TArmies(FromTerritory)-1>EA) then Armies:=TArmies(FromTerritory)-1;

If (PT=2) then
If (TArmies(FromTerritory)+1>EA) then Armies:=TArmies(FromTerritory)-1;

If (PT=4) and (FromTerritory=39) then Armies:=0;

end;

If ((FromTerritory=12) and (ToTerritory=14)) then
  If UBufferGet(13)<>0 then UBufferSet(13,0);
  
  
  If (COwner(1)=PMe) then
   If (PArmiesCount(PMe)>=200) then
    If ((ToTerritory=14) and (FromTerritory=12) and (COwner(2)=PMe)) or 
       ((ToTerritory=37) and (FromTerritory=1)) or 
       ((ToTerritory=20) and (FromTerritory=3)) then
       Begin
       C:=0;
       A:=Armies;
       For T:=1 to 39 do
        If (Not TIsMine(T)) and (TArmies(T)>C) then C:=TArmies(T);
        
       If (TArmies(FromTerritory) - C - 10 < 0) then Armies:=0 else Armies:=TArmies(FromTerritory) - C - 10;
       If TArmies(FromTerritory) - Armies < 0 then Armies:=0;
       If (C>TArmies(1)) or (C>TArmies(3)) or (C>(TArmies(12)+(TArmies(10) div 2))) then Armies:=Armies div 2;
       UBufferSet(13,0);
       If (Armies=0) and (A>0) then Armies:=1;
       end;


//Don't pass armies from Brazil to North Africa if none holds Europe
If ((FromTerritory=12) and (ToTerritory=14)) then
 If (UBufferGet(39)>2) and 
((PArmiesCount(PMe)<201) or ( (COwner(3)>0) and (COwner(3)<>PMe) and ((TArmies(25)<8) or (TArmies(26)<8)) )) then
Begin
Armies:=0;
If ((COwner(3)<>0) and (COwner(3)<>PMe) and (UBufferGet(39)>2)) then 
Begin
CLeader(4,LP,LT,LA);
If (COwner(3)=LP) or (COwner(1)=PMe) then
Begin
If (TArmies(12)>25) or (COwner(1)=PMe) then C:=1 else C:=0;
If ((TArmies(25)<=TArmies(26)) and (TArmies(12)>TArmies(25)+1+4)) then Armies:=TArmies(25)+C;
If ((TArmies(26)<TArmies(25)) and (TArmies(12)>TArmies(26)+1+4)) then Armies:=TArmies(26)+C;
end;
end;
If Armies>6+C then Armies:=6+C;
end;


       
       
//2-3 players strategy
//if UBufferGet(11)<>0 then 
 If trunc(UBufferGet(11))=ToTerritory then
  if TIsFront(FromTerritory) then 
    Begin
//If ((UBufferGet(39)=2) and TIsFront(FromTerritory)) then Armies:=TArmies(FromTerritory)-2 else 

If  (FromTerritory<>1) or (COwner(5)<>0) then
 If ((TContinent(FromTerritory)=TContinent(ToTerritory)) and (FromTerritory<>31)) then Armies:=TArmies(FromTerritory)-1;
     ////umessage('passed all-11');
     end;
UBufferSet(11,0);



//CrazyBubpass
If (FromTerritory=trunc(UBufferGet(6))) and (UBufferGet(6)<>0) then 
Begin
Armies:=TArmies(FromTerritory)-1;
UBufferSet(6,ToTerritory);
end;


A:=1;
If UBufferGet(25)=1 then
If COwner(2)=PMe then
Begin
For T:=1 to 9 do
 If Not TIsMine(T) then Begin C:=T; T:=9; end;
For T:=C+1 to 9 do
 If (Not TIsMine(T)) and (TOwner(C)<>TOwner(T)) then Begin A:=2; T:=9; end;
end;



//##################Bubble mode
//If UBufferGet(9)=0 then // continue passing all
If UBufferGet(25)=1 then
 If (((ToTerritory=15) or (ToTerritory=16) or (ToTerritory=22) or (ToTerritory=1) or (ToTerritory=26)) and (UBufferGet(24)=0)) then
  Begin
  Armies:=0;
  //UBufferSet(17,-ToTerritory);
  end
 else
  begin
  trail:=1; If (TContinent(trunc(UBufferGet(20)))=1) and (COwner(2)=PMe) and (TArmies(12)>TArmies(14)+4) and 
               (A=1) and (FromTerritory=trunc(UBufferGet(20))) and TIsFront(FromTerritory) then trail:=2;
  
  If FromTerritory=31 then
  Begin
  If TArmies(40)+TArmies(41)+TArmies(42)<6 then C:=4 else C:=10;
  If (ToTerritory=39) and (NOT TIsMine(40)) then
   If TArmies(31)>(TArmies(40)+TArmies(41)+TArmies(42)+10) then
    Trail:=TArmies(31)-(TArmies(40)+TArmies(41)+TArmies(42)+C);
  end;
  
   UBufferSet(17, 0); 
   
   
  TWeakestFront(FromTerritory, ET,EA);
  TWeakestFront(ToTerritory, ET2,EA2);
  
  If ((EA2>EA) and (EA>0)) or (ET2=0) then
  If trunc(UBufferGet(13))<>ToTerritory then
  If (FromTerritory=trunc(UBufferGet(20))) then
  Begin
  Armies:=0;
  UBufferSet(17,-ToTerritory);
  end;


//  //umessage(UBufferGet(13), ToTerritory);
CAnalysis(1,PT2,PA2,T,C);

  If UBufferGet(20)=33 then
  If (Not ((TArmies(31)>62) and TIsMine(31) and (C<TArmies(31)-10)) ) or (Not TIsMine(31)) then
   If trunc(UBufferGet(13))<>ToTerritory then
   // If Not ((ToTerritory=37) and (COwner(1)<>0) and (TArmies(33)>TArmies(1))) then
     If TArmies(33)>TArmies(32) then
      If FromTerritory=33 then
  Begin
   If (EA=1) or (ToTerritory=38) then
  Begin
  Armies:=0;
  UBufferSet(17,-33);
  end;
  end;

UBufferSet(21,0); //Reset Bubble attack method
  
CLeader(2,LP,LT,LA);

If (FromTerritory=trunc(UBufferGet(20))) 
or ((TContinent(FromTerritory)>2) and (TContinent(ToTerritory)>2))
or (LP<>PMe) then
   If (UBufferGet(17)=0) then Armies:=TArmies(FromTerritory)-trail;
   
   If (UBufferGet(17)=0) and 
      (FromTerritory=trunc(UBufferGet(20)))
      then UBufferSet(20,ToTerritory);
      
   If FromTerritory=31 then
   If (ToTerritory<>39) and (COwner(6)=PMe) and (UBufferGet(20)<>31) then 
    If (trunc(UBufferGet(8))<>ToTerritory) and (UBufferGet(9)=0) then
   Begin
   Armies:=0;
   UBufferSet(13,0);
   end;

  end;

UBufferSet(28,-1);
UBufferSet(27,0);
end; //Bypass Occupation

//((UBufferGet(28)=-1) or ((UBufferGet(28)<>-1) and (trunc(UBufferGet(27))<>ToTerritory)))
//If ((UBufferGet(28)<>-1) and (trunc(UBufferGet(27))=ToTerritory)) then
//Begin
//If (Armies=9999) then Armies:=TArmies(FromTerritory)-1 else Armies:=trunc(UBufferGet(28));
UBufferSet(28,-1);
UBufferSet(27,0);
//end;

//conquest mode
If UBufferGet(7)<>0 then
Begin
CAnalysis(1,PT,PA,ET,EA);
CAnalysis(2,PT2,PA2,ET2,EA2);
C:=PA+PA2-EA-EA2-15-TArmies(14) div 2; 
If C<0 then C:=0;

If (FromTerritory>3) and (ToTerritory<10) then Armies:=TArmies(FromTerritory)-1;
If (FromTerritory=1) and (ToTerritory=2) then Armies:=TArmies(FromTerritory)-6-TArmies(37)-(c div 4);
If (FromTerritory=2) and (ToTerritory=3) then Armies:=TArmies(FromTerritory)-1;
If (FromTerritory=3) and (ToTerritory=6) then Armies:=TArmies(FromTerritory)-8-TArmies(20)-(c div 4);
If (FromTerritory=3) and (ToTerritory=6) and TIsMine(20) and (TArmies(3)<30) and (TArmies(3)>4) 
  then Armies:=TArmies(FromTerritory)-4;

end;

If (FromTerritory=trunc(UBufferGet(8))) and (ToTerritory<>31) and (-1<>UBufferGet(8)) then Armies:=0;

 //Pass nothing
 If (trunc(UBufferGet(16))=ToTerritory) or (trunc(UBufferGet(16))=FromTerritory) then Armies:=0;
 UBufferSet(16,0);

 //Pass All
 If trunc(UBufferGet(13))=ToTerritory then
  If ToTerritory<>0 then 
 Begin
 If (FromTerritory<>27) or (UBufferGet(9)=26) or (UBufferGet(9)=15) or (COwner(6)<>PMe) then Armies:=TArmies(FromTerritory)-1;
 end;
 UBufferSet(13,0);

 If FromTerritory=12 then
  If (ToTerritory=14) and (Armies=TArmies(12)-1) and (UBufferGet(39)>3) then Armies:=0;
  
If Armies<0 then Armies:=0;

end;

// procF
procedure Fortification(var FromTerritory, ToTerritory, Armies: integer);
var
  BestFrom,BestArmies,F,T,Arm,B,MaxArmy,Diff,BestDiff,EA,ET: integer;
  SMALL, ALLFRONTS, ONEFRONTS, MinArmy, BiggestArmy, FromT, counter,   PT,PA,W, LP,LT,LA: integer;

  // Kill Player variables
  extra, X, C, C1, TotalEnemyArmies, P, MaxPArmiesCount: integer;
  Human, Abort: boolean;
  TM: double;
begin
  if not SConquest then bs(61, bg(61)+1) else bs(61,0);   //  61 - successive turns without conquest counter

  if GameHasOneHuman(P) then begin
    C:= 0;
    C1:= 0;
    For X:= 1 to 10 do begin
      if PActive(X) and (PProgram(X) = 'vexer.trp') then C:= C + 1;   // check to see if Vexer is dead
      if PAlive(X) and (PProgram(X) = 'vexer.trp') then C1:= C1 + 1;
    end;
    extra:= 0;
    if (PCardTurnInValue(P) > PCardTurnInValue(PMe)) and (PCardCount(P) > 1) then Extra:= PCardTurnInValue(P) - PCardTurnInValue(PMe);
    If (C = 1) and (C1 = 0) and ( PArmiesCount(PMe) > (2 * PArmiesCount(P) + 3) + Extra ) then begin
      UBufferSet(98, 1);
    end;
    if PArmiesCount(PMe) > (3 * PArmiesCount(P)) then begin
      UBufferSet(98, 1);
    end;
  end;


  {----------------------------------finisher----------------------------------}
  // improved finisher.trp code
  if (UBufferGet(99) = 0) and (PCardCount(PMe) > 2) then begin
    if SCardsBasedOnCombo then TM:= 1.0 else TM:=0.8;
    Abort:=False;
    Human:=False;
    TotalEnemyArmies:=0;
    MaxPArmiesCount:=0;	// The number of armies that my strongest enemy has
    for P:= 1 to 10 do begin
      if (PAlive(P)) and (P<>PMe) then begin
        if PArmiesCount(P) >= MaxPArmiesCount then begin
          MaxPArmiesCount:= PArmiesCount(P);
          if (NOT (PArmiesCount(P) = MaxPArmiesCount)) then Abort:=False;	// 1st and 2nd strongest armies are the same, don't reset abort to false
          if (PCardCount(P) > 2) and (PCardTurnInValue(P) > 25) then Abort:= True;
        end;
        if PHuman(P) and (PCardCount(P) > 3) and (PCardTurnInValue(P) > 20) then Abort:= True;
        if PHuman(P) then begin
          if (not (PArmiesCount(P) < trunc(double(PArmiesCount(PMe)) * 0.25))) then TM:= TM + 0.2;
          If PCardTurnInValue(P) > PCardTurnInValue(PMe) then TotalEnemyArmies:= TotalEnemyArmies + PCardTurnInValue(P) - PCardTurnInValue(PMe);
        end;
        If (pos('vexer', lowercase(PProgram(P))) > 0) then begin
          if (not (PArmiesCount(P) < trunc(double(PArmiesCount(PMe)) * 0.25))) then TM:= TM + 0.2;
          if (PCardCount(P) > 3) and (PCardTurnInValue(P) > 25) then Abort:= True;
          If PCardTurnInValue(P) > PCardTurnInValue(PMe) then TotalEnemyArmies:= TotalEnemyArmies + PCardTurnInValue(P) - PCardTurnInValue(PMe);
        end;                                                    // pretend there are more enemy armies if his CTIV is greater then mine
        TotalEnemyArmies:= TotalEnemyArmies + PArmiesCount(p);
      end;
    end;

    // if there's more than 4 players, I'll get a lot of cards by killing them so then lower the threshold multiplier
    if (SAlivePlayersCount > 4) then TM:= TM - 0.1;

    // if I have a lot of armies then lower TM because on average when attacking 3 dice against 2
    // I'll take out 7 enemy armies for every 6 I lose, so I need less armies to win
    if (PArmiesCount(PMe) > 200) then begin
      TM:= TM * 0.9;
      abort:= false;
    end;
    if (PArmiesCount(PMe) > 400) then TM:= TM * 0.95;

    if (PArmiesCount(PMe) > trunc(TotalEnemyArmies * TM)) and (NOT Abort) then UBufferSet(99, 1);
    if (PArmiesCount(PMe) > trunc(TotalEnemyArmies*1.4)) then UBufferSet(99, 1);		// If TM > 1.4 then switch to Kill Player even if Abort = true
  end;

  // check for kill player mode
  if (UBufferGet(99) = 1) or (UBufferGet(98) > 0) then begin
    KillPlayer_Fortification(FromTerritory, ToTerritory, Armies);
    exit;
  end;


if (UBufferGet(39)>2) then begin //###Wyrm

counter:=trunc(UBufferGet(40))+1;
UBufferSet(40, counter);
////If UBufferGet(15) then //umessage('Calling procedure Fortification UBufferSet(40, counter)', UBufferGet(40) );

  FromTerritory:=0;
  ToTerritory:=0;
  Armies:=0;
  ALLFRONTS:=10;
  ONEFRONTS:=1;
  SMALL:=-9999;

  // look for front country that needs the most help.  favor continents that you
  // already own, and countries that can be helped by 0-fronts
  // "most help" implies difference between MyArmies and the strongest front

  // for each of your fronts, determine the FromTerritory, the deficit, and the benefit able to be provided


  BestArmies:=0;
  BestDiff:=SMALL;
//  //If UBufferGet(15) then //umessage('Calling procedure Fortification');

  for T:=1 to 42 do
    if TIsFront(T) then
      begin
        TStrongestFront(T,ET,EA);
        Diff:=EA-TArmies(T); // your current deficit
        BestArmies:=0;
        for B:=1 to TBordersCount(T) do
          begin
            F:=TBorder(T,B);  // start looking for the best FromTerritory
            if TIsMine(F) and (TArmies(F)>1) then
              begin
                TStrongestFront(F,ET,EA);
                if (not TIsFront(F)) then
                  Arm:=TArmies(F)-1
                else
                  Arm:=TArmies(F)-EA; // the absolute most you can spare
//                  //If UBufferGet(15) then //umessage(TName(T),' has a deficit of ',Diff,' but can be helped by ',TName(F),' which can spare ',Arm,' armies');
                if (Arm>BestArmies) then
                  begin
                    BestArmies:=Arm;
                    BestFrom:=F;
                  end;
              end;
          end;
        // now you have found your best FromTerritory "BestFrom" for this ToTerritory T
        // it can spare "BestArmies" and you had desired "Diff"
        B:=Diff;
        if (B>BestArmies) then
          B:=BestArmies; // you needed more than you could can spare
        if (B>BestDiff) and ((B+BestArmies)>1) and (BestArmies>2) then
          begin
            Armies:=(B+BestArmies) div 2;
            if (not TIsFront(BestFrom)) then
              Armies:=BestArmies;
//            //If UBufferGet(15) then //umessage('Found a better fortification:  move ',Armies,' armies from ',TName(BestFrom),' to ',TName(T));
            BestDiff:=B;
            FromTerritory:=BestFrom;
            ToTerritory:=T;
          end;
      end;

  if (ToTerritory=0) then // use original fortification code -- find largest zero-front
begin
  MaxArmy :=1;
  for T:=1 to 42 do begin
    if TIsMine(T) and not TIsFront(T) then begin  // territory is mine and not "front"
      if TArmies(T)>MaxArmy then begin
        MaxArmy :=TArmies(T);
        FromTerritory :=T;
      end;
    end;
  end;
  // if there are armies to move...
  if FromTerritory>0 then begin
    // check if can move armies to front...
    for B:=1 to TBordersCount(FromTerritory) do begin
      if ToTerritory=0 then begin
        T:=TBorder(FromTerritory,B);
        if TIsMine(T) and TIsFront(T) then begin
          ToTerritory:=T;
        end;
      end;
    end;
    // otherwise move armies in the first bordering territory
    if ToTerritory=0 then begin
      for B:=1 to TBordersCount(FromTerritory) do begin
        if ToTerritory=0 then begin
          T:=TBorder(FromTerritory,B);
          if TIsMine(T) then begin
            ToTerritory:=T;
          end;
        end;
      end;
    end;
    // Move all armies to destination (except the one which must stay)
    if ToTerritory>0 then begin
      Armies:=TArmies(FromTerritory)-1;
    end;
  end;
end;

//################

//Armies Alaska> Koryak
If  FromTerritory=1 then
If ( (ToTerritory=37) and (UBufferGet(39)>2) and (PArmiesCount(PMe)<200) ) then 
 Begin
 If (Armies>1) then Armies:=1;
 If (TArmies(1)>16) then Armies:=3;
 If (TArmies(1)>26) then Armies:=5;
 
 If ((Armies=1) and (TArmies(37)=4)) or (UBufferGet(10)<0) then Armies:=0;
 If (((TArmies(37)=1) or (TArmies(37)=3)) and (TArmies(1)>6)) then Armies:=1;
 If (COwner(1)=PMe) and (TArmies(37)<4) and (TArmies(1)>20) and TIsFront(37) then Armies:=4-TArmies(37);
 end;

//Don't unprotect Alaska
If  ToTerritory=2 then
 If ((FromTerritory=1) or (FromTerritory=3)) then
Begin
If TArmies(FromTerritory)>20 then B:=3 else B:=1;
If TArmies(FromTerritory)>40 then B:=5;

If (FromTerritory=1) and ((Not TIsMine(37)) or (TArmies(37)<4)) then 
 If (Armies>TArmies(1)-TArmies(37)-B) then Armies:=TArmies(1)-TArmies(37)-B else Armies:=0;
If (FromTerritory=3) and ((Not TIsMine(20)) or (TArmies(20)<4)) then 
 If (Armies>TArmies(3)-TArmies(20)-B) then Armies:=TArmies(3)-TArmies(20)-B else Armies:=0;

CAnalysis(1,PT,PA,ET,EA);
If PT=8 then
Begin
 B:=TArmies(FromTerritory)+TArmies(2)-EA;
 If B>3 then Armies:=EA + B div 2;
 If (FromTerritory=1) and (ToTerritory=2) and (TArmies(2)>3) then 
  If TArmies(FromTerritory)-Armies<TArmies(37)+4 then
  Begin
  If (Not TIsMine(37)) then Armies:=TArmies(1)-TArmies(37)-4;
  If TIsMine(37) then Armies:=TArmies(1)-6;
  end;
 
 If (FromTerritory=3) and (ToTerritory=2) and (TArmies(2)>3) then 
  If TArmies(FromTerritory)-Armies<TArmies(20)+4 then 
  Begin
  If (Not TIsMine(20)) then Armies:=TArmies(3)-TArmies(20)-4;
  If TIsMine(20) then Armies:=TArmies(3)-6;
  end;
  
  If COwner(1)=PMe then FromTerritory:=0;
end;

If Armies<=0 then FromTerritory:=0;
end;

//Don't pass too much from Indonesia to Siam   
If ( (FromTerritory=39) and (ToTerritory=31) ) then 
   if TArmies(39)<5 then FromTerritory:=0 else Armies:=TArmies(39)-1;

If TArmies(39)>4 then
 //If (UBufferGet(10)<0) OR (UBufferGet(39)<5) then
  If TIsMine(31) and TIsMine(39) then
    Begin
     FromTerritory:=39;
     ToTerritory:=31;
     Armies:=TArmies(39)-1;
    end;

//Don't pass from Venezuela to Mexico
If ( (FromTerritory=10) and (ToTerritory=9) ) then  FromTerritory:=0;

//Don't pass from Venezuela to to Brazil if not needed
If ( (FromTerritory=10) and (ToTerritory=12) and (TArmies(12)>trunc(1.3*TArmies(14)+6)) ) then FromTerritory:=0;


//Don't pass from Brazil to North Africa   
If ( (FromTerritory=12) and (ToTerritory=14) ) then  FromTerritory:=0;


//Don't pass too much from Brazil to North Africa
If ((FromTerritory=12) and (ToTerritory=14)) then 
Begin
   If ((TArmies(12)-Armies<10) and (TArmies(12)-5>10)) then Armies:=5;
   If ((TArmies(12)-Armies<10) and (TArmies(12)-15>10)) then Armies:=15; 
   If ((Armies>4) and (COwner(3)=0)) then Armies:=5;
   If ((TArmies(12)<9) and (COwner(3)=0)) then FromTerritory:=0;
end;

//Don't pass too much from Brazil to Venezuela
If ((FromTerritory=12) and (ToTerritory=10)) then 
Begin
   If (TArmies(12)-Armies<TArmies(14)+2) then FromTerritory:=0;
   If (TArmies(12)-3>TArmies(14)+2) then Armies:=3;
   If (TArmies(12)-5>TArmies(14)+2) then Armies:=5;
   If (TArmies(12)-7>TArmies(14)+2) then Armies:=7;
   If (TArmies(12)-11>TArmies(14)+2) then Armies:=11;
   If (TArmies(12)-15>TArmies(14)+2) then Armies:=15;
   If (TArmies(12)-25>TArmies(14)+2) then Armies:=25;
end;


//Don't pass armies from Geenland to Iceland
If (FromTerritory=3) and (ToTerritory=20) then
If ((PArmiesCount(PMe)<200) or (COwner(6)=-(trunc(UBufferGet(10)))) and (UBufferGet(39)>2)) then
Begin
CLeader(3,LP,LT,LA); 
If (TArmies(3)>12) and (TArmies(20)<4) and (LT=6) then Armies:=4-TArmies(20) else FromTerritory:=0;
If COwner(1)<>PMe then FromTerritory:=0;
end;

//Armies from Middle East
If (FromTerritory=27) then
Begin
If (Toterritory=26) then
 If (PTerritoriesCount(PMe)<20) and ((TArmies(27)<25) and (COwner(5)=PMe)) then Armies:=0;

If (Toterritory=26) and (COwner(5)<>PMe) then Armies:=0;
 
If ((PArmiesCount(PMe)<200) or (COwner(6)=-(trunc(UBufferGet(10))))) and ((TContinent(ToTerritory)=4) OR (TContinent(ToTerritory)=3)) and (UBufferGet(39)>2) and (Armies>7) then Armies:=7;

If (COwner(5)=PMe) and (TArmies(29)=TArmies(28)) then Armies:=0;


If COwner(5)=PMe then B:=5 else B:=0;
If ((COwner(5)=PMe) and (TArmies(28)>=8) and (TArmies(29)>8)) then B:=16;
If (((PArmiesCount(PMe)<200) or (COwner(6)<>PMe)) and (TContinent(ToTerritory)=4) and (UBufferGet(39)>2) and (Armies>1) and (TArmies(27)-Armies<6+B)) then Armies:=1;
If (COwner(5)=PMe) and (Toterritory=22) then
 Begin
 If (TArmies(29)+TArmies(22)+Armies>=TArmies(27)-2) and 
    (TArmies(28)+TArmies(22)+Armies>=TArmies(27)-2) then Armies:=Armies div 2 - 1;
 end;
If (((TArmies(15)=3) and TIsMine(15)) or ((TArmies(16)=3) and TIsMine(16))) and (Toterritory=22) then Armies:=0;
end;

//22 to C3
If ((FromTerritory=22) and (TContinent(ToTerritory)=3)) then 
Begin
If (ToTerritory<>26) then Armies:=1;
If (TArmies(22)-Armies=1) then Armies:=Armies-1;
end;


//Armies from Siam
If ( (FromTerritory=31) and ((ToTerritory=30) or (ToTerritory=32)) ) then 
 Begin
 Armies:=TArmies(31) div 8+1;
 CAnalysis(5,PT,PA,ET,EA);
 If (PT>10) or (((trunc(UBufferGet(36))=COwner(3)) or (trunc(UBufferGet(36))=COwner(4))) and (UBufferGet(36)<>0)) then
 Begin
  If Armies>7 then Armies:=7;
  If TArmies(31)>50 then Armies:=TArmies(31) div 5;
  If TArmies(31)+TArmies(39)<15 then FromTerritory:=0;
  If (SConquest or (NOT TIsFront(ToTerritory))) then For T:=27 to 38 do If ( (TArmies(T)>TArmies(31)+TArmies(39)+8) and (NOT (TIsMine(T))) ) then FromTerritory:=0;
 end;
 If (UBufferGet(10)<0) and (((PArmiesCount(-(trunc(UBufferGet(10))))*1.4))>double(TArmies(31))) then Armies:=0;
 If COwner(6)<>PMe then Armies:=0;
 end;
 

 
If TIsMine(27) then
 If TIsMine(15) or TIsMine(16) then
  Begin
   CLeader(4,LP,LT,LA);
   If NOT (LP=PMe) then
    If UBufferGet(39)>2 then Begin
     If TIsMine(15) and (TArmies(15)>1) and (COwner(6)=PMe) then Begin
      FromTerritory:=15;
      ToTerritory:=27;
      Armies:=TArmies(15)-1;
     end;
    
     If TIsMine(16) and (TArmies(16)>1) and (COwner(6)=PMe) then Begin
      FromTerritory:=16;
      ToTerritory:=27;
      Armies:=TArmies(16)-1;
     end;
    end;
  end;

end;

     
If COwner(6)=PMe then
Begin
   //Pass all armies from Eastern Australia to New Guinea
   If ((TArmies(41)>2) and (TArmies(42)=1)) then
     Begin
     //If UBufferGet(15) then //umessage('All armies passed from Eastern Australia to New Guinea');
     FromTerritory:=41;
     ToTerritory:=42;
     Armies:=TArmies(41)-1;
     end;
     
    //Pass all armies from New Guinea to Indonesia
   If ((TArmies(42)>2)) then
     Begin
     //If UBufferGet(15) then //umessage('All armies passed from New Guinea to Indonesia');
     FromTerritory:=42;
     ToTerritory:=39;
     Armies:=TArmies(42)-1;
     end;
     
   //Pass all armies from western Australia to Indonesia
   If ((TArmies(40)>2)) then
     Begin
     //If UBufferGet(15) then //umessage('All armies passed from New Guinea to Indonesia');
     FromTerritory:=40;
     ToTerritory:=39;
     Armies:=TArmies(40)-1;
     end;
end;


//Pass armies to attack Mexico
If (TIsMine(9)=False) then
Begin
CAnalysis(1,PT,PA,ET,EA);
If (
    (PT=8) and 
    (TArmies(1)>28) and 
    (Cowner(2)=TOwner(9)) and 
    (Cowner(2)<>PMe) and
    (Cowner(5)=0)) then
     Begin
     //If UBufferGet(15) then //umessage('Pass armies to attack Mexico from Alaska');
     FromTerritory:=1;
     ToTerritory:=4;
     Armies:=TArmies(1)-8;
     end;
     
If ((PT=8) and 
    (TArmies(3)>28) and 
    (Cowner(2)=TOwner(9)) and 
    (Cowner(2)<>PMe) and
    (Cowner(3)=0)) then
     Begin
     //If UBufferGet(15) then //umessage('Pass armies to attack Mexico from Greenland');
     FromTerritory:=3;
     ToTerritory:=5;
     Armies:=TArmies(3)-8;
     end;
   
If ((PT=8) and (TArmies(5)>19) ) then
     Begin
     //If UBufferGet(15) then //umessage('Pass armies to attack Mexico from Ontario');
     FromTerritory:=5;
     ToTerritory:=7;
     Armies:=TArmies(FromTerritory)-1;
     end;
     

If ((PT=8) and
    (TArmies(4)>19) ) then
     Begin
     //If UBufferGet(15) then //umessage('Pass armies to attack Mexico from Alberta');
     FromTerritory:=4;
     ToTerritory:=7;
     Armies:=TArmies(FromTerritory)-1;
     end;

end;

If TIsMine(1) then
  If (PArmiesCount(PMe)>=200) then
   If (COwner(1)=PMe) then
    If ((ToTerritory=14) and (FromTerritory=12)) or 
       ((ToTerritory=37) and (FromTerritory=1)) or 
       ((ToTerritory=20) and (FromTerritory=3)) then
       Begin
       B:=0;
       For T:=1 to 39 do
        If (Not TIsMine(T)) and (TArmies(T)>B) then B:=TArmies(T);
        
       If (TArmies(FromTerritory) - B + 10 < 0) then Armies:=0 else Armies:=TArmies(FromTerritory) - B + 10;
       If TArmies(FromTerritory) - Armies < 0 then Armies:=0;
       If (B>TArmies(1)) or (B>TArmies(3)) or (B>TArmies(12)) then Armies:=0;
       end;
       

 
// pass to 27 from 26
If (FromTerritory=0) or (Armies=0) then
Begin
If TIsMine(26) then
 If TIsMine(27) and (TArmies(26)=3)  then
  Begin
 FromTerritory:=26;
 ToTerritory:=27;
 Armies:=2;
 end;
 
// pass to 3 from 20
If TIsMine(20) then
If (FromTerritory=0) or (Armies=0) then
if (PTerritoriesCount(PMe)<15) or (TArmies(3)<5) then
 If (COwner(1)=PMe) and (TArmies(20)=3)  then
  Begin
 FromTerritory:=20;
 ToTerritory:=3;
 Armies:=2;
 end;


If TIsMine(22) then
 If NOT TIsMine(28) then
  If TIsMine(27) and (TArmies(22)>=3) then
   If (COwner(4)=
(UBufferGet(36))) and (COwner(4)<>0) then
    If ToTerritory<>27 then
 Begin
 FromTerritory:=22;
 ToTerritory:=27;
 Armies:=TArmies(22)-1;
 end;
end;

//Bug Control
If TArmies(FromTerritory)<=Armies then Armies:=TArmies(FromTerritory)-1;
If Armies<=0 then FromTerritory:=0;




//end; 

//##################

if Not (UBufferGet(39)>2) then begin //###Unsimple
BEGIN
  MinArmy:=1500;    //smallest frontarmy must be smaller than this one (should be no problem...)
  Armies:=0;        //Do not move armies until moveable army found
  BiggestArmy:=1;   //Need at least 2 Armies to have one to move [TArmies(FromT) > BiggestArmy]
  ToTerritory:=0;
  FromTerritory:=0;
  FromT:=0; //From Territory
  T:=42;
  REPEAT
    IF TIsFront(T) AND (TArmies(T)<=MinArmy) THEN  //TIsFront(T) can only be true if TIsMine(T) is True
    BEGIN

      FOR B:=1 TO TBordersCount(T) DO
      BEGIN
        FromT:=TBorder(T,B);

        IF (TIsMine(FromT) AND (NOT TIsFront(FromT))) AND (TArmies(FromT)>BiggestArmy) THEN
        BEGIN
          MinArmy:=TArmies(T);
          FromTerritory:=FromT;
          ToTerritory:=T;
          Armies:=TArmies(FromTerritory)-1;
          BiggestArmy:=Armies;
        END;
      END;
    END;
    T:=T-1;
  UNTIL T<1;

  IF Armies=0 THEN   //no fortification of a front possible, move the biggest other army anywhere
  BEGIN
    MaxArmy :=1;
    T:=42;
    REPEAT
      IF TIsMine(T) AND NOT TIsFront(T) THEN    // territory is mine and not "front"
      BEGIN
        IF TArmies(T)>MaxArmy THEN
        BEGIN
          MaxArmy :=TArmies(T);
          FromTerritory :=T;
        END;
      END;
      T:=T-1;
    UNTIL T<1;
    // if there are armies to move...
    // move armies to a random bordering territory
    IF FromTerritory>0 THEN
    BEGIN
    //Umessage('The biggest army is in: ' + TName(FromTerritory) + ' and has ' + inttostr(TArmies(FromTerritory)) + ' armies');
      B:=trunc(URandom(TBordersCount(FromTerritory)))+1; 
      ToTerritory:=TBorder(FromTerritory,B+1); 
      If NOT TIsFront(ToTerritory) then ToTerritory:=TBorder(FromTerritory,B-1);
      If NOT TIsFront(ToTerritory) then ToTerritory:=TBorder(FromTerritory,B+2);
      If NOT TIsFront(ToTerritory) then ToTerritory:=TBorder(FromTerritory,B-2);
      If NOT TIsFront(ToTerritory) then ToTerritory:=TBorder(FromTerritory,B);    
      // Move all armies
      Armies:=TArmies(FromTerritory)-1;
      
    END;
  END;  //IF Armies=0

END;  //PROCEDURE Fortification

end; //###Unsimple

//ALL PLAYERS FORTIFY
    If ( (FromTerritory=33) and (TArmies(33)<8) ) then FromTerritory:=0; //and ((ToTerritory=32) or (ToTerritory=30)))
    
    If TIsMine(32) then B:=TArmies(32) else B:=0; 
    If ( ((TArmies(27)+TArmies(30)+B-2)> TArmies(31)) and
     (TArmies(27)>5) and
     (COwner(6)<>PMe) and
      TIsMine(27) and
      TIsMine(30) and
     (Not TIsMine(31))
    ) then
     Begin
     //If UBufferGet(15) then //umessage('Middle East armies passed2  ');
     FromTerritory:=27;
     ToTerritory:=30;
     Armies:=TArmies(27)-1;
     end;
 
   //If India is heavy on Siam try pass all China armies
   If ( TIsMine(31) and 
       (TIsMine(30)=False) and 
       (TArmies(30)>TArmies(31)) and 
        TIsMine(32) and 
       (TArmies(32)>1) ) then
        Begin
        //If UBufferGet(15) then //umessage('All armies passed from China to Siam');
        FromTerritory:=32;
        ToTerritory:=31;
        Armies:=TArmies(32)-1;
        end;
       
    //If China is heavy on Siam try pass all India armies
    If ( TIsMine(31) and 
       (TIsMine(32)=False) and 
       (TArmies(32)>TArmies(31)) and 
        TIsMine(30) and 
       (TArmies(30)>1) ) then
        Begin
        //If UBufferGet(15) then //umessage('All armies passed from India to Siam');
        FromTerritory:=30;
        ToTerritory:=31;
        Armies:=TArmies(30)-1;
        end;
        
      If ((FromTerritory=29) and 
          (ToTerritory=27) and 
          ((TArmies(29)<TArmies(27)) or (TArmies(29)<6)) ) then Armies:=1;
      
 

 //Lame pass
If TIsMine(32) then 
If TIsMine(31) then
if UBufferGet(9)=0 then
If COwner(6)=PMe then
If (TArmies(31)+TArmies(32)>72-PTerritoriesCount(trunc(UBufferGet(36)))) or (UBufferGet(9)<>0) then
If (NOT TIsMine(33)) and (NOT TIsMine(37)) and (NOT TIsMine(1)) then
If (UBufferGet(10)<0) or ((PTerritoriesCount(COwner(1))>22) and (COwner(1)<>PMe)) then

Begin
CAnalysis(1,PT,PA,ET,EA);
If ((COwner(1)<>0) and (trunc(UBufferGet(36))=COwner(1))) and (PArmiesCount(COwner(1))>60) 
then B:=10+3*trunc(UBufferGet(39)) else B:=36+3*trunc(UBufferGet(39));
If (PTerritoriesCount(COwner(1))>25) then B:=0;
W:=0;
If TOwner(20)=-(trunc(UBufferGet(10))) then W:=TArmies(20)-5;
If TOwner(10)=-(trunc(UBufferGet(10))) then W:=TArmies(10)-5;


if (double(TArmies(32))+TArmies(33)+TArmies(37)<(double(TArmies(31)) / 3)) or ((COwner(1)<>0) and (trunc(UBufferGet(36))=COwner(1))) then
 If (TArmies(32)+TArmies(33)+TArmies(37)+TArmies(10)+TArmies(20)+EA+B-W)<TArmies(31) then 
Begin
If (UBufferGet(10)<0) then T:=1 else T:=6;
If TIsMine(32) then ToTerritory:=32;
If TIsMine(31) then FromTerritory:=31;
Armies:=TArmies(FromTerritory)-T;
UBufferSet(9, 33);
UBufferSet(25, 0); //Frank is not in Bubble Mode
If PArmiesCount(-(trunc(UBufferGet(10))))>35 then UBufferSet(8, -1); //Stop one round
//umessage('lame pass');
end;
end;


//#######Aust. - S.A. lame pass  
If TIsMine(31) then
//If COwner(6)=PMe then
If (TArmies(31)>50) then
If TIsMine(30) and (NOT TIsMine(27)) and (NOT TIsMine(26)) then
If ((COwner(4)=COwner(3)) and ((COwner(2)=COwner(1)) or (COwner(2)=COwner(3))) and (COwner(2)<>PMe) and (COwner(2)<>0) and (COwner(2)<>PMe)) then
If PTerritoriesCount(COwner(2))>20 then 
If UBufferGet(9)<>32 then
Begin
CAnalysis(2,PT,PA,ET,EA);
If PTerritoriesCount(COwner(2))>26 then T:=7 else T:=20;
If TArmies(30)+TArmies(27)+TArmies(26)+TArmies(14)+EA<TArmies(30)+TArmies(31)-T-3*trunc(UBufferGet(39)) then
Begin
ToTerritory:=30;
FromTerritory:=31;
Armies:=TArmies(31)-1;
UBufferSet(9, 27);
UBufferSet(25, 0);
UBufferSet(8, 0);
end;
end;

if fromterritory > 0 then if not tismine(toterritory) then umessage('before bubble fortify');

//#############Bubble FORTIFY
 If UBufferGet(25)=1 then
 BEGIN
    If TIsBordering(-(trunc(UBufferGet(17))), trunc(UBufferGet(20))) and TIsMine(-(trunc(UBufferGet(17)))) and TIsMine(trunc(UBufferGet(20))) then
    Begin 
      FromTerritory:=-(trunc(UBufferGet(17)));
      ToTerritory:=trunc(UBufferGet(20));
      Armies:=TArmies(FromTerritory)-1;
  //umessage('FromTerritory', FromTerritory, ToTerritory, Armies, 'UBufferGet(17) ' , UBufferGet(17));
      UBufferSet(17, 0);
    end
  else

begin //Bubble
  If NOT ( ((COwner(2)=PMe) and (TContinent(ToTerritory)=2)) or 
           ((COwner(6)=PMe) and (TContinent(ToTerritory)=6) and (NOT SConquest)) ) then FromTerritory:=0;

  If (UBufferGet(24)=1) then W:=1 else W:=27;
  
  If (SConquest=False) then
   For T:=W to 38 do
    Begin
    if T=31 then
     If TIsMine(31) and (COwner(6)=PMe) then T:=32;
     
    If (TIsBordering(T, trunc(UBufferGet(20))) and TIsMine(T) and (TIsFront(T) or ((NOT TIsFront(T)) and (TArmies(trunc(UBufferGet(20)))<4))) ) then 
     Begin
      FromTerritory:=trunc(UBufferGet(20));
      ToTerritory:=T;
      If TIsBordering(FromTerritory,33) and TIsFront(33) and TIsMine(33) and (TArmies(ToTerritory)=1) then ToTerritory:=33;
      Armies:=TArmies(trunc(UBufferGet(20)))-1;
      T:=42;
      UBufferSet(20,ToTerritory);
      
     end;
    end;
    
  If (SConquest=True) then
   For T:=1 to 38 do
   if TIsMine(T) then
    if TArmies(T)>1 then
    If TIsBordering(T, trunc(UBufferGet(20))) and ((T<>31) or ((T=31) and (COwner(6)<>PMe))) and TIsMine(trunc(UBufferGet(20))) then
     Begin
      FromTerritory:=T;
      ToTerritory:=trunc(UBufferGet(20));
      Armies:=TArmies(T)-1;
      T:=38;
     end;
 
 If (COwner(2)=PMe) and ((ToTerritory=10) or (ToTerritory=12)) then FromTerritory:=0;
     
end;//Bubble
END;
if fromterritory > 0 then if not tismine(toterritory) then umessage('after bubble fortify');
If (UBufferGet(9)<>0) and (FromTerritory=32) then FromTerritory:=0;

//Lame bubble pass
If (UBufferGet(8)>0) then
If (UBufferGet(8)<>31) then
if TIsMine(31) and TIsMine(trunc(UBufferGet(8))) then
Begin
CAnalysis(5,PT,PA,ET,EA);
If PT<8 then
Begin
FromTerritory:=trunc(UBufferGet(8));
ToTerritory:=31;
Armies:=TArmies(trunc(UBufferGet(8)))-1;
end;
UBufferSet(8,0);
//umessage('lame return');
end;

 //Armies from North Africa
If (FromTerritory=0) or (Armies=0) then
 If TIsMine(14) then
 If TArmies(14)>1 then
 If UBufferGet(20)<>14 then
 Begin
  CAnalysis(4,PT,PA,ET,EA);
  If (COwner(2)=PMe) and (PT=1) then // and (TArmies(14)=3)
     Begin
     FromTerritory:=14;
     ToTerritory:=12;
     Armies:=TArmies(FromTerritory)-1;
     end;
 end;

 UBufferSet(7,0);
 
//Bug Control
If TArmies(FromTerritory)<=Armies then Armies:=TArmies(FromTerritory)-1;
If Armies<=0 then FromTerritory:=0;

end;
 
begin
  //UDialogOn;
  //ULogOn;
  //UMessageOn;
end.
